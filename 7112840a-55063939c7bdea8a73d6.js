/*! For license information please see 7112840a-55063939c7bdea8a73d6.js.LICENSE.txt */
"use strict";(self.webpackChunkbugoverdose=self.webpackChunkbugoverdose||[]).push([[16],{2040:function(e,t,n){n.d(t,{$q:function(){return $c},AK:function(){return Gl},Ab:function(){return Wl},B$:function(){return Js},Bt:function(){return zl},Cf:function(){return Bs},EK:function(){return ee},ET:function(){return Pl},Eo:function(){return $s},F8:function(){return bc},Fc:function(){return fc},GL:function(){return Ul},IO:function(){return al},IX:function(){return ic},Ix:function(){return dc},JU:function(){return Xs},Jj:function(){return kc},K9:function(){return M},Ky:function(){return xe},L$:function(){return pc},Lx:function(){return ml},Lz:function(){return gc},Me:function(){return le},Mx:function(){return hc},PL:function(){return Cl},PU:function(){return Sl},Pb:function(){return yc},QT:function(){return _l},ST:function(){return sc},TF:function(){return vc},TQ:function(){return yl},UQ:function(){return Rl},Ub:function(){return _},W:function(){return el},WA:function(){return P},Wi:function(){return Ps},Wu:function(){return gl},Xb:function(){return se},Xk:function(){return Zl},Xo:function(){return cl},ar:function(){return ol},at:function(){return zs},b9:function(){return fl},cf:function(){return Vl},e0:function(){return vl},fH:function(){return cc},hJ:function(){return Ys},i3:function(){return jl},iE:function(){return ec},kl:function(){return Dl},l7:function(){return Ms},my:function(){return Qs},nP:function(){return Hl},oe:function(){return Ol},pl:function(){return Ml},qK:function(){return nl},qY:function(){return uc},r7:function(){return Fl},sc:function(){return ql},u7:function(){return Il},vh:function(){return hl},vr:function(){return Ql},xU:function(){return Xc},yq:function(){return Z},zN:function(){return Ll}});var r=n(2826),i=n(1752),a=n(885),u=n(5861),o=n(136),s=n(2963),c=n(1120),l=n(2982),f=n(5671),h=n(3144),d=n(4687),v=n.n(d),y=n(7626),p=n(1215),m=n(2212),g=n(1584),k=n(1337);function w(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return b(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return b(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){o=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(o)throw a}}}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function x(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,s.Z)(this,n)}}var I="@firebase/firestore",T=function(){function e(t){(0,f.Z)(this,e),this.uid=t}return(0,h.Z)(e,[{key:"isAuthenticated",value:function(){return null!=this.uid}},{key:"toKey",value:function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}},{key:"isEqual",value:function(e){return e.uid===this.uid}}]),e}();T.UNAUTHENTICATED=new T(null),T.GOOGLE_CREDENTIALS=new T("google-credentials-uid"),T.FIRST_PARTY=new T("first-party-uid"),T.MOCK_USER=new T("mock-user");var E="9.6.3",S=new m.Yd("@firebase/firestore");function A(){return S.logLevel}function _(e){S.setLogLevel(e)}function N(e){if(S.logLevel<=m.in.DEBUG){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(C);S.debug.apply(S,["Firestore (".concat(E,"): ").concat(e)].concat((0,l.Z)(i)))}}function D(e){if(S.logLevel<=m.in.ERROR){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(C);S.error.apply(S,["Firestore (".concat(E,"): ").concat(e)].concat((0,l.Z)(i)))}}function Z(e){if(S.logLevel<=m.in.WARN){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(C);S.warn.apply(S,["Firestore (".concat(E,"): ").concat(e)].concat((0,l.Z)(i)))}}function C(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected state",t="FIRESTORE (".concat(E,") INTERNAL ASSERTION FAILED: ")+e;throw D(t),new Error(t)}function L(e,t){e||R()}function M(e,t){e||R()}function F(e,t){return e}var O={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},P=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e,r)).code=e,i.message=r,i.toString=function(){return"".concat(i.name,": [code=").concat(i.code,"]: ").concat(i.message)},i}return(0,h.Z)(n)}(g.ZR),V=(0,h.Z)((function e(){var t=this;(0,f.Z)(this,e),this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))})),q=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.user=n,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer ".concat(t))})),U=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,[{key:"getToken",value:function(){return Promise.resolve(null)}},{key:"invalidateToken",value:function(){}},{key:"start",value:function(e,t){e.enqueueRetryable((function(){return t(T.UNAUTHENTICATED)}))}},{key:"shutdown",value:function(){}}]),e}(),B=function(){function e(t){(0,f.Z)(this,e),this.token=t,this.changeListener=null}return(0,h.Z)(e,[{key:"getToken",value:function(){return Promise.resolve(this.token)}},{key:"invalidateToken",value:function(){}},{key:"start",value:function(e,t){var n=this;this.changeListener=t,e.enqueueRetryable((function(){return t(n.token.user)}))}},{key:"shutdown",value:function(){this.changeListener=null}}]),e}(),K=function(){function e(t){(0,f.Z)(this,e),this.t=t,this.currentUser=T.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}return(0,h.Z)(e,[{key:"start",value:function(e,t){var n=this,r=this.i,i=function(e){return n.i!==r?(r=n.i,t(e)):Promise.resolve()},a=new V;this.o=function(){n.i++,n.currentUser=n.u(),a.resolve(),a=new V,e.enqueueRetryable((function(){return i(n.currentUser)}))};var o=function(){var t=a;e.enqueueRetryable((0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.promise;case 2:return e.next=4,i(n.currentUser);case 4:case"end":return e.stop()}}),e)}))))},s=function(e){N("FirebaseAuthCredentialsProvider","Auth detected"),n.auth=e,n.auth.addAuthTokenListener(n.o),o()};this.t.onInit((function(e){return s(e)})),setTimeout((function(){if(!n.auth){var e=n.t.getImmediate({optional:!0});e?s(e):(N("FirebaseAuthCredentialsProvider","Auth not yet detected"),a.resolve(),a=new V)}}),0),o()}},{key:"getToken",value:function(){var e=this,t=this.i,n=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(n).then((function(n){return e.i!==t?(N("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),e.getToken()):n?(L("string"==typeof n.accessToken),new q(n.accessToken,e.currentUser)):null})):Promise.resolve(null)}},{key:"invalidateToken",value:function(){this.forceRefresh=!0}},{key:"shutdown",value:function(){this.auth&&this.auth.removeAuthTokenListener(this.o)}},{key:"u",value:function(){var e=this.auth&&this.auth.getUid();return L(null===e||"string"==typeof e),new T(e)}}]),e}(),j=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.type="FirstParty",this.user=T.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",n);var i=t.auth.getAuthHeaderValueForFirstParty([]);i&&this.headers.set("Authorization",i),r&&this.headers.set("X-Goog-Iam-Authorization-Token",r)})),G=function(){function e(t,n,r){(0,f.Z)(this,e),this.h=t,this.l=n,this.m=r}return(0,h.Z)(e,[{key:"getToken",value:function(){return Promise.resolve(new j(this.h,this.l,this.m))}},{key:"start",value:function(e,t){e.enqueueRetryable((function(){return t(T.FIRST_PARTY)}))}},{key:"shutdown",value:function(){}},{key:"invalidateToken",value:function(){}}]),e}(),z=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)})),Q=function(){function e(t){(0,f.Z)(this,e),this.g=t,this.forceRefresh=!1,this.appCheck=null}return(0,h.Z)(e,[{key:"start",value:function(e,t){var n=this;this.o=function(n){e.enqueueRetryable((function(){return function(e){return null!=e.error&&N("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: ".concat(e.error.message)),t(e.token)}(n)}))};var r=function(e){N("FirebaseAppCheckTokenProvider","AppCheck detected"),n.appCheck=e,n.appCheck.addTokenListener(n.o)};this.g.onInit((function(e){return r(e)})),setTimeout((function(){if(!n.appCheck){var e=n.g.getImmediate({optional:!0});e?r(e):N("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}},{key:"getToken",value:function(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((function(e){return e?(L("string"==typeof e.token),new z(e.token)):null})):Promise.resolve(null)}},{key:"invalidateToken",value:function(){this.forceRefresh=!0}},{key:"shutdown",value:function(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}]),e}(),W=function(){function e(t,n){var r=this;(0,f.Z)(this,e),this.previousValue=t,n&&(n.sequenceNumberHandler=function(e){return r.p(e)},this.T=function(e){return n.writeSequenceNumber(e)})}return(0,h.Z)(e,[{key:"p",value:function(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}},{key:"next",value:function(){var e=++this.previousValue;return this.T&&this.T(e),e}}]),e}();function H(e){var t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(var r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}W.I=-1;var Y=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,null,[{key:"A",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,n="";n.length<20;)for(var r=H(40),i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length));return n}}]),e}();function J(e,t){return e<t?-1:e>t?1:0}function X(e,t,n){return e.length===t.length&&e.every((function(e,r){return n(e,t[r])}))}function $(e){return e+"\0"}var ee=function(){function e(t,n){if((0,f.Z)(this,e),this.seconds=t,this.nanoseconds=n,n<0)throw new P(O.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(n>=1e9)throw new P(O.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(t<-62135596800)throw new P(O.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new P(O.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return(0,h.Z)(e,[{key:"toDate",value:function(){return new Date(this.toMillis())}},{key:"toMillis",value:function(){return 1e3*this.seconds+this.nanoseconds/1e6}},{key:"_compareTo",value:function(e){return this.seconds===e.seconds?J(this.nanoseconds,e.nanoseconds):J(this.seconds,e.seconds)}},{key:"isEqual",value:function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}},{key:"toString",value:function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}},{key:"toJSON",value:function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}},{key:"valueOf",value:function(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}],[{key:"now",value:function(){return e.fromMillis(Date.now())}},{key:"fromDate",value:function(t){return e.fromMillis(t.getTime())}},{key:"fromMillis",value:function(t){var n=Math.floor(t/1e3);return new e(n,Math.floor(1e6*(t-1e3*n)))}}]),e}(),te=function(){function e(t){(0,f.Z)(this,e),this.timestamp=t}return(0,h.Z)(e,[{key:"compareTo",value:function(e){return this.timestamp._compareTo(e.timestamp)}},{key:"isEqual",value:function(e){return this.timestamp.isEqual(e.timestamp)}},{key:"toMicroseconds",value:function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}},{key:"toString",value:function(){return"SnapshotVersion("+this.timestamp.toString()+")"}},{key:"toTimestamp",value:function(){return this.timestamp}}],[{key:"fromTimestamp",value:function(t){return new e(t)}},{key:"min",value:function(){return new e(new ee(0,0))}}]),e}();function ne(e){var t=0;for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function re(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ie(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}var ae=function(){function e(t,n,r){(0,f.Z)(this,e),void 0===n?n=0:n>t.length&&R(),void 0===r?r=t.length-n:r>t.length-n&&R(),this.segments=t,this.offset=n,this.len=r}return(0,h.Z)(e,[{key:"length",get:function(){return this.len}},{key:"isEqual",value:function(t){return 0===e.comparator(this,t)}},{key:"child",value:function(t){var n=this.segments.slice(this.offset,this.limit());return t instanceof e?t.forEach((function(e){n.push(e)})):n.push(t),this.construct(n)}},{key:"limit",value:function(){return this.offset+this.length}},{key:"popFirst",value:function(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}},{key:"popLast",value:function(){return this.construct(this.segments,this.offset,this.length-1)}},{key:"firstSegment",value:function(){return this.segments[this.offset]}},{key:"lastSegment",value:function(){return this.get(this.length-1)}},{key:"get",value:function(e){return this.segments[this.offset+e]}},{key:"isEmpty",value:function(){return 0===this.length}},{key:"isPrefixOf",value:function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}},{key:"isImmediateParentOf",value:function(e){if(this.length+1!==e.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}},{key:"forEach",value:function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}},{key:"toArray",value:function(){return this.segments.slice(this.offset,this.limit())}}],[{key:"comparator",value:function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=e.get(r),a=t.get(r);if(i<a)return-1;if(i>a)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}]),e}(),ue=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"construct",value:function(e,t,r){return new n(e,t,r)}},{key:"canonicalString",value:function(){return this.toArray().join("/")}},{key:"toString",value:function(){return this.canonicalString()}}],[{key:"fromString",value:function(){for(var e=[],t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];for(var a=0,u=r;a<u.length;a++){var o=u[a];if(o.indexOf("//")>=0)throw new P(O.INVALID_ARGUMENT,"Invalid segment (".concat(o,"). Paths must not contain // in them."));e.push.apply(e,(0,l.Z)(o.split("/").filter((function(e){return e.length>0}))))}return new n(e)}},{key:"emptyPath",value:function(){return new n([])}}]),n}(ae),oe=/^[_a-zA-Z][_a-zA-Z0-9]*$/,se=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"construct",value:function(e,t,r){return new n(e,t,r)}},{key:"canonicalString",value:function(){return this.toArray().map((function(e){return e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e})).join(".")}},{key:"toString",value:function(){return this.canonicalString()}},{key:"isKeyField",value:function(){return 1===this.length&&"__name__"===this.get(0)}}],[{key:"isValidIdentifier",value:function(e){return oe.test(e)}},{key:"keyField",value:function(){return new n(["__name__"])}},{key:"fromServerFormat",value:function(e){for(var t=[],r="",i=0,a=function(){if(0===r.length)throw new P(O.INVALID_ARGUMENT,"Invalid field path (".concat(e,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"));t.push(r),r=""},u=!1;i<e.length;){var o=e[i];if("\\"===o){if(i+1===e.length)throw new P(O.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var s=e[i+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new P(O.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=s,i+=2}else"`"===o?(u=!u,i++):"."!==o||u?(r+=o,i++):(a(),i++)}if(a(),u)throw new P(O.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}},{key:"emptyPath",value:function(){return new n([])}}]),n}(ae),ce=function(){function e(t){(0,f.Z)(this,e),this.fields=t,t.sort(se.comparator)}return(0,h.Z)(e,[{key:"covers",value:function(e){var t,n=w(this.fields);try{for(n.s();!(t=n.n()).done;){if(t.value.isPrefixOf(e))return!0}}catch(r){n.e(r)}finally{n.f()}return!1}},{key:"isEqual",value:function(e){return X(this.fields,e.fields,(function(e,t){return e.isEqual(t)}))}}]),e}();function le(){return"undefined"!=typeof atob}var fe=function(e){function t(e){(0,f.Z)(this,t),this.binaryString=e}return(0,h.Z)(t,[{key:e,value:function(){var e=this,t=0;return{next:function(){return t<e.binaryString.length?{value:e.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}}},{key:"toBase64",value:function(){return e=this.binaryString,btoa(e);var e}},{key:"toUint8Array",value:function(){return function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}},{key:"approximateByteSize",value:function(){return 2*this.binaryString.length}},{key:"compareTo",value:function(e){return J(this.binaryString,e.binaryString)}},{key:"isEqual",value:function(e){return this.binaryString===e.binaryString}}],[{key:"fromBase64String",value:function(e){return new t(atob(e))}},{key:"fromUint8Array",value:function(e){var n=function(e){for(var t="",n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new t(n)}}]),t}(Symbol.iterator);fe.EMPTY_BYTE_STRING=new fe("");var he=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function de(e){if(L(!!e),"string"==typeof e){var t=0,n=he.exec(e);if(L(!!n),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),t=Number(r)}var i=new Date(e);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:ve(e.seconds),nanos:ve(e.nanos)}}function ve(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ye(e){return"string"==typeof e?fe.fromBase64String(e):fe.fromUint8Array(e)}function pe(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function me(e){var t=e.mapValue.fields.__previous_value__;return pe(t)?me(t):t}function ge(e){var t=de(e.mapValue.fields.__local_write_time__.timestampValue);return new ee(t.seconds,t.nanos)}function ke(e){return null==e}function we(e){return 0===e&&1/e==-1/0}function be(e){return"number"==typeof e&&Number.isInteger(e)&&!we(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}var xe=function(){function e(t){(0,f.Z)(this,e),this.path=t}return(0,h.Z)(e,[{key:"hasCollectionId",value:function(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}},{key:"isEqual",value:function(e){return null!==e&&0===ue.comparator(this.path,e.path)}},{key:"toString",value:function(){return this.path.toString()}}],[{key:"fromPath",value:function(t){return new e(ue.fromString(t))}},{key:"fromName",value:function(t){return new e(ue.fromString(t).popFirst(5))}},{key:"comparator",value:function(e,t){return ue.comparator(e.path,t.path)}},{key:"isDocumentKey",value:function(e){return e.length%2==0}},{key:"fromSegments",value:function(t){return new e(new ue(t.slice()))}}]),e}();function Ie(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?pe(e)?4:10:R()}function Te(e,t){if(e===t)return!0;var n=Ie(e);if(n!==Ie(t))return!1;switch(n){case 0:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return ge(e).isEqual(ge(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=de(e.timestampValue),r=de(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return ye(e.bytesValue).isEqual(ye(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ve(e.geoPointValue.latitude)===ve(t.geoPointValue.latitude)&&ve(e.geoPointValue.longitude)===ve(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ve(e.integerValue)===ve(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=ve(e.doubleValue),r=ve(t.doubleValue);return n===r?we(n)===we(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return X(e.arrayValue.values||[],t.arrayValue.values||[],Te);case 10:return function(e,t){var n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(ne(n)!==ne(r))return!1;for(var i in n)if(n.hasOwnProperty(i)&&(void 0===r[i]||!Te(n[i],r[i])))return!1;return!0}(e,t);default:return R()}}function Ee(e,t){return void 0!==(e.values||[]).find((function(e){return Te(e,t)}))}function Se(e,t){if(e===t)return 0;var n=Ie(e),r=Ie(t);if(n!==r)return J(n,r);switch(n){case 0:return 0;case 1:return J(e.booleanValue,t.booleanValue);case 2:return function(e,t){var n=ve(e.integerValue||e.doubleValue),r=ve(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Ae(e.timestampValue,t.timestampValue);case 4:return Ae(ge(e),ge(t));case 5:return J(e.stringValue,t.stringValue);case 6:return function(e,t){var n=ye(e),r=ye(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){for(var n=e.split("/"),r=t.split("/"),i=0;i<n.length&&i<r.length;i++){var a=J(n[i],r[i]);if(0!==a)return a}return J(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){var n=J(ve(e.latitude),ve(t.latitude));return 0!==n?n:J(ve(e.longitude),ve(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){for(var n=e.values||[],r=t.values||[],i=0;i<n.length&&i<r.length;++i){var a=Se(n[i],r[i]);if(a)return a}return J(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n=e.fields||{},r=Object.keys(n),i=t.fields||{},a=Object.keys(i);r.sort(),a.sort();for(var u=0;u<r.length&&u<a.length;++u){var o=J(r[u],a[u]);if(0!==o)return o;var s=Se(n[r[u]],i[a[u]]);if(0!==s)return s}return J(r.length,a.length)}(e.mapValue,t.mapValue);default:throw R()}}function Ae(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return J(e,t);var n=de(e),r=de(t),i=J(n.seconds,r.seconds);return 0!==i?i:J(n.nanos,r.nanos)}function _e(e){return Ne(e)}function Ne(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){var t=de(e);return"time(".concat(t.seconds,",").concat(t.nanos,")")}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?ye(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,xe.fromName(n).toString()):"geoPointValue"in e?"geo(".concat((t=e.geoPointValue).latitude,",").concat(t.longitude,")"):"arrayValue"in e?function(e){var t,n="[",r=!0,i=w(e.values||[]);try{for(i.s();!(t=i.n()).done;){var a=t.value;r?r=!1:n+=",",n+=Ne(a)}}catch(u){i.e(u)}finally{i.f()}return n+"]"}(e.arrayValue):"mapValue"in e?function(e){var t,n="{",r=!0,i=w(Object.keys(e.fields||{}).sort());try{for(i.s();!(t=i.n()).done;){var a=t.value;r?r=!1:n+=",",n+="".concat(a,":").concat(Ne(e.fields[a]))}}catch(u){i.e(u)}finally{i.f()}return n+"}"}(e.mapValue):R();var t,n}function De(e,t){return{referenceValue:"projects/".concat(e.projectId,"/databases/").concat(e.database,"/documents/").concat(t.path.canonicalString())}}function Ze(e){return!!e&&"integerValue"in e}function Ce(e){return!!e&&"arrayValue"in e}function Re(e){return!!e&&"nullValue"in e}function Le(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Me(e){return!!e&&"mapValue"in e}function Fe(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){var t={mapValue:{fields:{}}};return re(e.mapValue.fields,(function(e,n){return t.mapValue.fields[e]=Fe(n)})),t}if(e.arrayValue){for(var n={arrayValue:{values:[]}},r=0;r<(e.arrayValue.values||[]).length;++r)n.arrayValue.values[r]=Fe(e.arrayValue.values[r]);return n}return Object.assign({},e)}var Oe=function(){function e(t){(0,f.Z)(this,e),this.value=t}return(0,h.Z)(e,[{key:"field",value:function(e){if(e.isEmpty())return this.value;for(var t=this.value,n=0;n<e.length-1;++n)if(!Me(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}},{key:"set",value:function(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Fe(t)}},{key:"setAll",value:function(e){var t=this,n=se.emptyPath(),r={},i=[];e.forEach((function(e,a){if(!n.isImmediateParentOf(a)){var u=t.getFieldsMap(n);t.applyChanges(u,r,i),r={},i=[],n=a.popLast()}e?r[a.lastSegment()]=Fe(e):i.push(a.lastSegment())}));var a=this.getFieldsMap(n);this.applyChanges(a,r,i)}},{key:"delete",value:function(e){var t=this.field(e.popLast());Me(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}},{key:"isEqual",value:function(e){return Te(this.value,e.value)}},{key:"getFieldsMap",value:function(e){var t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(var n=0;n<e.length;++n){var r=t.mapValue.fields[e.get(n)];Me(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}},{key:"applyChanges",value:function(e,t,n){re(t,(function(t,n){return e[t]=n}));var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;delete e[a]}}catch(u){i.e(u)}finally{i.f()}}},{key:"clone",value:function(){return new e(Fe(this.value))}}],[{key:"empty",value:function(){return new e({mapValue:{}})}}]),e}();function Pe(e){var t=[];return re(e.fields,(function(e,n){var r=new se([e]);if(Me(n)){var i=Pe(n.mapValue).fields;if(0===i.length)t.push(r);else{var a,u=w(i);try{for(u.s();!(a=u.n()).done;){var o=a.value;t.push(r.child(o))}}catch(s){u.e(s)}finally{u.f()}}}else t.push(r)})),new ce(t)}var Ve=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.key=t,this.documentType=n,this.version=r,this.data=i,this.documentState=a}return(0,h.Z)(e,[{key:"convertToFoundDocument",value:function(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}},{key:"convertToNoDocument",value:function(e){return this.version=e,this.documentType=2,this.data=Oe.empty(),this.documentState=0,this}},{key:"convertToUnknownDocument",value:function(e){return this.version=e,this.documentType=3,this.data=Oe.empty(),this.documentState=2,this}},{key:"setHasCommittedMutations",value:function(){return this.documentState=2,this}},{key:"setHasLocalMutations",value:function(){return this.documentState=1,this}},{key:"hasLocalMutations",get:function(){return 1===this.documentState}},{key:"hasCommittedMutations",get:function(){return 2===this.documentState}},{key:"hasPendingWrites",get:function(){return this.hasLocalMutations||this.hasCommittedMutations}},{key:"isValidDocument",value:function(){return 0!==this.documentType}},{key:"isFoundDocument",value:function(){return 1===this.documentType}},{key:"isNoDocument",value:function(){return 2===this.documentType}},{key:"isUnknownDocument",value:function(){return 3===this.documentType}},{key:"isEqual",value:function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}},{key:"mutableCopy",value:function(){return new e(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}},{key:"toString",value:function(){return"Document(".concat(this.key,", ").concat(this.version,", ").concat(JSON.stringify(this.data.value),", {documentType: ").concat(this.documentType,"}), {documentState: ").concat(this.documentState,"})")}}],[{key:"newInvalidDocument",value:function(t){return new e(t,0,te.min(),Oe.empty(),0)}},{key:"newFoundDocument",value:function(t,n,r){return new e(t,1,n,r,0)}},{key:"newNoDocument",value:function(t,n){return new e(t,2,n,Oe.empty(),0)}},{key:"newUnknownDocument",value:function(t,n){return new e(t,3,n,Oe.empty(),2)}}]),e}(),qe=(0,h.Z)((function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;(0,f.Z)(this,e),this.path=t,this.collectionGroup=n,this.orderBy=r,this.filters=i,this.limit=a,this.startAt=u,this.endAt=o,this.R=null}));function Ue(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;return new qe(e,t,n,r,i,a,u)}function Be(e){var t=F(e);if(null===t.R){var n=t.path.canonicalString();null!==t.collectionGroup&&(n+="|cg:"+t.collectionGroup),n+="|f:",n+=t.filters.map((function(e){return function(e){return e.field.canonicalString()+e.op.toString()+_e(e.value)}(e)})).join(","),n+="|ob:",n+=t.orderBy.map((function(e){return function(e){return e.field.canonicalString()+e.dir}(e)})).join(","),ke(t.limit)||(n+="|l:",n+=t.limit),t.startAt&&(n+="|lb:",n+=tt(t.startAt)),t.endAt&&(n+="|ub:",n+=tt(t.endAt)),t.R=n}return t.R}function Ke(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(var n=0;n<e.orderBy.length;n++)if(!rt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(var r=0;r<e.filters.length;r++)if(i=e.filters[r],a=t.filters[r],i.op!==a.op||!i.field.isEqual(a.field)||!Te(i.value,a.value))return!1;var i,a;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!at(e.startAt,t.startAt)&&at(e.endAt,t.endAt)}function je(e){return xe.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}var Ge=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this)).field=e,a.op=r,a.value=i,a}return(0,h.Z)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.v(Se(t,this.value)):null!==t&&Ie(this.value)===Ie(t)&&this.v(Se(t,this.value))}},{key:"v",value:function(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return R()}}},{key:"V",value:function(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}],[{key:"create",value:function(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.P(e,t,r):new ze(e,t,r):"array-contains"===t?new Ye(e,r):"in"===t?new Je(e,r):"not-in"===t?new Xe(e,r):"array-contains-any"===t?new $e(e,r):new n(e,t,r)}},{key:"P",value:function(e,t,n){return"in"===t?new Qe(e,n):new We(e,n)}}]),n}(function(){return(0,h.Z)((function e(){(0,f.Z)(this,e)}))}());var ze=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this,e,r,i)).key=xe.fromName(i.referenceValue),a}return(0,h.Z)(n,[{key:"matches",value:function(e){var t=xe.comparator(e.key,this.key);return this.v(t)}}]),n}(Ge),Qe=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e,"in",r)).keys=He("in",r),i}return(0,h.Z)(n,[{key:"matches",value:function(e){return this.keys.some((function(t){return t.isEqual(e.key)}))}}]),n}(Ge),We=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e,"not-in",r)).keys=He("not-in",r),i}return(0,h.Z)(n,[{key:"matches",value:function(e){return!this.keys.some((function(t){return t.isEqual(e.key)}))}}]),n}(Ge);function He(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((function(e){return xe.fromName(e.referenceValue)}))}var Ye=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){return(0,f.Z)(this,n),t.call(this,e,"array-contains",r)}return(0,h.Z)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return Ce(t)&&Ee(t.arrayValue,this.value)}}]),n}(Ge),Je=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){return(0,f.Z)(this,n),t.call(this,e,"in",r)}return(0,h.Z)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return null!==t&&Ee(this.value.arrayValue,t)}}]),n}(Ge),Xe=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){return(0,f.Z)(this,n),t.call(this,e,"not-in",r)}return(0,h.Z)(n,[{key:"matches",value:function(e){if(Ee(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Ee(this.value.arrayValue,t)}}]),n}(Ge),$e=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){return(0,f.Z)(this,n),t.call(this,e,"array-contains-any",r)}return(0,h.Z)(n,[{key:"matches",value:function(e){var t=this,n=e.data.field(this.field);return!(!Ce(n)||!n.arrayValue.values)&&n.arrayValue.values.some((function(e){return Ee(t.value.arrayValue,e)}))}}]),n}(Ge),et=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.position=t,this.before=n}));function tt(e){return"".concat(e.before?"b":"a",":").concat(e.position.map((function(e){return _e(e)})).join(","))}var nt=(0,h.Z)((function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc";(0,f.Z)(this,e),this.field=t,this.dir=n}));function rt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function it(e,t,n){for(var r=0,i=0;i<e.position.length;i++){var a=t[i],u=e.position[i];if(r=a.field.isKeyField()?xe.comparator(xe.fromName(u.referenceValue),n.key):Se(u,n.data.field(a.field)),"desc"===a.dir&&(r*=-1),0!==r)break}return e.before?r<=0:r<0}function at(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.before!==t.before||e.position.length!==t.position.length)return!1;for(var n=0;n<e.position.length;n++)if(!Te(e.position[n],t.position[n]))return!1;return!0}var ut=(0,h.Z)((function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"F",o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;(0,f.Z)(this,e),this.path=t,this.collectionGroup=n,this.explicitOrderBy=r,this.filters=i,this.limit=a,this.limitType=u,this.startAt=o,this.endAt=s,this.S=null,this.D=null,this.startAt,this.endAt}));function ot(e,t,n,r,i,a,u,o){return new ut(e,t,n,r,i,a,u,o)}function st(e){return new ut(e)}function ct(e){return!ke(e.limit)&&"F"===e.limitType}function lt(e){return!ke(e.limit)&&"L"===e.limitType}function ft(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function ht(e){var t,n=w(e.filters);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.V())return r.field}}catch(i){n.e(i)}finally{n.f()}return null}function dt(e){return null!==e.collectionGroup}function vt(e){var t=F(e);if(null===t.S){t.S=[];var n=ht(t),r=ft(t);if(null!==n&&null===r)n.isKeyField()||t.S.push(new nt(n)),t.S.push(new nt(se.keyField(),"asc"));else{var i,a=!1,u=w(t.explicitOrderBy);try{for(u.s();!(i=u.n()).done;){var o=i.value;t.S.push(o),o.field.isKeyField()&&(a=!0)}}catch(c){u.e(c)}finally{u.f()}if(!a){var s=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.S.push(new nt(se.keyField(),s))}}}return t.S}function yt(e){var t=F(e);if(!t.D)if("F"===t.limitType)t.D=Ue(t.path,t.collectionGroup,vt(t),t.filters,t.limit,t.startAt,t.endAt);else{var n,r=[],i=w(vt(t));try{for(i.s();!(n=i.n()).done;){var a=n.value,u="desc"===a.dir?"asc":"desc";r.push(new nt(a.field,u))}}catch(c){i.e(c)}finally{i.f()}var o=t.endAt?new et(t.endAt.position,!t.endAt.before):null,s=t.startAt?new et(t.startAt.position,!t.startAt.before):null;t.D=Ue(t.path,t.collectionGroup,r,t.filters,t.limit,o,s)}return t.D}function pt(e,t,n){return new ut(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function mt(e,t){return Ke(yt(e),yt(t))&&e.limitType===t.limitType}function gt(e){return"".concat(Be(yt(e)),"|lt:").concat(e.limitType)}function kt(e){return"Query(target=".concat(function(e){var t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=", filters: [".concat(e.filters.map((function(e){return"".concat((t=e).field.canonicalString()," ").concat(t.op," ").concat(_e(t.value));var t})).join(", "),"]")),ke(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=", orderBy: [".concat(e.orderBy.map((function(e){return function(e){return"".concat(e.field.canonicalString()," (").concat(e.dir,")")}(e)})).join(", "),"]")),e.startAt&&(t+=", startAt: "+tt(e.startAt)),e.endAt&&(t+=", endAt: "+tt(e.endAt)),"Target(".concat(t,")")}(yt(e)),"; limitType=").concat(e.limitType,")")}function wt(e,t){return t.isFoundDocument()&&function(e,t){var n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):xe.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){var n,r=w(e.explicitOrderBy);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(!i.field.isKeyField()&&null===t.data.field(i.field))return!1}}catch(a){r.e(a)}finally{r.f()}return!0}(e,t)&&function(e,t){var n,r=w(e.filters);try{for(r.s();!(n=r.n()).done;){if(!n.value.matches(t))return!1}}catch(i){r.e(i)}finally{r.f()}return!0}(e,t)&&function(e,t){return!(e.startAt&&!it(e.startAt,vt(e),t))&&(!e.endAt||!it(e.endAt,vt(e),t))}(e,t)}function bt(e){return function(t,n){var r,i=!1,a=w(vt(e));try{for(a.s();!(r=a.n()).done;){var u=r.value,o=xt(u,t,n);if(0!==o)return o;i=i||u.field.isKeyField()}}catch(s){a.e(s)}finally{a.f()}return 0}}function xt(e,t,n){var r=e.field.isKeyField()?xe.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Se(r,i):R()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return R()}}function It(e,t){if(e.C){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:we(t)?"-0":t}}function Tt(e){return{integerValue:""+e}}function Et(e,t){return be(t)?Tt(t):It(e,t)}var St=(0,h.Z)((function e(){(0,f.Z)(this,e),this._=void 0}));function At(e,t,n){return e instanceof Dt?function(e,t){var n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof Zt?Ct(e,t):e instanceof Rt?Lt(e,t):function(e,t){var n=Nt(e,t),r=Ft(n)+Ft(e.N);return Ze(n)&&Ze(e.N)?Tt(r):It(e.k,r)}(e,t)}function _t(e,t,n){return e instanceof Zt?Ct(e,t):e instanceof Rt?Lt(e,t):n}function Nt(e,t){return e instanceof Mt?Ze(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}var Dt=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n)}(St),Zt=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).elements=e,r}return(0,h.Z)(n)}(St);function Ct(e,t){var n,r=Ot(t),i=w(e.elements);try{var a=function(){var e=n.value;r.some((function(t){return Te(t,e)}))||r.push(e)};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return{arrayValue:{values:r}}}var Rt=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).elements=e,r}return(0,h.Z)(n)}(St);function Lt(e,t){var n,r=Ot(t),i=w(e.elements);try{var a=function(){var e=n.value;r=r.filter((function(t){return!Te(t,e)}))};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return{arrayValue:{values:r}}}var Mt=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).k=e,i.N=r,i}return(0,h.Z)(n)}(St);function Ft(e){return ve(e.integerValue||e.doubleValue)}function Ot(e){return Ce(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}var Pt=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.field=t,this.transform=n}));var Vt=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.version=t,this.transformResults=n})),qt=function(){function e(t,n){(0,f.Z)(this,e),this.updateTime=t,this.exists=n}return(0,h.Z)(e,[{key:"isNone",get:function(){return void 0===this.updateTime&&void 0===this.exists}},{key:"isEqual",value:function(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}],[{key:"none",value:function(){return new e}},{key:"exists",value:function(t){return new e(void 0,t)}},{key:"updateTime",value:function(t){return new e(t)}}]),e}();function Ut(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}var Bt=(0,h.Z)((function e(){(0,f.Z)(this,e)}));function Kt(e,t,n){e instanceof Wt?function(e,t,n){var r=e.value.clone(),i=Jt(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Ht?function(e,t,n){if(Ut(e.precondition,t)){var r=Jt(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Yt(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}else t.convertToUnknownDocument(n.version)}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function jt(e,t,n){e instanceof Wt?function(e,t,n){if(Ut(e.precondition,t)){var r=e.value.clone(),i=Xt(e.fieldTransforms,n,t);r.setAll(i),t.convertToFoundDocument(Qt(t),r).setHasLocalMutations()}}(e,t,n):e instanceof Ht?function(e,t,n){if(Ut(e.precondition,t)){var r=Xt(e.fieldTransforms,n,t),i=t.data;i.setAll(Yt(e)),i.setAll(r),t.convertToFoundDocument(Qt(t),i).setHasLocalMutations()}}(e,t,n):function(e,t){Ut(e.precondition,t)&&t.convertToNoDocument(te.min())}(e,t)}function Gt(e,t){var n,r=null,i=w(e.fieldTransforms);try{for(i.s();!(n=i.n()).done;){var a=n.value,u=t.data.field(a.field),o=Nt(a.transform,u||null);null!=o&&(null==r&&(r=Oe.empty()),r.set(a.field,o))}}catch(s){i.e(s)}finally{i.f()}return r||null}function zt(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&X(e,t,(function(e,t){return function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof Zt&&t instanceof Zt||e instanceof Rt&&t instanceof Rt?X(e.elements,t.elements,Te):e instanceof Mt&&t instanceof Mt?Te(e.N,t.N):e instanceof Dt&&t instanceof Dt}(e.transform,t.transform)}(e,t)}))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}function Qt(e){return e.isFoundDocument()?e.version:te.min()}var Wt=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return(0,f.Z)(this,n),(a=t.call(this)).key=e,a.value=r,a.precondition=i,a.fieldTransforms=u,a.type=0,a}return(0,h.Z)(n)}(Bt),Ht=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i,a){var u,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];return(0,f.Z)(this,n),(u=t.call(this)).key=e,u.data=r,u.fieldMask=i,u.precondition=a,u.fieldTransforms=o,u.type=1,u}return(0,h.Z)(n)}(Bt);function Yt(e){var t=new Map;return e.fieldMask.fields.forEach((function(n){if(!n.isEmpty()){var r=e.data.field(n);t.set(n,r)}})),t}function Jt(e,t,n){var r=new Map;L(e.length===n.length);for(var i=0;i<n.length;i++){var a=e[i],u=a.transform,o=t.data.field(a.field);r.set(a.field,_t(u,o,n[i]))}return r}function Xt(e,t,n){var r,i=new Map,a=w(e);try{for(a.s();!(r=a.n()).done;){var u=r.value,o=u.transform,s=n.data.field(u.field);i.set(u.field,At(o,s,t))}}catch(c){a.e(c)}finally{a.f()}return i}var $t,en,tn=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).key=e,i.precondition=r,i.type=2,i.fieldTransforms=[],i}return(0,h.Z)(n)}(Bt),nn=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).key=e,i.precondition=r,i.type=3,i.fieldTransforms=[],i}return(0,h.Z)(n)}(Bt),rn=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.count=t}));function an(e){switch(e){default:return R();case O.CANCELLED:case O.UNKNOWN:case O.DEADLINE_EXCEEDED:case O.RESOURCE_EXHAUSTED:case O.INTERNAL:case O.UNAVAILABLE:case O.UNAUTHENTICATED:return!1;case O.INVALID_ARGUMENT:case O.NOT_FOUND:case O.ALREADY_EXISTS:case O.PERMISSION_DENIED:case O.FAILED_PRECONDITION:case O.ABORTED:case O.OUT_OF_RANGE:case O.UNIMPLEMENTED:case O.DATA_LOSS:return!0}}function un(e){if(void 0===e)return D("GRPC error has no .code"),O.UNKNOWN;switch(e){case $t.OK:return O.OK;case $t.CANCELLED:return O.CANCELLED;case $t.UNKNOWN:return O.UNKNOWN;case $t.DEADLINE_EXCEEDED:return O.DEADLINE_EXCEEDED;case $t.RESOURCE_EXHAUSTED:return O.RESOURCE_EXHAUSTED;case $t.INTERNAL:return O.INTERNAL;case $t.UNAVAILABLE:return O.UNAVAILABLE;case $t.UNAUTHENTICATED:return O.UNAUTHENTICATED;case $t.INVALID_ARGUMENT:return O.INVALID_ARGUMENT;case $t.NOT_FOUND:return O.NOT_FOUND;case $t.ALREADY_EXISTS:return O.ALREADY_EXISTS;case $t.PERMISSION_DENIED:return O.PERMISSION_DENIED;case $t.FAILED_PRECONDITION:return O.FAILED_PRECONDITION;case $t.ABORTED:return O.ABORTED;case $t.OUT_OF_RANGE:return O.OUT_OF_RANGE;case $t.UNIMPLEMENTED:return O.UNIMPLEMENTED;case $t.DATA_LOSS:return O.DATA_LOSS;default:return R()}}(en=$t||($t={}))[en.OK=0]="OK",en[en.CANCELLED=1]="CANCELLED",en[en.UNKNOWN=2]="UNKNOWN",en[en.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",en[en.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",en[en.NOT_FOUND=5]="NOT_FOUND",en[en.ALREADY_EXISTS=6]="ALREADY_EXISTS",en[en.PERMISSION_DENIED=7]="PERMISSION_DENIED",en[en.UNAUTHENTICATED=16]="UNAUTHENTICATED",en[en.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",en[en.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",en[en.ABORTED=10]="ABORTED",en[en.OUT_OF_RANGE=11]="OUT_OF_RANGE",en[en.UNIMPLEMENTED=12]="UNIMPLEMENTED",en[en.INTERNAL=13]="INTERNAL",en[en.UNAVAILABLE=14]="UNAVAILABLE",en[en.DATA_LOSS=15]="DATA_LOSS";var on=function(){function e(t,n){(0,f.Z)(this,e),this.comparator=t,this.root=n||cn.EMPTY}return(0,h.Z)(e,[{key:"insert",value:function(t,n){return new e(this.comparator,this.root.insert(t,n,this.comparator).copy(null,null,cn.BLACK,null,null))}},{key:"remove",value:function(t){return new e(this.comparator,this.root.remove(t,this.comparator).copy(null,null,cn.BLACK,null,null))}},{key:"get",value:function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}},{key:"indexOf",value:function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}},{key:"isEmpty",value:function(){return this.root.isEmpty()}},{key:"size",get:function(){return this.root.size}},{key:"minKey",value:function(){return this.root.minKey()}},{key:"maxKey",value:function(){return this.root.maxKey()}},{key:"inorderTraversal",value:function(e){return this.root.inorderTraversal(e)}},{key:"forEach",value:function(e){this.inorderTraversal((function(t,n){return e(t,n),!1}))}},{key:"toString",value:function(){var e=[];return this.inorderTraversal((function(t,n){return e.push("".concat(t,":").concat(n)),!1})),"{".concat(e.join(", "),"}")}},{key:"reverseTraversal",value:function(e){return this.root.reverseTraversal(e)}},{key:"getIterator",value:function(){return new sn(this.root,null,this.comparator,!1)}},{key:"getIteratorFrom",value:function(e){return new sn(this.root,e,this.comparator,!1)}},{key:"getReverseIterator",value:function(){return new sn(this.root,null,this.comparator,!0)}},{key:"getReverseIteratorFrom",value:function(e){return new sn(this.root,e,this.comparator,!0)}}]),e}(),sn=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.isReverse=i,this.nodeStack=[];for(var a=1;!t.isEmpty();)if(a=n?r(t.key,n):1,i&&(a*=-1),a<0)t=this.isReverse?t.left:t.right;else{if(0===a){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return(0,h.Z)(e,[{key:"getNext",value:function(){var e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}},{key:"hasNext",value:function(){return this.nodeStack.length>0}},{key:"peek",value:function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}]),e}(),cn=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=i?i:e.EMPTY,this.right=null!=a?a:e.EMPTY,this.size=this.left.size+1+this.right.size}return(0,h.Z)(e,[{key:"copy",value:function(t,n,r,i,a){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=a?a:this.right)}},{key:"isEmpty",value:function(){return!1}},{key:"inorderTraversal",value:function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}},{key:"reverseTraversal",value:function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}},{key:"min",value:function(){return this.left.isEmpty()?this:this.left.min()}},{key:"minKey",value:function(){return this.min().key}},{key:"maxKey",value:function(){return this.right.isEmpty()?this.key:this.right.maxKey()}},{key:"insert",value:function(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}},{key:"removeMin",value:function(){if(this.left.isEmpty())return e.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()}},{key:"remove",value:function(t,n){var r,i=this;if(n(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(t,i.key)){if(i.right.isEmpty())return e.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,n))}return i.fixUp()}},{key:"isRed",value:function(){return this.color}},{key:"fixUp",value:function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}},{key:"moveRedLeft",value:function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}},{key:"moveRedRight",value:function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}},{key:"rotateLeft",value:function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}},{key:"rotateRight",value:function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}},{key:"colorFlip",value:function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}},{key:"checkMaxDepth",value:function(){var e=this.check();return Math.pow(2,e)<=this.size+1}},{key:"check",value:function(){if(this.isRed()&&this.left.isRed())throw R();if(this.right.isRed())throw R();var e=this.left.check();if(e!==this.right.check())throw R();return e+(this.isRed()?0:1)}}]),e}();cn.EMPTY=null,cn.RED=!0,cn.BLACK=!1,cn.EMPTY=new(function(){function e(){(0,f.Z)(this,e),this.size=0}return(0,h.Z)(e,[{key:"key",get:function(){throw R()}},{key:"value",get:function(){throw R()}},{key:"color",get:function(){throw R()}},{key:"left",get:function(){throw R()}},{key:"right",get:function(){throw R()}},{key:"copy",value:function(e,t,n,r,i){return this}},{key:"insert",value:function(e,t,n){return new cn(e,t)}},{key:"remove",value:function(e,t){return this}},{key:"isEmpty",value:function(){return!0}},{key:"inorderTraversal",value:function(e){return!1}},{key:"reverseTraversal",value:function(e){return!1}},{key:"minKey",value:function(){return null}},{key:"maxKey",value:function(){return null}},{key:"isRed",value:function(){return!1}},{key:"checkMaxDepth",value:function(){return!0}},{key:"check",value:function(){return 0}}]),e}());var ln=function(){function e(t){(0,f.Z)(this,e),this.comparator=t,this.data=new on(this.comparator)}return(0,h.Z)(e,[{key:"has",value:function(e){return null!==this.data.get(e)}},{key:"first",value:function(){return this.data.minKey()}},{key:"last",value:function(){return this.data.maxKey()}},{key:"size",get:function(){return this.data.size}},{key:"indexOf",value:function(e){return this.data.indexOf(e)}},{key:"forEach",value:function(e){this.data.inorderTraversal((function(t,n){return e(t),!1}))}},{key:"forEachInRange",value:function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}},{key:"forEachWhile",value:function(e,t){var n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}},{key:"firstAfterOrEqual",value:function(e){var t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}},{key:"getIterator",value:function(){return new fn(this.data.getIterator())}},{key:"getIteratorFrom",value:function(e){return new fn(this.data.getIteratorFrom(e))}},{key:"add",value:function(e){return this.copy(this.data.remove(e).insert(e,!0))}},{key:"delete",value:function(e){return this.has(e)?this.copy(this.data.remove(e)):this}},{key:"isEmpty",value:function(){return this.data.isEmpty()}},{key:"unionWith",value:function(e){var t=this;return t.size<e.size&&(t=e,e=this),e.forEach((function(e){t=t.add(e)})),t}},{key:"isEqual",value:function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.data.getIterator(),r=t.data.getIterator();n.hasNext();){var i=n.getNext().key,a=r.getNext().key;if(0!==this.comparator(i,a))return!1}return!0}},{key:"toArray",value:function(){var e=[];return this.forEach((function(t){e.push(t)})),e}},{key:"toString",value:function(){var e=[];return this.forEach((function(t){return e.push(t)})),"SortedSet("+e.toString()+")"}},{key:"copy",value:function(t){var n=new e(this.comparator);return n.data=t,n}}]),e}(),fn=function(){function e(t){(0,f.Z)(this,e),this.iter=t}return(0,h.Z)(e,[{key:"getNext",value:function(){return this.iter.getNext().key}},{key:"hasNext",value:function(){return this.iter.hasNext()}}]),e}(),hn=new on(xe.comparator);function dn(){return hn}var vn=new on(xe.comparator);function yn(){return vn}var pn=new on(xe.comparator);function mn(){return pn}var gn=new ln(xe.comparator);function kn(){for(var e=gn,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var u=a[i];e=e.add(u)}return e}var wn=new ln(J);function bn(){return wn}var xn=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.snapshotVersion=t,this.targetChanges=n,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=a}return(0,h.Z)(e,null,[{key:"createSynthesizedRemoteEventForCurrentChange",value:function(t,n){var r=new Map;return r.set(t,In.createSynthesizedTargetChangeForCurrentChange(t,n)),new e(te.min(),r,bn(),dn(),kn())}}]),e}(),In=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.resumeToken=t,this.current=n,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=a}return(0,h.Z)(e,null,[{key:"createSynthesizedTargetChangeForCurrentChange",value:function(t,n){return new e(fe.EMPTY_BYTE_STRING,n,kn(),kn(),kn())}}]),e}(),Tn=(0,h.Z)((function e(t,n,r,i){(0,f.Z)(this,e),this.$=t,this.removedTargetIds=n,this.key=r,this.O=i})),En=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.targetId=t,this.M=n})),Sn=(0,h.Z)((function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fe.EMPTY_BYTE_STRING,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,f.Z)(this,e),this.state=t,this.targetIds=n,this.resumeToken=r,this.cause=i})),An=function(){function e(){(0,f.Z)(this,e),this.F=0,this.L=Dn(),this.B=fe.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}return(0,h.Z)(e,[{key:"current",get:function(){return this.U}},{key:"resumeToken",get:function(){return this.B}},{key:"K",get:function(){return 0!==this.F}},{key:"j",get:function(){return this.q}},{key:"W",value:function(e){e.approximateByteSize()>0&&(this.q=!0,this.B=e)}},{key:"G",value:function(){var e=kn(),t=kn(),n=kn();return this.L.forEach((function(r,i){switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:R()}})),new In(this.B,this.U,e,t,n)}},{key:"H",value:function(){this.q=!1,this.L=Dn()}},{key:"J",value:function(e,t){this.q=!0,this.L=this.L.insert(e,t)}},{key:"Y",value:function(e){this.q=!0,this.L=this.L.remove(e)}},{key:"X",value:function(){this.F+=1}},{key:"Z",value:function(){this.F-=1}},{key:"tt",value:function(){this.q=!0,this.U=!0}}]),e}(),_n=function(){function e(t){(0,f.Z)(this,e),this.et=t,this.nt=new Map,this.st=dn(),this.it=Nn(),this.rt=new ln(J)}return(0,h.Z)(e,[{key:"ot",value:function(e){var t,n=w(e.$);try{for(n.s();!(t=n.n()).done;){var r=t.value;e.O&&e.O.isFoundDocument()?this.ct(r,e.O):this.at(r,e.key,e.O)}}catch(o){n.e(o)}finally{n.f()}var i,a=w(e.removedTargetIds);try{for(a.s();!(i=a.n()).done;){var u=i.value;this.at(u,e.key,e.O)}}catch(o){a.e(o)}finally{a.f()}}},{key:"ut",value:function(e){var t=this;this.forEachTarget(e,(function(n){var r=t.ht(n);switch(e.state){case 0:t.lt(n)&&r.W(e.resumeToken);break;case 1:r.Z(),r.K||r.H(),r.W(e.resumeToken);break;case 2:r.Z(),r.K||t.removeTarget(n);break;case 3:t.lt(n)&&(r.tt(),r.W(e.resumeToken));break;case 4:t.lt(n)&&(t.ft(n),r.W(e.resumeToken));break;default:R()}}))}},{key:"forEachTarget",value:function(e,t){var n=this;e.targetIds.length>0?e.targetIds.forEach(t):this.nt.forEach((function(e,r){n.lt(r)&&t(r)}))}},{key:"dt",value:function(e){var t=e.targetId,n=e.M.count,r=this.wt(t);if(r){var i=r.target;if(je(i))if(0===n){var a=new xe(i.path);this.at(t,a,Ve.newNoDocument(a,te.min()))}else L(1===n);else this._t(t)!==n&&(this.ft(t),this.rt=this.rt.add(t))}}},{key:"gt",value:function(e){var t=this,n=new Map;this.nt.forEach((function(r,i){var a=t.wt(i);if(a){if(r.current&&je(a.target)){var u=new xe(a.target.path);null!==t.st.get(u)||t.yt(i,u)||t.at(i,u,Ve.newNoDocument(u,e))}r.j&&(n.set(i,r.G()),r.H())}}));var r=kn();this.it.forEach((function(e,n){var i=!0;n.forEachWhile((function(e){var n=t.wt(e);return!n||2===n.purpose||(i=!1,!1)})),i&&(r=r.add(e))}));var i=new xn(e,n,this.rt,this.st,r);return this.st=dn(),this.it=Nn(),this.rt=new ln(J),i}},{key:"ct",value:function(e,t){if(this.lt(e)){var n=this.yt(e,t.key)?2:0;this.ht(e).J(t.key,n),this.st=this.st.insert(t.key,t),this.it=this.it.insert(t.key,this.Tt(t.key).add(e))}}},{key:"at",value:function(e,t,n){if(this.lt(e)){var r=this.ht(e);this.yt(e,t)?r.J(t,1):r.Y(t),this.it=this.it.insert(t,this.Tt(t).delete(e)),n&&(this.st=this.st.insert(t,n))}}},{key:"removeTarget",value:function(e){this.nt.delete(e)}},{key:"_t",value:function(e){var t=this.ht(e).G();return this.et.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}},{key:"X",value:function(e){this.ht(e).X()}},{key:"ht",value:function(e){var t=this.nt.get(e);return t||(t=new An,this.nt.set(e,t)),t}},{key:"Tt",value:function(e){var t=this.it.get(e);return t||(t=new ln(J),this.it=this.it.insert(e,t)),t}},{key:"lt",value:function(e){var t=null!==this.wt(e);return t||N("WatchChangeAggregator","Detected inactive target",e),t}},{key:"wt",value:function(e){var t=this.nt.get(e);return t&&t.K?null:this.et.Et(e)}},{key:"ft",value:function(e){var t=this;this.nt.set(e,new An),this.et.getRemoteKeysForTarget(e).forEach((function(n){t.at(e,n,null)}))}},{key:"yt",value:function(e,t){return this.et.getRemoteKeysForTarget(e).has(t)}}]),e}();function Nn(){return new on(xe.comparator)}function Dn(){return new on(xe.comparator)}var Zn={asc:"ASCENDING",desc:"DESCENDING"},Cn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Rn=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.databaseId=t,this.C=n}));function Ln(e,t){return e.C?"".concat(new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z",""),".").concat(("000000000"+t.nanoseconds).slice(-9),"Z"):{seconds:""+t.seconds,nanos:t.nanoseconds}}function Mn(e,t){return e.C?t.toBase64():t.toUint8Array()}function Fn(e,t){return Ln(e,t.toTimestamp())}function On(e){return L(!!e),te.fromTimestamp(function(e){var t=de(e);return new ee(t.seconds,t.nanos)}(e))}function Pn(e,t){return function(e){return new ue(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Vn(e){var t=ue.fromString(e);return L(lr(t)),t}function qn(e,t){return Pn(e.databaseId,t.path)}function Un(e,t){var n=Vn(t);if(n.get(1)!==e.databaseId.projectId)throw new P(O.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new P(O.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new xe(Gn(n))}function Bn(e,t){return Pn(e.databaseId,t)}function Kn(e){var t=Vn(e);return 4===t.length?ue.emptyPath():Gn(t)}function jn(e){return new ue(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Gn(e){return L(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function zn(e,t,n){return{name:qn(e,t),fields:n.value.mapValue.fields}}function Qn(e,t,n){var r=Un(e,t.name),i=On(t.updateTime),a=new Oe({mapValue:{fields:t.fields}}),u=Ve.newFoundDocument(r,i,a);return n&&u.setHasCommittedMutations(),n?u.setHasCommittedMutations():u}function Wn(e,t){return"found"in t?function(e,t){L(!!t.found),t.found.name,t.found.updateTime;var n=Un(e,t.found.name),r=On(t.found.updateTime),i=new Oe({mapValue:{fields:t.found.fields}});return Ve.newFoundDocument(n,r,i)}(e,t):"missing"in t?function(e,t){L(!!t.missing),L(!!t.readTime);var n=Un(e,t.missing),r=On(t.readTime);return Ve.newNoDocument(n,r)}(e,t):R()}function Hn(e,t){var n;if(t instanceof Wt)n={update:zn(e,t.key,t.value)};else if(t instanceof tn)n={delete:qn(e,t.key)};else if(t instanceof Ht)n={update:zn(e,t.key,t.data),updateMask:cr(t.fieldMask)};else{if(!(t instanceof nn))return R();n={verify:qn(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((function(e){return function(e,t){var n=t.transform;if(n instanceof Dt)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Zt)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Rt)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Mt)return{fieldPath:t.field.canonicalString(),increment:n.N};throw R()}(0,e)}))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:Fn(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:R()}(e,t.precondition)),n}function Yn(e,t){var n=t.currentDocument?function(e){return void 0!==e.updateTime?qt.updateTime(On(e.updateTime)):void 0!==e.exists?qt.exists(e.exists):qt.none()}(t.currentDocument):qt.none(),r=t.updateTransforms?t.updateTransforms.map((function(t){return function(e,t){var n=null;if("setToServerValue"in t)L("REQUEST_TIME"===t.setToServerValue),n=new Dt;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new Zt(r)}else if("removeAllFromArray"in t){var i=t.removeAllFromArray.values||[];n=new Rt(i)}else"increment"in t?n=new Mt(e,t.increment):R();var a=se.fromServerFormat(t.fieldPath);return new Pt(a,n)}(e,t)})):[];if(t.update){t.update.name;var i=Un(e,t.update.name),a=new Oe({mapValue:{fields:t.update.fields}});if(t.updateMask){var u=function(e){var t=e.fieldPaths||[];return new ce(t.map((function(e){return se.fromServerFormat(e)})))}(t.updateMask);return new Ht(i,a,u,n,r)}return new Wt(i,a,n,r)}if(t.delete){var o=Un(e,t.delete);return new tn(o,n)}if(t.verify){var s=Un(e,t.verify);return new nn(s,n)}return R()}function Jn(e,t){return{documents:[Bn(e,t.path)]}}function Xn(e,t){var n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Bn(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Bn(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length){var t=e.map((function(e){return function(e){if("=="===e.op){if(Le(e.value))return{unaryFilter:{field:ar(e.field),op:"IS_NAN"}};if(Re(e.value))return{unaryFilter:{field:ar(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Le(e.value))return{unaryFilter:{field:ar(e.field),op:"IS_NOT_NAN"}};if(Re(e.value))return{unaryFilter:{field:ar(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ar(e.field),op:ir(e.op),value:e.value}}}(e)}));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(t.filters);i&&(n.structuredQuery.where=i);var a=function(e){if(0!==e.length)return e.map((function(e){return function(e){return{field:ar(e.field),direction:rr(e.dir)}}(e)}))}(t.orderBy);a&&(n.structuredQuery.orderBy=a);var u=function(e,t){return e.C||ke(t)?t:{value:t}}(e,t.limit);return null!==u&&(n.structuredQuery.limit=u),t.startAt&&(n.structuredQuery.startAt=tr(t.startAt)),t.endAt&&(n.structuredQuery.endAt=tr(t.endAt)),n}function $n(e){var t=Kn(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){L(1===r);var a=n.from[0];a.allDescendants?i=a.collectionId:t=t.child(a.collectionId)}var u=[];n.where&&(u=er(n.where));var o=[];n.orderBy&&(o=n.orderBy.map((function(e){return function(e){return new nt(ur(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)})));var s=null;n.limit&&(s=function(e){var t;return ke(t="object"==typeof e?e.value:e)?null:t}(n.limit));var c=null;n.startAt&&(c=nr(n.startAt));var l=null;return n.endAt&&(l=nr(n.endAt)),ot(t,i,o,u,s,"F",c,l)}function er(e){return e?void 0!==e.unaryFilter?[sr(e)]:void 0!==e.fieldFilter?[or(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((function(e){return er(e)})).reduce((function(e,t){return e.concat(t)})):R():[]}function tr(e){return{before:e.before,values:e.position}}function nr(e){var t=!!e.before,n=e.values||[];return new et(n,t)}function rr(e){return Zn[e]}function ir(e){return Cn[e]}function ar(e){return{fieldPath:e.canonicalString()}}function ur(e){return se.fromServerFormat(e.fieldPath)}function or(e){return Ge.create(ur(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return R()}}(e.fieldFilter.op),e.fieldFilter.value)}function sr(e){switch(e.unaryFilter.op){case"IS_NAN":var t=ur(e.unaryFilter.field);return Ge.create(t,"==",{doubleValue:NaN});case"IS_NULL":var n=ur(e.unaryFilter.field);return Ge.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var r=ur(e.unaryFilter.field);return Ge.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":var i=ur(e.unaryFilter.field);return Ge.create(i,"!=",{nullValue:"NULL_VALUE"});default:return R()}}function cr(e){var t=[];return e.fields.forEach((function(e){return t.push(e.canonicalString())})),{fieldPaths:t}}function lr(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function fr(e){for(var t="",n=0;n<e.length;n++)t.length>0&&(t=dr(t)),t=hr(e.get(n),t);return dr(t)}function hr(e,t){for(var n=t,r=e.length,i=0;i<r;i++){var a=e.charAt(i);switch(a){case"\0":n+="";break;case"":n+="";break;default:n+=a}}return n}function dr(e){return e+""}function vr(e){var t=e.length;if(L(t>=2),2===t)return L(""===e.charAt(0)&&""===e.charAt(1)),ue.emptyPath();for(var n=t-2,r=[],i="",a=0;a<t;){var u=e.indexOf("",a);switch((u<0||u>n)&&R(),e.charAt(u+1)){case"":var o=e.substring(a,u),s=void 0;0===i.length?s=o:(s=i+=o,i=""),r.push(s);break;case"":i+=e.substring(a,u),i+="\0";break;case"":i+=e.substring(a,u+1);break;default:R()}a=u+2}return new ue(r)}var yr=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.seconds=t,this.nanoseconds=n})),pr=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.ownerId=t,this.allowTabSynchronization=n,this.leaseTimestampMs=r}));pr.store="owner",pr.key="owner";var mr=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.userId=t,this.lastAcknowledgedBatchId=n,this.lastStreamToken=r}));mr.store="mutationQueues",mr.keyPath="userId";var gr=(0,h.Z)((function e(t,n,r,i,a){(0,f.Z)(this,e),this.userId=t,this.batchId=n,this.localWriteTimeMs=r,this.baseMutations=i,this.mutations=a}));gr.store="mutations",gr.keyPath="batchId",gr.userMutationsIndex="userMutationsIndex",gr.userMutationsKeyPath=["userId","batchId"];var kr=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,null,[{key:"prefixForUser",value:function(e){return[e]}},{key:"prefixForPath",value:function(e,t){return[e,fr(t)]}},{key:"key",value:function(e,t,n){return[e,fr(t),n]}}]),e}();kr.store="documentMutations",kr.PLACEHOLDER=new kr;var wr=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.path=t,this.readTime=n})),br=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.path=t,this.version=n})),xr=(0,h.Z)((function e(t,n,r,i,a,u){(0,f.Z)(this,e),this.unknownDocument=t,this.noDocument=n,this.document=r,this.hasCommittedMutations=i,this.readTime=a,this.parentPath=u}));xr.store="remoteDocuments",xr.readTimeIndex="readTimeIndex",xr.readTimeIndexPath="readTime",xr.collectionReadTimeIndex="collectionReadTimeIndex",xr.collectionReadTimeIndexPath=["parentPath","readTime"];var Ir=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.byteSize=t}));Ir.store="remoteDocumentGlobal",Ir.key="remoteDocumentGlobalKey";var Tr=(0,h.Z)((function e(t,n,r,i,a,u,o){(0,f.Z)(this,e),this.targetId=t,this.canonicalId=n,this.readTime=r,this.resumeToken=i,this.lastListenSequenceNumber=a,this.lastLimboFreeSnapshotVersion=u,this.query=o}));Tr.store="targets",Tr.keyPath="targetId",Tr.queryTargetsIndexName="queryTargetsIndex",Tr.queryTargetsKeyPath=["canonicalId","targetId"];var Er=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.targetId=t,this.path=n,this.sequenceNumber=r}));Er.store="targetDocuments",Er.keyPath=["targetId","path"],Er.documentTargetsIndex="documentTargetsIndex",Er.documentTargetsKeyPath=["path","targetId"];var Sr=(0,h.Z)((function e(t,n,r,i){(0,f.Z)(this,e),this.highestTargetId=t,this.highestListenSequenceNumber=n,this.lastRemoteSnapshotVersion=r,this.targetCount=i}));Sr.key="targetGlobalKey",Sr.store="targetGlobal";var Ar=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.collectionId=t,this.parent=n}));Ar.store="collectionParents",Ar.keyPath=["collectionId","parent"];var _r=(0,h.Z)((function e(t,n,r,i){(0,f.Z)(this,e),this.clientId=t,this.updateTimeMs=n,this.networkEnabled=r,this.inForeground=i}));_r.store="clientMetadata",_r.keyPath="clientId";var Nr=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.bundleId=t,this.createTime=n,this.version=r}));Nr.store="bundles",Nr.keyPath="bundleId";var Dr=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.name=t,this.readTime=n,this.bundledQuery=r}));Dr.store="namedQueries",Dr.keyPath="name";var Zr=[mr.store,gr.store,kr.store,xr.store,Tr.store,pr.store,Sr.store,Er.store].concat([_r.store]).concat([Ir.store]).concat([Ar.store]).concat([Nr.store,Dr.store]),Cr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Rr=function(){function e(){(0,f.Z)(this,e),this.onCommittedListeners=[]}return(0,h.Z)(e,[{key:"addOnCommittedListener",value:function(e){this.onCommittedListeners.push(e)}},{key:"raiseOnCommittedEvent",value:function(){this.onCommittedListeners.forEach((function(e){return e()}))}}]),e}(),Lr=function(){function e(t){var n=this;(0,f.Z)(this,e),this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((function(e){n.isDone=!0,n.result=e,n.nextCallback&&n.nextCallback(e)}),(function(e){n.isDone=!0,n.error=e,n.catchCallback&&n.catchCallback(e)}))}return(0,h.Z)(e,[{key:"catch",value:function(e){return this.next(void 0,e)}},{key:"next",value:function(t,n){var r=this;return this.callbackAttached&&R(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(t,this.result):new e((function(e,i){r.nextCallback=function(n){r.wrapSuccess(t,n).next(e,i)},r.catchCallback=function(t){r.wrapFailure(n,t).next(e,i)}}))}},{key:"toPromise",value:function(){var e=this;return new Promise((function(t,n){e.next(t,n)}))}},{key:"wrapUserFunction",value:function(t){try{var n=t();return n instanceof e?n:e.resolve(n)}catch(t){return e.reject(t)}}},{key:"wrapSuccess",value:function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.resolve(n)}},{key:"wrapFailure",value:function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.reject(n)}}],[{key:"resolve",value:function(t){return new e((function(e,n){e(t)}))}},{key:"reject",value:function(t){return new e((function(e,n){n(t)}))}},{key:"waitFor",value:function(t){return new e((function(e,n){var r=0,i=0,a=!1;t.forEach((function(t){++r,t.next((function(){++i,a&&i===r&&e()}),(function(e){return n(e)}))})),a=!0,i===r&&e()}))}},{key:"or",value:function(t){var n,r=e.resolve(!1),i=w(t);try{var a=function(){var t=n.value;r=r.next((function(n){return n?e.resolve(n):t()}))};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return r}},{key:"forEach",value:function(e,t){var n=this,r=[];return e.forEach((function(e,i){r.push(t.call(n,e,i))})),this.waitFor(r)}}]),e}(),Mr=function(){function e(t,n){var r=this;(0,f.Z)(this,e),this.action=t,this.transaction=n,this.aborted=!1,this.It=new V,this.transaction.oncomplete=function(){r.It.resolve()},this.transaction.onabort=function(){n.error?r.It.reject(new Pr(t,n.error)):r.It.resolve()},this.transaction.onerror=function(e){var n=Kr(e.target.error);r.It.reject(new Pr(t,n))}}return(0,h.Z)(e,[{key:"At",get:function(){return this.It.promise}},{key:"abort",value:function(e){e&&this.It.reject(e),this.aborted||(N("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}},{key:"store",value:function(e){var t=this.transaction.objectStore(e);return new qr(t)}}],[{key:"open",value:function(t,n,r,i){try{return new e(n,t.transaction(i,r))}catch(t){throw new Pr(n,t)}}}]),e}(),Fr=function(){function e(t,n,r){(0,f.Z)(this,e),this.name=t,this.version=n,this.Rt=r,12.2===e.bt((0,g.z$)())&&D("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var t,n;return(0,h.Z)(e,[{key:"Ct",value:(n=(0,u.Z)(v().mark((function e(t){var n=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.db,e.t0){e.next=6;break}return N("SimpleDb","Opening database:",this.name),e.next=5,new Promise((function(e,r){var i=indexedDB.open(n.name,n.version);i.onsuccess=function(t){var n=t.target.result;e(n)},i.onblocked=function(){r(new Pr(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=function(e){var n=e.target.error;"VersionError"===n.name?r(new P(O.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===n.name?r(new P(O.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+n)):r(new Pr(t,n))},i.onupgradeneeded=function(e){N("SimpleDb",'Database "'+n.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;n.Rt.Nt(t,i.transaction,e.oldVersion,n.version).next((function(){N("SimpleDb","Database upgrade to version "+n.version+" complete")}))}}));case 5:this.db=e.sent;case 6:return this.kt&&(this.db.onversionchange=function(e){return n.kt(e)}),e.abrupt("return",this.db);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"xt",value:function(e){this.kt=e,this.db&&(this.db.onversionchange=function(t){return e(t)})}},{key:"runTransaction",value:(t=(0,u.Z)(v().mark((function e(t,n,r,i){var a,u,o,s,c=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a="readonly"===n,u=0,o=v().mark((function e(){var n,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return++u,e.prev=1,e.next=4,c.Ct(t);case 4:return c.db=e.sent,n=Mr.open(c.db,t,a?"readonly":"readwrite",r),o=i(n).catch((function(e){return n.abort(e),Lr.reject(e)})).toPromise(),o.catch((function(){})),e.next=9,n.At;case 9:return e.t0=o,e.abrupt("return",{v:e.t0});case 13:if(e.prev=13,e.t1=e.catch(1),s="FirebaseError"!==e.t1.name&&u<3,N("SimpleDb","Transaction failed with error:",e.t1.message,"Retrying:",s),c.close(),s){e.next=18;break}return e.abrupt("return",{v:Promise.reject(e.t1)});case 18:case"end":return e.stop()}}),e,null,[[1,13]])}));case 3:return e.delegateYield(o(),"t0",4);case 4:if("object"!=typeof(s=e.t0)){e.next=7;break}return e.abrupt("return",s.v);case 7:e.next=3;break;case 9:case"end":return e.stop()}}),e)}))),function(e,n,r,i){return t.apply(this,arguments)})},{key:"close",value:function(){this.db&&this.db.close(),this.db=void 0}}],[{key:"delete",value:function(e){return N("SimpleDb","Removing database:",e),Ur(window.indexedDB.deleteDatabase(e)).toPromise()}},{key:"Pt",value:function(){if(!(0,g.hl)())return!1;if(e.vt())return!0;var t=(0,g.z$)(),n=e.bt(t),r=0<n&&n<10,i=e.Vt(t),a=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||r||a)}},{key:"vt",value:function(){var e;return"undefined"!=typeof process&&"YES"===(null===(e={})||void 0===e?void 0:e.St)}},{key:"Dt",value:function(e,t){return e.store(t)}},{key:"bt",value:function(e){var t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}},{key:"Vt",value:function(e){var t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}}]),e}(),Or=function(){function e(t){(0,f.Z)(this,e),this.$t=t,this.Ot=!1,this.Mt=null}return(0,h.Z)(e,[{key:"isDone",get:function(){return this.Ot}},{key:"Ft",get:function(){return this.Mt}},{key:"cursor",set:function(e){this.$t=e}},{key:"done",value:function(){this.Ot=!0}},{key:"Lt",value:function(e){this.Mt=e}},{key:"delete",value:function(){return Ur(this.$t.delete())}}]),e}(),Pr=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,O.UNAVAILABLE,"IndexedDB transaction '".concat(e,"' failed: ").concat(r))).name="IndexedDbTransactionError",i}return(0,h.Z)(n)}(P);function Vr(e){return"IndexedDbTransactionError"===e.name}var qr=function(){function e(t){(0,f.Z)(this,e),this.store=t}return(0,h.Z)(e,[{key:"put",value:function(e,t){var n;return void 0!==t?(N("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(N("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Ur(n)}},{key:"add",value:function(e){return N("SimpleDb","ADD",this.store.name,e,e),Ur(this.store.add(e))}},{key:"get",value:function(e){var t=this;return Ur(this.store.get(e)).next((function(n){return void 0===n&&(n=null),N("SimpleDb","GET",t.store.name,e,n),n}))}},{key:"delete",value:function(e){return N("SimpleDb","DELETE",this.store.name,e),Ur(this.store.delete(e))}},{key:"count",value:function(){return N("SimpleDb","COUNT",this.store.name),Ur(this.store.count())}},{key:"Bt",value:function(e,t){var n=this.cursor(this.options(e,t)),r=[];return this.Ut(n,(function(e,t){r.push(t)})).next((function(){return r}))}},{key:"qt",value:function(e,t){N("SimpleDb","DELETE ALL",this.store.name);var n=this.options(e,t);n.Kt=!1;var r=this.cursor(n);return this.Ut(r,(function(e,t,n){return n.delete()}))}},{key:"jt",value:function(e,t){var n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.Ut(r,t)}},{key:"Qt",value:function(e){var t=this.cursor({});return new Lr((function(n,r){t.onerror=function(e){var t=Kr(e.target.error);r(t)},t.onsuccess=function(t){var r=t.target.result;r?e(r.primaryKey,r.value).next((function(e){e?r.continue():n()})):n()}}))}},{key:"Ut",value:function(e,t){var n=[];return new Lr((function(r,i){e.onerror=function(e){i(e.target.error)},e.onsuccess=function(e){var i=e.target.result;if(i){var a=new Or(i),u=t(i.primaryKey,i.value,a);if(u instanceof Lr){var o=u.catch((function(e){return a.done(),Lr.reject(e)}));n.push(o)}a.isDone?r():null===a.Ft?i.continue():i.continue(a.Ft)}else r()}})).next((function(){return Lr.waitFor(n)}))}},{key:"options",value:function(e,t){var n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}},{key:"cursor",value:function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.Kt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}]),e}();function Ur(e){return new Lr((function(t,n){e.onsuccess=function(e){var n=e.target.result;t(n)},e.onerror=function(e){var t=Kr(e.target.error);n(t)}}))}var Br=!1;function Kr(e){var t=Fr.bt((0,g.z$)());if(t>=12.2&&t<13){var n="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(n)>=0){var r=new P("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '".concat(n,"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround."));return Br||(Br=!0,setTimeout((function(){throw r}),0)),r}}return e}var jr=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).Wt=e,i.currentSequenceNumber=r,i}return(0,h.Z)(n)}(Rr);function Gr(e,t){var n=F(e);return Fr.Dt(n.Wt,t)}var zr=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.batchId=t,this.localWriteTime=n,this.baseMutations=r,this.mutations=i}return(0,h.Z)(e,[{key:"applyToRemoteDocument",value:function(e,t){for(var n=t.mutationResults,r=0;r<this.mutations.length;r++){var i=this.mutations[r];i.key.isEqual(e.key)&&Kt(i,e,n[r])}}},{key:"applyToLocalView",value:function(e){var t,n=w(this.baseMutations);try{for(n.s();!(t=n.n()).done;){var r=t.value;r.key.isEqual(e.key)&&jt(r,e,this.localWriteTime)}}catch(o){n.e(o)}finally{n.f()}var i,a=w(this.mutations);try{for(a.s();!(i=a.n()).done;){var u=i.value;u.key.isEqual(e.key)&&jt(u,e,this.localWriteTime)}}catch(o){a.e(o)}finally{a.f()}}},{key:"applyToLocalDocumentSet",value:function(e){var t=this;this.mutations.forEach((function(n){var r=e.get(n.key),i=r;t.applyToLocalView(i),r.isValidDocument()||i.convertToNoDocument(te.min())}))}},{key:"keys",value:function(){return this.mutations.reduce((function(e,t){return e.add(t.key)}),kn())}},{key:"isEqual",value:function(e){return this.batchId===e.batchId&&X(this.mutations,e.mutations,(function(e,t){return zt(e,t)}))&&X(this.baseMutations,e.baseMutations,(function(e,t){return zt(e,t)}))}}]),e}(),Qr=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.batch=t,this.commitVersion=n,this.mutationResults=r,this.docVersions=i}return(0,h.Z)(e,null,[{key:"from",value:function(t,n,r){L(t.mutations.length===r.length);for(var i=mn(),a=t.mutations,u=0;u<a.length;u++)i=i.insert(a[u].key,r[u].version);return new e(t,n,r,i)}}]),e}(),Wr=function(){function e(t,n,r,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:te.min(),u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:te.min(),o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:fe.EMPTY_BYTE_STRING;(0,f.Z)(this,e),this.target=t,this.targetId=n,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=a,this.lastLimboFreeSnapshotVersion=u,this.resumeToken=o}return(0,h.Z)(e,[{key:"withSequenceNumber",value:function(t){return new e(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}},{key:"withResumeToken",value:function(t,n){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,n,this.lastLimboFreeSnapshotVersion,t)}},{key:"withLastLimboFreeSnapshotVersion",value:function(t){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}]),e}(),Hr=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.Gt=t}));function Yr(e,t){if(t.document)return Qn(e.Gt,t.document,!!t.hasCommittedMutations);if(t.noDocument){var n=xe.fromSegments(t.noDocument.path),r=ti(t.noDocument.readTime),i=Ve.newNoDocument(n,r);return t.hasCommittedMutations?i.setHasCommittedMutations():i}if(t.unknownDocument){var a=xe.fromSegments(t.unknownDocument.path),u=ti(t.unknownDocument.version);return Ve.newUnknownDocument(a,u)}return R()}function Jr(e,t,n){var r=Xr(n),i=t.key.path.popLast().toArray();if(t.isFoundDocument()){var a=function(e,t){return{name:qn(e,t.key),fields:t.data.value.mapValue.fields,updateTime:Ln(e,t.version.toTimestamp())}}(e.Gt,t),u=t.hasCommittedMutations;return new xr(null,null,a,u,r,i)}if(t.isNoDocument()){var o=t.key.path.toArray(),s=ei(t.version),c=t.hasCommittedMutations;return new xr(null,new wr(o,s),null,c,r,i)}if(t.isUnknownDocument()){var l=t.key.path.toArray(),f=ei(t.version);return new xr(new br(l,f),null,null,!0,r,i)}return R()}function Xr(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function $r(e){var t=new ee(e[0],e[1]);return te.fromTimestamp(t)}function ei(e){var t=e.toTimestamp();return new yr(t.seconds,t.nanoseconds)}function ti(e){var t=new ee(e.seconds,e.nanoseconds);return te.fromTimestamp(t)}function ni(e,t){for(var n=(t.baseMutations||[]).map((function(t){return Yn(e.Gt,t)})),r=0;r<t.mutations.length-1;++r){var i=t.mutations[r];if(r+1<t.mutations.length&&void 0!==t.mutations[r+1].transform){var a=t.mutations[r+1];i.updateTransforms=a.transform.fieldTransforms,t.mutations.splice(r+1,1),++r}}var u=t.mutations.map((function(t){return Yn(e.Gt,t)})),o=ee.fromMillis(t.localWriteTimeMs);return new zr(t.batchId,o,n,u)}function ri(e){var t,n,r=ti(e.readTime),i=void 0!==e.lastLimboFreeSnapshotVersion?ti(e.lastLimboFreeSnapshotVersion):te.min();return void 0!==e.query.documents?(L(1===(n=e.query).documents.length),t=yt(st(Kn(n.documents[0])))):t=function(e){return yt($n(e))}(e.query),new Wr(t,e.targetId,0,e.lastListenSequenceNumber,r,i,fe.fromBase64String(e.resumeToken))}function ii(e,t){var n,r=ei(t.snapshotVersion),i=ei(t.lastLimboFreeSnapshotVersion);n=je(t.target)?Jn(e.Gt,t.target):Xn(e.Gt,t.target);var a=t.resumeToken.toBase64();return new Tr(t.targetId,Be(t.target),r,a,t.sequenceNumber,i,n)}function ai(e){var t=$n({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?pt(t,t.limit,"L"):t}var ui=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,[{key:"getBundleMetadata",value:function(e,t){return oi(e).get(t).next((function(e){if(e)return{id:(t=e).bundleId,createTime:ti(t.createTime),version:t.version};var t}))}},{key:"saveBundleMetadata",value:function(e,t){return oi(e).put({bundleId:(n=t).id,createTime:ei(On(n.createTime)),version:n.version});var n}},{key:"getNamedQuery",value:function(e,t){return si(e).get(t).next((function(e){if(e)return{name:(t=e).name,query:ai(t.bundledQuery),readTime:ti(t.readTime)};var t}))}},{key:"saveNamedQuery",value:function(e,t){return si(e).put(function(e){return{name:e.name,readTime:ei(On(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}]),e}();function oi(e){return Gr(e,Nr.store)}function si(e){return Gr(e,Dr.store)}var ci=function(){function e(){(0,f.Z)(this,e),this.zt=new li}return(0,h.Z)(e,[{key:"addToCollectionParentIndex",value:function(e,t){return this.zt.add(t),Lr.resolve()}},{key:"getCollectionParents",value:function(e,t){return Lr.resolve(this.zt.getEntries(t))}}]),e}(),li=function(){function e(){(0,f.Z)(this,e),this.index={}}return(0,h.Z)(e,[{key:"add",value:function(e){var t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ln(ue.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}},{key:"has",value:function(e){var t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}},{key:"getEntries",value:function(e){return(this.index[e]||new ln(ue.comparator)).toArray()}}]),e}(),fi=function(){function e(){(0,f.Z)(this,e),this.Ht=new li}return(0,h.Z)(e,[{key:"addToCollectionParentIndex",value:function(e,t){var n=this;if(!this.Ht.has(t)){var r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener((function(){n.Ht.add(t)}));var a={collectionId:r,parent:fr(i)};return hi(e).put(a)}return Lr.resolve()}},{key:"getCollectionParents",value:function(e,t){var n=[],r=IDBKeyRange.bound([t,""],[$(t),""],!1,!0);return hi(e).Bt(r).next((function(e){var r,i=w(e);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.collectionId!==t)break;n.push(vr(a.parent))}}catch(u){i.e(u)}finally{i.f()}return n}))}}]),e}();function hi(e){return Gr(e,Ar.store)}var di={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},vi=function(){function e(t,n,r){(0,f.Z)(this,e),this.cacheSizeCollectionThreshold=t,this.percentileToCollect=n,this.maximumSequenceNumbersToCollect=r}return(0,h.Z)(e,null,[{key:"withCacheSize",value:function(t){return new e(t,e.DEFAULT_COLLECTION_PERCENTILE,e.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}]),e}();function yi(e,t,n){var r=e.store(gr.store),i=e.store(kr.store),a=[],u=IDBKeyRange.only(n.batchId),o=0,s=r.jt({range:u},(function(e,t,n){return o++,n.delete()}));a.push(s.next((function(){L(1===o)})));var c,l=[],f=w(n.mutations);try{for(f.s();!(c=f.n()).done;){var h=c.value,d=kr.key(t,h.key.path,n.batchId);a.push(i.delete(d)),l.push(h.key)}}catch(v){f.e(v)}finally{f.f()}return Lr.waitFor(a).next((function(){return l}))}function pi(e){if(!e)return 0;var t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw R();t=e.noDocument}return JSON.stringify(t).length}vi.DEFAULT_COLLECTION_PERCENTILE=10,vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,vi.DEFAULT=new vi(41943040,vi.DEFAULT_COLLECTION_PERCENTILE,vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),vi.DISABLED=new vi(-1,0,0);var mi=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.userId=t,this.k=n,this.Jt=r,this.referenceDelegate=i,this.Yt={}}return(0,h.Z)(e,[{key:"checkEmpty",value:function(e){var t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ki(e).jt({index:gr.userMutationsIndex,range:n},(function(e,n,r){t=!1,r.done()})).next((function(){return t}))}},{key:"addMutationBatch",value:function(e,t,n,r){var i=this,a=wi(e),u=ki(e);return u.add({}).next((function(o){L("number"==typeof o);var s,c=new zr(o,t,n,r),l=function(e,t,n){var r=n.baseMutations.map((function(t){return Hn(e.Gt,t)})),i=n.mutations.map((function(t){return Hn(e.Gt,t)}));return new gr(t,n.batchId,n.localWriteTime.toMillis(),r,i)}(i.k,i.userId,c),f=[],h=new ln((function(e,t){return J(e.canonicalString(),t.canonicalString())})),d=w(r);try{for(d.s();!(s=d.n()).done;){var v=s.value,y=kr.key(i.userId,v.key.path,o);h=h.add(v.key.path.popLast()),f.push(u.put(l)),f.push(a.put(y,kr.PLACEHOLDER))}}catch(p){d.e(p)}finally{d.f()}return h.forEach((function(t){f.push(i.Jt.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((function(){i.Yt[o]=c.keys()})),Lr.waitFor(f).next((function(){return c}))}))}},{key:"lookupMutationBatch",value:function(e,t){var n=this;return ki(e).get(t).next((function(e){return e?(L(e.userId===n.userId),ni(n.k,e)):null}))}},{key:"Zt",value:function(e,t){var n=this;return this.Yt[t]?Lr.resolve(this.Yt[t]):this.lookupMutationBatch(e,t).next((function(e){if(e){var r=e.keys();return n.Yt[t]=r,r}return null}))}},{key:"getNextMutationBatchAfterBatchId",value:function(e,t){var n=this,r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),a=null;return ki(e).jt({index:gr.userMutationsIndex,range:i},(function(e,t,i){t.userId===n.userId&&(L(t.batchId>=r),a=ni(n.k,t)),i.done()})).next((function(){return a}))}},{key:"getHighestUnacknowledgedBatchId",value:function(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return ki(e).jt({index:gr.userMutationsIndex,range:t,reverse:!0},(function(e,t,r){n=t.batchId,r.done()})).next((function(){return n}))}},{key:"getAllMutationBatches",value:function(e){var t=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ki(e).Bt(gr.userMutationsIndex,n).next((function(e){return e.map((function(e){return ni(t.k,e)}))}))}},{key:"getAllMutationBatchesAffectingDocumentKey",value:function(e,t){var n=this,r=kr.prefixForPath(this.userId,t.path),i=IDBKeyRange.lowerBound(r),u=[];return wi(e).jt({range:i},(function(r,i,o){var s=(0,a.Z)(r,3),c=s[0],l=s[1],f=s[2],h=vr(l);if(c===n.userId&&t.path.isEqual(h))return ki(e).get(f).next((function(e){if(!e)throw R();L(e.userId===n.userId),u.push(ni(n.k,e))}));o.done()})).next((function(){return u}))}},{key:"getAllMutationBatchesAffectingDocumentKeys",value:function(e,t){var n=this,r=new ln(J),i=[];return t.forEach((function(t){var u=kr.prefixForPath(n.userId,t.path),o=IDBKeyRange.lowerBound(u),s=wi(e).jt({range:o},(function(e,i,u){var o=(0,a.Z)(e,3),s=o[0],c=o[1],l=o[2],f=vr(c);s===n.userId&&t.path.isEqual(f)?r=r.add(l):u.done()}));i.push(s)})),Lr.waitFor(i).next((function(){return n.te(e,r)}))}},{key:"getAllMutationBatchesAffectingQuery",value:function(e,t){var n=this,r=t.path,i=r.length+1,u=kr.prefixForPath(this.userId,r),o=IDBKeyRange.lowerBound(u),s=new ln(J);return wi(e).jt({range:o},(function(e,t,u){var o=(0,a.Z)(e,3),c=o[0],l=o[1],f=o[2],h=vr(l);c===n.userId&&r.isPrefixOf(h)?h.length===i&&(s=s.add(f)):u.done()})).next((function(){return n.te(e,s)}))}},{key:"te",value:function(e,t){var n=this,r=[],i=[];return t.forEach((function(t){i.push(ki(e).get(t).next((function(e){if(null===e)throw R();L(e.userId===n.userId),r.push(ni(n.k,e))})))})),Lr.waitFor(i).next((function(){return r}))}},{key:"removeMutationBatch",value:function(e,t){var n=this;return yi(e.Wt,this.userId,t).next((function(r){return e.addOnCommittedListener((function(){n.ee(t.batchId)})),Lr.forEach(r,(function(t){return n.referenceDelegate.markPotentiallyOrphaned(e,t)}))}))}},{key:"ee",value:function(e){delete this.Yt[e]}},{key:"performConsistencyCheck",value:function(e){var t=this;return this.checkEmpty(e).next((function(n){if(!n)return Lr.resolve();var r=IDBKeyRange.lowerBound(kr.prefixForUser(t.userId)),i=[];return wi(e).jt({range:r},(function(e,n,r){if(e[0]===t.userId){var a=vr(e[1]);i.push(a)}else r.done()})).next((function(){L(0===i.length)}))}))}},{key:"containsKey",value:function(e,t){return gi(e,this.userId,t)}},{key:"ne",value:function(e){var t=this;return bi(e).get(this.userId).next((function(e){return e||new mr(t.userId,-1,"")}))}}],[{key:"Xt",value:function(t,n,r,i){return L(""!==t.uid),new e(t.isAuthenticated()?t.uid:"",n,r,i)}}]),e}();function gi(e,t,n){var r=kr.prefixForPath(t,n.path),i=r[1],u=IDBKeyRange.lowerBound(r),o=!1;return wi(e).jt({range:u,Kt:!0},(function(e,n,r){var u=(0,a.Z)(e,3),s=u[0],c=u[1];u[2];s===t&&c===i&&(o=!0),r.done()})).next((function(){return o}))}function ki(e){return Gr(e,gr.store)}function wi(e){return Gr(e,kr.store)}function bi(e){return Gr(e,mr.store)}var xi=function(){function e(t){(0,f.Z)(this,e),this.se=t}return(0,h.Z)(e,[{key:"next",value:function(){return this.se+=2,this.se}}],[{key:"ie",value:function(){return new e(0)}},{key:"re",value:function(){return new e(-1)}}]),e}(),Ii=function(){function e(t,n){(0,f.Z)(this,e),this.referenceDelegate=t,this.k=n}return(0,h.Z)(e,[{key:"allocateTargetId",value:function(e){var t=this;return this.oe(e).next((function(n){var r=new xi(n.highestTargetId);return n.highestTargetId=r.next(),t.ce(e,n).next((function(){return n.highestTargetId}))}))}},{key:"getLastRemoteSnapshotVersion",value:function(e){return this.oe(e).next((function(e){return te.fromTimestamp(new ee(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))}))}},{key:"getHighestSequenceNumber",value:function(e){return this.oe(e).next((function(e){return e.highestListenSequenceNumber}))}},{key:"setTargetsMetadata",value:function(e,t,n){var r=this;return this.oe(e).next((function(i){return i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),r.ce(e,i)}))}},{key:"addTargetData",value:function(e,t){var n=this;return this.ae(e,t).next((function(){return n.oe(e).next((function(r){return r.targetCount+=1,n.ue(t,r),n.ce(e,r)}))}))}},{key:"updateTargetData",value:function(e,t){return this.ae(e,t)}},{key:"removeTargetData",value:function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next((function(){return Ti(e).delete(t.targetId)})).next((function(){return n.oe(e)})).next((function(t){return L(t.targetCount>0),t.targetCount-=1,n.ce(e,t)}))}},{key:"removeTargets",value:function(e,t,n){var r=this,i=0,a=[];return Ti(e).jt((function(u,o){var s=ri(o);s.sequenceNumber<=t&&null===n.get(s.targetId)&&(i++,a.push(r.removeTargetData(e,s)))})).next((function(){return Lr.waitFor(a)})).next((function(){return i}))}},{key:"forEachTarget",value:function(e,t){return Ti(e).jt((function(e,n){var r=ri(n);t(r)}))}},{key:"oe",value:function(e){return Ei(e).get(Sr.key).next((function(e){return L(null!==e),e}))}},{key:"ce",value:function(e,t){return Ei(e).put(Sr.key,t)}},{key:"ae",value:function(e,t){return Ti(e).put(ii(this.k,t))}},{key:"ue",value:function(e,t){var n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}},{key:"getTargetCount",value:function(e){return this.oe(e).next((function(e){return e.targetCount}))}},{key:"getTargetData",value:function(e,t){var n=Be(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return Ti(e).jt({range:r,index:Tr.queryTargetsIndexName},(function(e,n,r){var a=ri(n);Ke(t,a.target)&&(i=a,r.done())})).next((function(){return i}))}},{key:"addMatchingKeys",value:function(e,t,n){var r=this,i=[],a=Si(e);return t.forEach((function(t){var u=fr(t.path);i.push(a.put(new Er(n,u))),i.push(r.referenceDelegate.addReference(e,n,t))})),Lr.waitFor(i)}},{key:"removeMatchingKeys",value:function(e,t,n){var r=this,i=Si(e);return Lr.forEach(t,(function(t){var a=fr(t.path);return Lr.waitFor([i.delete([n,a]),r.referenceDelegate.removeReference(e,n,t)])}))}},{key:"removeMatchingKeysForTargetId",value:function(e,t){var n=Si(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}},{key:"getMatchingKeysForTargetId",value:function(e,t){var n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Si(e),i=kn();return r.jt({range:n,Kt:!0},(function(e,t,n){var r=vr(e[1]),a=new xe(r);i=i.add(a)})).next((function(){return i}))}},{key:"containsKey",value:function(e,t){var n=fr(t.path),r=IDBKeyRange.bound([n],[$(n)],!1,!0),i=0;return Si(e).jt({index:Er.documentTargetsIndex,Kt:!0,range:r},(function(e,t,n){var r=(0,a.Z)(e,2),u=r[0];r[1];0!==u&&(i++,n.done())})).next((function(){return i>0}))}},{key:"Et",value:function(e,t){return Ti(e).get(t).next((function(e){return e?ri(e):null}))}}]),e}();function Ti(e){return Gr(e,Tr.store)}function Ei(e){return Gr(e,Sr.store)}function Si(e){return Gr(e,Er.store)}function Ai(e){return _i.apply(this,arguments)}function _i(){return(_i=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.code===O.FAILED_PRECONDITION&&t.message===Cr){e.next=2;break}throw t;case 2:N("LocalStore","Unexpectedly lost primary lease");case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ni(e,t){var n=(0,a.Z)(e,2),r=n[0],i=n[1],u=(0,a.Z)(t,2),o=u[0],s=u[1],c=J(r,o);return 0===c?J(i,s):c}var Di=function(){function e(t){(0,f.Z)(this,e),this.he=t,this.buffer=new ln(Ni),this.le=0}return(0,h.Z)(e,[{key:"fe",value:function(){return++this.le}},{key:"de",value:function(e){var t=[e,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(t);else{var n=this.buffer.last();Ni(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}}},{key:"maxValue",get:function(){return this.buffer.last()[0]}}]),e}(),Zi=function(){function e(t,n){(0,f.Z)(this,e),this.garbageCollector=t,this.asyncQueue=n,this.we=!1,this._e=null}return(0,h.Z)(e,[{key:"start",value:function(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(e)}},{key:"stop",value:function(){this._e&&(this._e.cancel(),this._e=null)}},{key:"started",get:function(){return null!==this._e}},{key:"me",value:function(e){var t=this,n=this.we?3e5:6e4;N("LruGarbageCollector","Garbage collection scheduled in ".concat(n,"ms")),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",n,(0,u.Z)(v().mark((function n(){return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t._e=null,t.we=!0,n.prev=1,n.next=4,e.collectGarbage(t.garbageCollector);case 4:n.next=14;break;case 6:if(n.prev=6,n.t0=n.catch(1),!Vr(n.t0)){n.next=12;break}N("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",n.t0),n.next=14;break;case 12:return n.next=14,Ai(n.t0);case 14:return n.next=16,t.me(e);case 16:case"end":return n.stop()}}),n,null,[[1,6]])}))))}}]),e}(),Ci=function(){function e(t,n){(0,f.Z)(this,e),this.ge=t,this.params=n}return(0,h.Z)(e,[{key:"calculateTargetCount",value:function(e,t){return this.ge.ye(e).next((function(e){return Math.floor(t/100*e)}))}},{key:"nthSequenceNumber",value:function(e,t){var n=this;if(0===t)return Lr.resolve(W.I);var r=new Di(t);return this.ge.forEachTarget(e,(function(e){return r.de(e.sequenceNumber)})).next((function(){return n.ge.pe(e,(function(e){return r.de(e)}))})).next((function(){return r.maxValue}))}},{key:"removeTargets",value:function(e,t,n){return this.ge.removeTargets(e,t,n)}},{key:"removeOrphanedDocuments",value:function(e,t){return this.ge.removeOrphanedDocuments(e,t)}},{key:"collect",value:function(e,t){var n=this;return-1===this.params.cacheSizeCollectionThreshold?(N("LruGarbageCollector","Garbage collection skipped; disabled"),Lr.resolve(di)):this.getCacheSize(e).next((function(r){return r<n.params.cacheSizeCollectionThreshold?(N("LruGarbageCollector","Garbage collection skipped; Cache size ".concat(r," is lower than threshold ").concat(n.params.cacheSizeCollectionThreshold)),di):n.Te(e,t)}))}},{key:"getCacheSize",value:function(e){return this.ge.getCacheSize(e)}},{key:"Te",value:function(e,t){var n,r,i,a,u,o,s,c=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((function(t){return t>c.params.maximumSequenceNumbersToCollect?(N("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of ".concat(c.params.maximumSequenceNumbersToCollect," from ").concat(t)),r=c.params.maximumSequenceNumbersToCollect):r=t,a=Date.now(),c.nthSequenceNumber(e,r)})).next((function(r){return n=r,u=Date.now(),c.removeTargets(e,n,t)})).next((function(t){return i=t,o=Date.now(),c.removeOrphanedDocuments(e,n)})).next((function(e){return s=Date.now(),A()<=m.in.DEBUG&&N("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in ".concat(a-l,"ms\n\tDetermined least recently used ").concat(r," in ")+(u-a)+"ms\n"+"\tRemoved ".concat(i," targets in ")+(o-u)+"ms\n"+"\tRemoved ".concat(e," documents in ")+(s-o)+"ms\n"+"Total Duration: ".concat(s-l,"ms")),Lr.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})}))}}]),e}(),Ri=function(){function e(t,n){(0,f.Z)(this,e),this.db=t,this.garbageCollector=function(e,t){return new Ci(e,t)}(this,n)}return(0,h.Z)(e,[{key:"ye",value:function(e){var t=this.Ee(e);return this.db.getTargetCache().getTargetCount(e).next((function(e){return t.next((function(t){return e+t}))}))}},{key:"Ee",value:function(e){var t=0;return this.pe(e,(function(e){t++})).next((function(){return t}))}},{key:"forEachTarget",value:function(e,t){return this.db.getTargetCache().forEachTarget(e,t)}},{key:"pe",value:function(e,t){return this.Ie(e,(function(e,n){return t(n)}))}},{key:"addReference",value:function(e,t,n){return Li(e,n)}},{key:"removeReference",value:function(e,t,n){return Li(e,n)}},{key:"removeTargets",value:function(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}},{key:"markPotentiallyOrphaned",value:function(e,t){return Li(e,t)}},{key:"Ae",value:function(e,t){return function(e,t){var n=!1;return bi(e).Qt((function(r){return gi(e,r,t).next((function(e){return e&&(n=!0),Lr.resolve(!e)}))})).next((function(){return n}))}(e,t)}},{key:"removeOrphanedDocuments",value:function(e,t){var n=this,r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],a=0;return this.Ie(e,(function(u,o){if(o<=t){var s=n.Ae(e,u).next((function(t){if(!t)return a++,r.getEntry(e,u).next((function(){return r.removeEntry(u),Si(e).delete([0,fr(u.path)])}))}));i.push(s)}})).next((function(){return Lr.waitFor(i)})).next((function(){return r.apply(e)})).next((function(){return a}))}},{key:"removeTarget",value:function(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}},{key:"updateLimboDocument",value:function(e,t){return Li(e,t)}},{key:"Ie",value:function(e,t){var n,r=Si(e),i=W.I;return r.jt({index:Er.documentTargetsIndex},(function(e,r){var u=(0,a.Z)(e,2),o=u[0],s=(u[1],r.path),c=r.sequenceNumber;0===o?(i!==W.I&&t(new xe(vr(n)),i),i=c,n=s):i=W.I})).next((function(){i!==W.I&&t(new xe(vr(n)),i)}))}},{key:"getCacheSize",value:function(e){return this.db.getRemoteDocumentCache().getSize(e)}}]),e}();function Li(e,t){return Si(e).put(function(e,t){return new Er(0,fr(e.path),t)}(t,e.currentSequenceNumber))}var Mi=function(){function e(t,n){(0,f.Z)(this,e),this.mapKeyFn=t,this.equalsFn=n,this.inner={}}return(0,h.Z)(e,[{key:"get",value:function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var u=(0,a.Z)(r.value,2),o=u[0],s=u[1];if(this.equalsFn(o,e))return s}}catch(c){i.e(c)}finally{i.f()}}}},{key:"has",value:function(e){return void 0!==this.get(e)}},{key:"set",value:function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t])}else this.inner[n]=[[e,t]]}},{key:"delete",value:function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1}},{key:"forEach",value:function(e){re(this.inner,(function(t,n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var u=(0,a.Z)(r.value,2),o=u[0],s=u[1];e(o,s)}}catch(c){i.e(c)}finally{i.f()}}))}},{key:"isEmpty",value:function(){return ie(this.inner)}}]),e}(),Fi=function(){function e(){(0,f.Z)(this,e),this.changes=new Mi((function(e){return e.toString()}),(function(e,t){return e.isEqual(t)})),this.changesApplied=!1}return(0,h.Z)(e,[{key:"getReadTime",value:function(e){var t=this.changes.get(e);return t?t.readTime:te.min()}},{key:"addEntry",value:function(e,t){this.assertNotApplied(),this.changes.set(e.key,{document:e,readTime:t})}},{key:"removeEntry",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.assertNotApplied(),this.changes.set(e,{document:Ve.newInvalidDocument(e),readTime:t})}},{key:"getEntry",value:function(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Lr.resolve(n.document):this.getFromCache(e,t)}},{key:"getEntries",value:function(e,t){return this.getAllFromCache(e,t)}},{key:"apply",value:function(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}},{key:"assertNotApplied",value:function(){}}]),e}(),Oi=function(){function e(t,n){(0,f.Z)(this,e),this.k=t,this.Jt=n}return(0,h.Z)(e,[{key:"addEntry",value:function(e,t,n){return qi(e).put(Ui(t),n)}},{key:"removeEntry",value:function(e,t){var n=qi(e),r=Ui(t);return n.delete(r)}},{key:"updateMetadata",value:function(e,t){var n=this;return this.getMetadata(e).next((function(r){return r.byteSize+=t,n.Re(e,r)}))}},{key:"getEntry",value:function(e,t){var n=this;return qi(e).get(Ui(t)).next((function(e){return n.be(t,e)}))}},{key:"Pe",value:function(e,t){var n=this;return qi(e).get(Ui(t)).next((function(e){return{document:n.be(t,e),size:pi(e)}}))}},{key:"getEntries",value:function(e,t){var n=this,r=dn();return this.ve(e,t,(function(e,t){var i=n.be(e,t);r=r.insert(e,i)})).next((function(){return r}))}},{key:"Ve",value:function(e,t){var n=this,r=dn(),i=new on(xe.comparator);return this.ve(e,t,(function(e,t){var a=n.be(e,t);r=r.insert(e,a),i=i.insert(e,pi(t))})).next((function(){return{documents:r,Se:i}}))}},{key:"ve",value:function(e,t,n){if(t.isEmpty())return Lr.resolve();var r=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),i=t.getIterator(),a=i.getNext();return qi(e).jt({range:r},(function(e,t,r){for(var u=xe.fromSegments(e);a&&xe.comparator(a,u)<0;)n(a,null),a=i.getNext();a&&a.isEqual(u)&&(n(a,t),a=i.hasNext()?i.getNext():null),a?r.Lt(a.path.toArray()):r.done()})).next((function(){for(;a;)n(a,null),a=i.hasNext()?i.getNext():null}))}},{key:"getDocumentsMatchingQuery",value:function(e,t,n){var r=this,i=dn(),a=t.path.length+1,u={};if(n.isEqual(te.min())){var o=t.path.toArray();u.range=IDBKeyRange.lowerBound(o)}else{var s=t.path.toArray(),c=Xr(n);u.range=IDBKeyRange.lowerBound([s,c],!0),u.index=xr.collectionReadTimeIndex}return qi(e).jt(u,(function(e,n,u){if(e.length===a){var o=Yr(r.k,n);t.path.isPrefixOf(o.key.path)?wt(t,o)&&(i=i.insert(o.key,o)):u.done()}})).next((function(){return i}))}},{key:"newChangeBuffer",value:function(e){return new Pi(this,!!e&&e.trackRemovals)}},{key:"getSize",value:function(e){return this.getMetadata(e).next((function(e){return e.byteSize}))}},{key:"getMetadata",value:function(e){return Vi(e).get(Ir.key).next((function(e){return L(!!e),e}))}},{key:"Re",value:function(e,t){return Vi(e).put(Ir.key,t)}},{key:"be",value:function(e,t){if(t){var n=Yr(this.k,t);if(!n.isNoDocument()||!n.version.isEqual(te.min()))return n}return Ve.newInvalidDocument(e)}}]),e}(),Pi=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).De=e,i.trackRemovals=r,i.Ce=new Mi((function(e){return e.toString()}),(function(e,t){return e.isEqual(t)})),i}return(0,h.Z)(n,[{key:"applyChanges",value:function(e){var t=this,n=[],r=0,i=new ln((function(e,t){return J(e.canonicalString(),t.canonicalString())}));return this.changes.forEach((function(a,u){var o=t.Ce.get(a);if(u.document.isValidDocument()){var s=Jr(t.De.k,u.document,t.getReadTime(a));i=i.add(a.path.popLast());var c=pi(s);r+=c-o,n.push(t.De.addEntry(e,a,s))}else if(r-=o,t.trackRemovals){var l=Jr(t.De.k,Ve.newNoDocument(a,te.min()),t.getReadTime(a));n.push(t.De.addEntry(e,a,l))}else n.push(t.De.removeEntry(e,a))})),i.forEach((function(r){n.push(t.De.Jt.addToCollectionParentIndex(e,r))})),n.push(this.De.updateMetadata(e,r)),Lr.waitFor(n)}},{key:"getFromCache",value:function(e,t){var n=this;return this.De.Pe(e,t).next((function(e){return n.Ce.set(t,e.size),e.document}))}},{key:"getAllFromCache",value:function(e,t){var n=this;return this.De.Ve(e,t).next((function(e){var t=e.documents;return e.Se.forEach((function(e,t){n.Ce.set(e,t)})),t}))}}]),n}(Fi);function Vi(e){return Gr(e,Ir.store)}function qi(e){return Gr(e,xr.store)}function Ui(e){return e.path.toArray()}var Bi=function(){function e(t){(0,f.Z)(this,e),this.k=t}return(0,h.Z)(e,[{key:"Nt",value:function(e,t,n,r){var i=this;L(n<r&&n>=0&&r<=11);var a=new Mr("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore(pr.store)}(e),function(e){e.createObjectStore(mr.store,{keyPath:mr.keyPath}),e.createObjectStore(gr.store,{keyPath:gr.keyPath,autoIncrement:!0}).createIndex(gr.userMutationsIndex,gr.userMutationsKeyPath,{unique:!0}),e.createObjectStore(kr.store)}(e),Ki(e),function(e){e.createObjectStore(xr.store)}(e));var u=Lr.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore(Er.store),e.deleteObjectStore(Tr.store),e.deleteObjectStore(Sr.store)}(e),Ki(e)),u=u.next((function(){return function(e){var t=e.store(Sr.store),n=new Sr(0,0,te.min().toTimestamp(),0);return t.put(Sr.key,n)}(a)}))),n<4&&r>=4&&(0!==n&&(u=u.next((function(){return function(e,t){return t.store(gr.store).Bt().next((function(n){e.deleteObjectStore(gr.store),e.createObjectStore(gr.store,{keyPath:gr.keyPath,autoIncrement:!0}).createIndex(gr.userMutationsIndex,gr.userMutationsKeyPath,{unique:!0});var r=t.store(gr.store),i=n.map((function(e){return r.put(e)}));return Lr.waitFor(i)}))}(e,a)}))),u=u.next((function(){!function(e){e.createObjectStore(_r.store,{keyPath:_r.keyPath})}(e)}))),n<5&&r>=5&&(u=u.next((function(){return i.Ne(a)}))),n<6&&r>=6&&(u=u.next((function(){return function(e){e.createObjectStore(Ir.store)}(e),i.ke(a)}))),n<7&&r>=7&&(u=u.next((function(){return i.xe(a)}))),n<8&&r>=8&&(u=u.next((function(){return i.$e(e,a)}))),n<9&&r>=9&&(u=u.next((function(){!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e),function(e){var t=e.objectStore(xr.store);t.createIndex(xr.readTimeIndex,xr.readTimeIndexPath,{unique:!1}),t.createIndex(xr.collectionReadTimeIndex,xr.collectionReadTimeIndexPath,{unique:!1})}(t)}))),n<10&&r>=10&&(u=u.next((function(){return i.Oe(a)}))),n<11&&r>=11&&(u=u.next((function(){!function(e){e.createObjectStore(Nr.store,{keyPath:Nr.keyPath})}(e),function(e){e.createObjectStore(Dr.store,{keyPath:Dr.keyPath})}(e)}))),u}},{key:"ke",value:function(e){var t=0;return e.store(xr.store).jt((function(e,n){t+=pi(n)})).next((function(){var n=new Ir(t);return e.store(Ir.store).put(Ir.key,n)}))}},{key:"Ne",value:function(e){var t=this,n=e.store(mr.store),r=e.store(gr.store);return n.Bt().next((function(n){return Lr.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.Bt(gr.userMutationsIndex,i).next((function(r){return Lr.forEach(r,(function(r){L(r.userId===n.userId);var i=ni(t.k,r);return yi(e,n.userId,i).next((function(){}))}))}))}))}))}},{key:"xe",value:function(e){var t=e.store(Er.store),n=e.store(xr.store);return e.store(Sr.store).get(Sr.key).next((function(e){var r=[];return n.jt((function(n,i){var a=new ue(n),u=function(e){return[0,fr(e)]}(a);r.push(t.get(u).next((function(n){return n?Lr.resolve():function(n){return t.put(new Er(0,fr(n),e.highestListenSequenceNumber))}(a)})))})).next((function(){return Lr.waitFor(r)}))}))}},{key:"$e",value:function(e,t){e.createObjectStore(Ar.store,{keyPath:Ar.keyPath});var n=t.store(Ar.store),r=new li,i=function(e){if(r.add(e)){var t=e.lastSegment(),i=e.popLast();return n.put({collectionId:t,parent:fr(i)})}};return t.store(xr.store).jt({Kt:!0},(function(e,t){var n=new ue(e);return i(n.popLast())})).next((function(){return t.store(kr.store).jt({Kt:!0},(function(e,t){var n=(0,a.Z)(e,3),r=(n[0],n[1]),u=(n[2],vr(r));return i(u.popLast())}))}))}},{key:"Oe",value:function(e){var t=this,n=e.store(Tr.store);return n.jt((function(e,r){var i=ri(r),a=ii(t.k,i);return n.put(a)}))}}]),e}();function Ki(e){e.createObjectStore(Er.store,{keyPath:Er.keyPath}).createIndex(Er.documentTargetsIndex,Er.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(Tr.store,{keyPath:Tr.keyPath}).createIndex(Tr.queryTargetsIndexName,Tr.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(Sr.store)}var ji="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Gi=function(){function e(t,n,r,i,a,u,o,s,c,l){if((0,f.Z)(this,e),this.allowTabSynchronization=t,this.persistenceKey=n,this.clientId=r,this.Me=a,this.window=u,this.document=o,this.Fe=c,this.Le=l,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=function(e){return Promise.resolve()},!e.Pt())throw new P(O.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ri(this,i),this.Ge=n+"main",this.k=new Hr(s),this.ze=new Fr(this.Ge,11,new Bi(this.k)),this.He=new Ii(this.referenceDelegate,this.k),this.Jt=new fi,this.Je=function(e,t){return new Oi(e,t)}(this.k,this.Jt),this.Ye=new ui,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===l&&D("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}var t,n;return(0,h.Z)(e,[{key:"start",value:function(){var e=this;return this.Ze().then((function(){if(!e.isPrimary&&!e.allowTabSynchronization)throw new P(O.FAILED_PRECONDITION,ji);return e.tn(),e.en(),e.nn(),e.runTransaction("getHighestListenSequenceNumber","readonly",(function(t){return e.He.getHighestSequenceNumber(t)}))})).then((function(t){e.Be=new W(t,e.Fe)})).then((function(){e.Ue=!0})).catch((function(t){return e.ze&&e.ze.close(),Promise.reject(t)}))}},{key:"sn",value:function(e){var t=this;return this.We=function(){var n=(0,u.Z)(v().mark((function n(r){return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.started){n.next=2;break}return n.abrupt("return",e(r));case 2:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),e(this.isPrimary)}},{key:"setDatabaseDeletedListener",value:function(e){this.ze.xt(function(){var t=(0,u.Z)(v().mark((function t(n){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.t0=null===n.newVersion,!t.t0){t.next=4;break}return t.next=4,e();case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"setNetworkEnabled",value:function(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.Me.enqueueAndForget((0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.started,!e.t0){e.next=4;break}return e.next=4,t.Ze();case 4:case"end":return e.stop()}}),e)})))))}},{key:"Ze",value:function(){var e=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(function(t){return Qi(t).put(new _r(e.clientId,Date.now(),e.networkEnabled,e.inForeground)).next((function(){if(e.isPrimary)return e.rn(t).next((function(t){t||(e.isPrimary=!1,e.Me.enqueueRetryable((function(){return e.We(!1)})))}))})).next((function(){return e.on(t)})).next((function(n){return e.isPrimary&&!n?e.cn(t).next((function(){return!1})):!!n&&e.an(t).next((function(){return!0}))}))})).catch((function(t){if(Vr(t))return N("IndexedDbPersistence","Failed to extend owner lease: ",t),e.isPrimary;if(!e.allowTabSynchronization)throw t;return N("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((function(t){e.isPrimary!==t&&e.Me.enqueueRetryable((function(){return e.We(t)})),e.isPrimary=t}))}},{key:"rn",value:function(e){var t=this;return zi(e).get(pr.key).next((function(e){return Lr.resolve(t.un(e))}))}},{key:"hn",value:function(e){return Qi(e).delete(this.clientId)}},{key:"ln",value:(n=(0,u.Z)(v().mark((function e(){var t,n,r,i,a=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPrimary||this.fn(this.Qe,18e5)){e.next=6;break}return this.Qe=Date.now(),e.next=4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(function(e){var t=Gr(e,_r.store);return t.Bt().next((function(e){var n=a.dn(e,18e5),r=e.filter((function(e){return-1===n.indexOf(e)}));return Lr.forEach(r,(function(e){return t.delete(e.clientId)})).next((function(){return r}))}))})).catch((function(){return[]}));case 4:if(t=e.sent,this.Xe){n=w(t);try{for(n.s();!(r=n.n()).done;)i=r.value,this.Xe.removeItem(this.wn(i.clientId))}catch(u){n.e(u)}finally{n.f()}}case 6:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"nn",value:function(){var e=this;this.je=this.Me.enqueueAfterDelay("client_metadata_refresh",4e3,(function(){return e.Ze().then((function(){return e.ln()})).then((function(){return e.nn()}))}))}},{key:"un",value:function(e){return!!e&&e.ownerId===this.clientId}},{key:"on",value:function(e){var t=this;return this.Le?Lr.resolve(!0):zi(e).get(pr.key).next((function(n){if(null!==n&&t.fn(n.leaseTimestampMs,5e3)&&!t._n(n.ownerId)){if(t.un(n)&&t.networkEnabled)return!0;if(!t.un(n)){if(!n.allowTabSynchronization)throw new P(O.FAILED_PRECONDITION,ji);return!1}}return!(!t.networkEnabled||!t.inForeground)||Qi(e).Bt().next((function(e){return void 0===t.dn(e,5e3).find((function(e){if(t.clientId!==e.clientId){var n=!t.networkEnabled&&e.networkEnabled,r=!t.inForeground&&e.inForeground,i=t.networkEnabled===e.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(e){return t.isPrimary!==e&&N("IndexedDbPersistence","Client ".concat(e?"is":"is not"," eligible for a primary lease.")),e}))}},{key:"shutdown",value:(t=(0,u.Z)(v().mark((function e(){var t=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),e.next=7,this.ze.runTransaction("shutdown","readwrite",[pr.store,_r.store],(function(e){var n=new jr(e,W.I);return t.cn(n).next((function(){return t.hn(n)}))}));case 7:this.ze.close(),this.pn();case 9:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"dn",value:function(e,t){var n=this;return e.filter((function(e){return n.fn(e.updateTimeMs,t)&&!n._n(e.clientId)}))}},{key:"Tn",value:function(){var e=this;return this.runTransaction("getActiveClients","readonly",(function(t){return Qi(t).Bt().next((function(t){return e.dn(t,18e5).map((function(e){return e.clientId}))}))}))}},{key:"started",get:function(){return this.Ue}},{key:"getMutationQueue",value:function(e){return mi.Xt(e,this.k,this.Jt,this.referenceDelegate)}},{key:"getTargetCache",value:function(){return this.He}},{key:"getRemoteDocumentCache",value:function(){return this.Je}},{key:"getIndexManager",value:function(){return this.Jt}},{key:"getBundleCache",value:function(){return this.Ye}},{key:"runTransaction",value:function(e,t,n){var r=this;N("IndexedDbPersistence","Starting transaction:",e);var i,a="readonly"===t?"readonly":"readwrite";return this.ze.runTransaction(e,a,Zr,(function(a){return i=new jr(a,r.Be?r.Be.next():W.I),"readwrite-primary"===t?r.rn(i).next((function(e){return!!e||r.on(i)})).next((function(t){if(!t)throw D("Failed to obtain primary lease for action '".concat(e,"'.")),r.isPrimary=!1,r.Me.enqueueRetryable((function(){return r.We(!1)})),new P(O.FAILED_PRECONDITION,Cr);return n(i)})).next((function(e){return r.an(i).next((function(){return e}))})):r.En(i).next((function(){return n(i)}))})).then((function(e){return i.raiseOnCommittedEvent(),e}))}},{key:"En",value:function(e){var t=this;return zi(e).get(pr.key).next((function(e){if(null!==e&&t.fn(e.leaseTimestampMs,5e3)&&!t._n(e.ownerId)&&!t.un(e)&&!(t.Le||t.allowTabSynchronization&&e.allowTabSynchronization))throw new P(O.FAILED_PRECONDITION,ji)}))}},{key:"an",value:function(e){var t=new pr(this.clientId,this.allowTabSynchronization,Date.now());return zi(e).put(pr.key,t)}},{key:"cn",value:function(e){var t=this,n=zi(e);return n.get(pr.key).next((function(e){return t.un(e)?(N("IndexedDbPersistence","Releasing primary lease."),n.delete(pr.key)):Lr.resolve()}))}},{key:"fn",value:function(e,t){var n=Date.now();return!(e<n-t||e>n&&(D("Detected an update time that is in the future: ".concat(e," > ").concat(n)),1))}},{key:"tn",value:function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=function(){e.Me.enqueueAndForget((function(){return e.inForeground="visible"===e.document.visibilityState,e.Ze()}))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}},{key:"gn",value:function(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}},{key:"en",value:function(){var e,t=this;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.qe=function(){t.mn(),(0,g.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&t.Me.enterRestrictedMode(!0),t.Me.enqueueAndForget((function(){return t.shutdown()}))},this.window.addEventListener("pagehide",this.qe))}},{key:"yn",value:function(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}},{key:"_n",value:function(e){var t;try{var n=null!==(null===(t=this.Xe)||void 0===t?void 0:t.getItem(this.wn(e)));return N("IndexedDbPersistence","Client '".concat(e,"' ").concat(n?"is":"is not"," zombied in LocalStorage")),n}catch(e){return D("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}},{key:"mn",value:function(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(e){D("Failed to set zombie client id.",e)}}},{key:"pn",value:function(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(e){}}},{key:"wn",value:function(e){return"firestore_zombie_".concat(this.persistenceKey,"_").concat(e)}}],[{key:"Pt",value:function(){return Fr.Pt()}}]),e}();function zi(e){return Gr(e,pr.store)}function Qi(e){return Gr(e,_r.store)}function Wi(e,t){var n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}var Hi=(0,h.Z)((function e(t,n){(0,f.Z)(this,e),this.progress=t,this.In=n})),Yi=function(){function e(t,n,r){(0,f.Z)(this,e),this.Je=t,this.An=n,this.Jt=r}return(0,h.Z)(e,[{key:"Rn",value:function(e,t){var n=this;return this.An.getAllMutationBatchesAffectingDocumentKey(e,t).next((function(r){return n.bn(e,t,r)}))}},{key:"bn",value:function(e,t,n){return this.Je.getEntry(e,t).next((function(e){var t,r=w(n);try{for(r.s();!(t=r.n()).done;){t.value.applyToLocalView(e)}}catch(i){r.e(i)}finally{r.f()}return e}))}},{key:"Pn",value:function(e,t){e.forEach((function(e,n){var r,i=w(t);try{for(i.s();!(r=i.n()).done;){r.value.applyToLocalView(n)}}catch(a){i.e(a)}finally{i.f()}}))}},{key:"vn",value:function(e,t){var n=this;return this.Je.getEntries(e,t).next((function(t){return n.Vn(e,t).next((function(){return t}))}))}},{key:"Vn",value:function(e,t){var n=this;return this.An.getAllMutationBatchesAffectingDocumentKeys(e,t).next((function(e){return n.Pn(t,e)}))}},{key:"getDocumentsMatchingQuery",value:function(e,t,n){return function(e){return xe.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.Sn(e,t.path):dt(t)?this.Dn(e,t,n):this.Cn(e,t,n)}},{key:"Sn",value:function(e,t){return this.Rn(e,new xe(t)).next((function(e){var t=yn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}},{key:"Dn",value:function(e,t,n){var r=this,i=t.collectionGroup,a=yn();return this.Jt.getCollectionParents(e,i).next((function(u){return Lr.forEach(u,(function(u){var o=function(e,t){return new ut(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,u.child(i));return r.Cn(e,o,n).next((function(e){e.forEach((function(e,t){a=a.insert(e,t)}))}))})).next((function(){return a}))}))}},{key:"Cn",value:function(e,t,n){var r,i,a=this;return this.Je.getDocumentsMatchingQuery(e,t,n).next((function(n){return r=n,a.An.getAllMutationBatchesAffectingQuery(e,t)})).next((function(t){return i=t,a.Nn(e,i,r).next((function(e){r=e;var t,n=w(i);try{for(n.s();!(t=n.n()).done;){var a,u=t.value,o=w(u.mutations);try{for(o.s();!(a=o.n()).done;){var s=a.value,c=s.key,l=r.get(c);null==l&&(l=Ve.newInvalidDocument(c),r=r.insert(c,l)),jt(s,l,u.localWriteTime),l.isFoundDocument()||(r=r.remove(c))}}catch(f){o.e(f)}finally{o.f()}}}catch(f){n.e(f)}finally{n.f()}}))})).next((function(){return r.forEach((function(e,n){wt(t,n)||(r=r.remove(e))})),r}))}},{key:"Nn",value:function(e,t,n){var r,i=kn(),a=w(t);try{for(a.s();!(r=a.n()).done;){var u,o=w(r.value.mutations);try{for(o.s();!(u=o.n()).done;){var s=u.value;s instanceof Ht&&null===n.get(s.key)&&(i=i.add(s.key))}}catch(l){o.e(l)}finally{o.f()}}}catch(l){a.e(l)}finally{a.f()}var c=n;return this.Je.getEntries(e,i).next((function(e){return e.forEach((function(e,t){t.isFoundDocument()&&(c=c.insert(e,t))})),c}))}}]),e}(),Ji=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.targetId=t,this.fromCache=n,this.kn=r,this.xn=i}return(0,h.Z)(e,null,[{key:"$n",value:function(t,n){var r,i=kn(),a=kn(),u=w(n.docChanges);try{for(u.s();!(r=u.n()).done;){var o=r.value;switch(o.type){case 0:i=i.add(o.doc.key);break;case 1:a=a.add(o.doc.key)}}}catch(s){u.e(s)}finally{u.f()}return new e(t,n.fromCache,i,a)}}]),e}(),Xi=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,[{key:"On",value:function(e){this.Mn=e}},{key:"getDocumentsMatchingQuery",value:function(e,t,n,r){var i=this;return function(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}(t)||n.isEqual(te.min())?this.Fn(e,t):this.Mn.vn(e,r).next((function(a){var u=i.Ln(t,a);return(ct(t)||lt(t))&&i.Bn(t.limitType,u,r,n)?i.Fn(e,t):(A()<=m.in.DEBUG&&N("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),kt(t)),i.Mn.getDocumentsMatchingQuery(e,t,n).next((function(e){return u.forEach((function(t){e=e.insert(t.key,t)})),e})))}))}},{key:"Ln",value:function(e,t){var n=new ln(bt(e));return t.forEach((function(t,r){wt(e,r)&&(n=n.add(r))})),n}},{key:"Bn",value:function(e,t,n,r){if(n.size!==t.size)return!0;var i="F"===e?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}},{key:"Fn",value:function(e,t){return A()<=m.in.DEBUG&&N("QueryEngine","Using full collection scan to execute query:",kt(t)),this.Mn.getDocumentsMatchingQuery(e,t,te.min())}}]),e}(),$i=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.persistence=t,this.Un=n,this.k=i,this.qn=new on(J),this.Kn=new Mi((function(e){return Be(e)}),Ke),this.jn=te.min(),this.An=t.getMutationQueue(r),this.Qn=t.getRemoteDocumentCache(),this.He=t.getTargetCache(),this.Wn=new Yi(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=t.getBundleCache(),this.Un.On(this.Wn)}return(0,h.Z)(e,[{key:"collectGarbage",value:function(e){var t=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",(function(n){return e.collect(n,t.qn)}))}}]),e}();function ea(e,t,n,r){return new $i(e,t,n,r)}function ta(e,t){return na.apply(this,arguments)}function na(){return(na=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),i=r.An,a=r.Wn,e.next=4,r.persistence.runTransaction("Handle user change","readonly",(function(e){var t;return r.An.getAllMutationBatches(e).next((function(u){return t=u,i=r.persistence.getMutationQueue(n),a=new Yi(r.Qn,i,r.persistence.getIndexManager()),i.getAllMutationBatches(e)})).next((function(n){var r,i=[],u=[],o=kn(),s=w(t);try{for(s.s();!(r=s.n()).done;){var c=r.value;i.push(c.batchId);var l,f=w(c.mutations);try{for(f.s();!(l=f.n()).done;){var h=l.value;o=o.add(h.key)}}catch(k){f.e(k)}finally{f.f()}}}catch(k){s.e(k)}finally{s.f()}var d,v=w(n);try{for(v.s();!(d=v.n()).done;){var y=d.value;u.push(y.batchId);var p,m=w(y.mutations);try{for(m.s();!(p=m.n()).done;){var g=p.value;o=o.add(g.key)}}catch(k){m.e(k)}finally{m.f()}}}catch(k){v.e(k)}finally{v.f()}return a.vn(e,o).next((function(e){return{Gn:e,removedBatchIds:i,addedBatchIds:u}}))}))}));case 4:return u=e.sent,e.abrupt("return",(r.An=i,r.Wn=a,r.Un.On(r.Wn),u));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ra(e,t){var n=F(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(function(e){var r=t.batch.keys(),i=n.Qn.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){var i=n.batch,a=i.keys(),u=Lr.resolve();return a.forEach((function(e){u=u.next((function(){return r.getEntry(t,e)})).next((function(t){var a=n.docVersions.get(e);L(null!==a),t.version.compareTo(a)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&r.addEntry(t,n.commitVersion))}))})),u.next((function(){return e.An.removeMutationBatch(t,i)}))}(n,e,t,i).next((function(){return i.apply(e)})).next((function(){return n.An.performConsistencyCheck(e)})).next((function(){return n.Wn.vn(e,r)}))}))}function ia(e){var t=F(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(function(e){return t.He.getLastRemoteSnapshotVersion(e)}))}function aa(e,t){var n=F(e),r=t.snapshotVersion,i=n.qn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(function(e){var a=n.Qn.newChangeBuffer({trackRemovals:!0});i=n.qn;var u=[];t.targetChanges.forEach((function(a,o){var s=i.get(o);if(s){u.push(n.He.removeMatchingKeys(e,a.removedDocuments,o).next((function(){return n.He.addMatchingKeys(e,a.addedDocuments,o)})));var c=s.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(o)?c=c.withResumeToken(fe.EMPTY_BYTE_STRING,te.min()).withLastLimboFreeSnapshotVersion(te.min()):a.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(a.resumeToken,r)),i=i.insert(o,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)}(s,c,a)&&u.push(n.He.updateTargetData(e,c))}}));var o=dn();if(t.documentUpdates.forEach((function(r,i){t.resolvedLimboDocuments.has(r)&&u.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),u.push(ua(e,a,t.documentUpdates,r,void 0).next((function(e){o=e}))),!r.isEqual(te.min())){var s=n.He.getLastRemoteSnapshotVersion(e).next((function(t){return n.He.setTargetsMetadata(e,e.currentSequenceNumber,r)}));u.push(s)}return Lr.waitFor(u).next((function(){return a.apply(e)})).next((function(){return n.Wn.Vn(e,o)})).next((function(){return o}))})).then((function(e){return n.qn=i,e}))}function ua(e,t,n,r,i){var a=kn();return n.forEach((function(e){return a=a.add(e)})),t.getEntries(e,a).next((function(e){var a=dn();return n.forEach((function(n,u){var o=e.get(n),s=(null==i?void 0:i.get(n))||r;u.isNoDocument()&&u.version.isEqual(te.min())?(t.removeEntry(n,s),a=a.insert(n,u)):!o.isValidDocument()||u.version.compareTo(o.version)>0||0===u.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(u,s),a=a.insert(n,u)):N("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",u.version)})),a}))}function oa(e,t){var n=F(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(function(e){return void 0===t&&(t=-1),n.An.getNextMutationBatchAfterBatchId(e,t)}))}function sa(e,t){var n=F(e);return n.persistence.runTransaction("Allocate target","readwrite",(function(e){var r;return n.He.getTargetData(e,t).next((function(i){return i?(r=i,Lr.resolve(r)):n.He.allocateTargetId(e).next((function(i){return r=new Wr(t,i,0,e.currentSequenceNumber),n.He.addTargetData(e,r).next((function(){return r}))}))}))})).then((function(e){var r=n.qn.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qn=n.qn.insert(e.targetId,e),n.Kn.set(t,e.targetId)),e}))}function ca(e,t,n){return la.apply(this,arguments)}function la(){return(la=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=F(t),a=i.qn.get(n),u=r?"readwrite":"readwrite-primary",e.prev=1,e.t0=r,e.t0){e.next=6;break}return e.next=6,i.persistence.runTransaction("Release target",u,(function(e){return i.persistence.referenceDelegate.removeTarget(e,a)}));case 6:e.next=13;break;case 8:if(e.prev=8,e.t1=e.catch(1),Vr(e.t1)){e.next=12;break}throw e.t1;case 12:N("LocalStore","Failed to update sequence numbers for target ".concat(n,": ").concat(e.t1));case 13:i.qn=i.qn.remove(n),i.Kn.delete(a.target);case 14:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function fa(e,t,n){var r=F(e),i=te.min(),a=kn();return r.persistence.runTransaction("Execute query","readonly",(function(e){return function(e,t,n){var r=F(e),i=r.Kn.get(n);return void 0!==i?Lr.resolve(r.qn.get(i)):r.He.getTargetData(t,n)}(r,e,yt(t)).next((function(t){if(t)return i=t.lastLimboFreeSnapshotVersion,r.He.getMatchingKeysForTargetId(e,t.targetId).next((function(e){a=e}))})).next((function(){return r.Un.getDocumentsMatchingQuery(e,t,n?i:te.min(),n?a:kn())})).next((function(e){return{documents:e,zn:a}}))}))}function ha(e,t){var n=F(e),r=F(n.He),i=n.qn.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(function(e){return r.Et(e,t).next((function(e){return e?e.target:null}))}))}function da(e){var t=F(e);return t.persistence.runTransaction("Get new document changes","readonly",(function(e){return function(e,t,n){var r=F(e),i=dn(),a=Xr(n),u=qi(t),o=IDBKeyRange.lowerBound(a,!0);return u.jt({index:xr.readTimeIndex,range:o},(function(e,t){var n=Yr(r.k,t);i=i.insert(n.key,n),a=t.readTime})).next((function(){return{In:i,readTime:$r(a)}}))}(t.Qn,e,t.jn)})).then((function(e){var n=e.In,r=e.readTime;return t.jn=r,n}))}function va(e){return ya.apply(this,arguments)}function ya(){return(ya=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=F(t),e.abrupt("return",n.persistence.runTransaction("Synchronize last document change read time","readonly",(function(e){return function(e){var t=qi(e),n=te.min();return t.jt({index:xr.readTimeIndex,reverse:!0},(function(e,t,r){t.readTime&&(n=$r(t.readTime)),r.done()})).next((function(){return n}))}(e)})).then((function(e){n.jn=e})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pa(e,t,n,r){return ma.apply(this,arguments)}function ma(){return(ma=(0,u.Z)(v().mark((function e(t,n,r,i){var a,u,o,s,c,l,f,h,d,y;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=F(t),u=kn(),o=dn(),s=mn(),c=w(r);try{for(c.s();!(l=c.n()).done;)f=l.value,h=n.Hn(f.metadata.name),f.document&&(u=u.add(h)),o=o.insert(h,n.Jn(f)),s=s.insert(h,n.Yn(f.metadata.readTime))}catch(v){c.e(v)}finally{c.f()}return d=a.Qn.newChangeBuffer({trackRemovals:!0}),e.next=7,sa(a,function(e){return yt(st(ue.fromString("__bundle__/docs/".concat(e))))}(i));case 7:return y=e.sent,e.abrupt("return",a.persistence.runTransaction("Apply bundle documents","readwrite",(function(e){return ua(e,d,o,te.min(),s).next((function(t){return d.apply(e),t})).next((function(t){return a.He.removeMatchingKeysForTargetId(e,y.targetId).next((function(){return a.He.addMatchingKeys(e,u,y.targetId)})).next((function(){return a.Wn.Vn(e,t)})).next((function(){return t}))}))})));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ga(e,t){return ka.apply(this,arguments)}function ka(){return ka=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u=arguments;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=u.length>2&&void 0!==u[2]?u[2]:kn(),e.next=3,sa(t,yt(ai(n.bundledQuery)));case 3:return i=e.sent,a=F(t),e.abrupt("return",a.persistence.runTransaction("Save named query","readwrite",(function(e){var t=On(n.readTime);if(i.snapshotVersion.compareTo(t)>=0)return a.Ye.saveNamedQuery(e,n);var u=i.withResumeToken(fe.EMPTY_BYTE_STRING,t);return a.qn=a.qn.insert(u.targetId,u),a.He.updateTargetData(e,u).next((function(){return a.He.removeMatchingKeysForTargetId(e,i.targetId)})).next((function(){return a.He.addMatchingKeys(e,r,i.targetId)})).next((function(){return a.Ye.saveNamedQuery(e,n)}))})));case 6:case"end":return e.stop()}}),e)}))),ka.apply(this,arguments)}var wa=function(){function e(t){(0,f.Z)(this,e),this.k=t,this.Xn=new Map,this.Zn=new Map}return(0,h.Z)(e,[{key:"getBundleMetadata",value:function(e,t){return Lr.resolve(this.Xn.get(t))}},{key:"saveBundleMetadata",value:function(e,t){var n;return this.Xn.set(t.id,{id:(n=t).id,version:n.version,createTime:On(n.createTime)}),Lr.resolve()}},{key:"getNamedQuery",value:function(e,t){return Lr.resolve(this.Zn.get(t))}},{key:"saveNamedQuery",value:function(e,t){return this.Zn.set(t.name,function(e){return{name:e.name,query:ai(e.bundledQuery),readTime:On(e.readTime)}}(t)),Lr.resolve()}}]),e}(),ba=function(){function e(){(0,f.Z)(this,e),this.ts=new ln(xa.es),this.ns=new ln(xa.ss)}return(0,h.Z)(e,[{key:"isEmpty",value:function(){return this.ts.isEmpty()}},{key:"addReference",value:function(e,t){var n=new xa(e,t);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}},{key:"rs",value:function(e,t){var n=this;e.forEach((function(e){return n.addReference(e,t)}))}},{key:"removeReference",value:function(e,t){this.os(new xa(e,t))}},{key:"cs",value:function(e,t){var n=this;e.forEach((function(e){return n.removeReference(e,t)}))}},{key:"us",value:function(e){var t=this,n=new xe(new ue([])),r=new xa(n,e),i=new xa(n,e+1),a=[];return this.ns.forEachInRange([r,i],(function(e){t.os(e),a.push(e.key)})),a}},{key:"hs",value:function(){var e=this;this.ts.forEach((function(t){return e.os(t)}))}},{key:"os",value:function(e){this.ts=this.ts.delete(e),this.ns=this.ns.delete(e)}},{key:"ls",value:function(e){var t=new xe(new ue([])),n=new xa(t,e),r=new xa(t,e+1),i=kn();return this.ns.forEachInRange([n,r],(function(e){i=i.add(e.key)})),i}},{key:"containsKey",value:function(e){var t=new xa(e,0),n=this.ts.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}]),e}(),xa=function(){function e(t,n){(0,f.Z)(this,e),this.key=t,this.fs=n}return(0,h.Z)(e,null,[{key:"es",value:function(e,t){return xe.comparator(e.key,t.key)||J(e.fs,t.fs)}},{key:"ss",value:function(e,t){return J(e.fs,t.fs)||xe.comparator(e.key,t.key)}}]),e}(),Ia=function(){function e(t,n){(0,f.Z)(this,e),this.Jt=t,this.referenceDelegate=n,this.An=[],this.ds=1,this.ws=new ln(xa.es)}return(0,h.Z)(e,[{key:"checkEmpty",value:function(e){return Lr.resolve(0===this.An.length)}},{key:"addMutationBatch",value:function(e,t,n,r){var i=this.ds;this.ds++,this.An.length>0&&this.An[this.An.length-1];var a=new zr(i,t,n,r);this.An.push(a);var u,o=w(r);try{for(o.s();!(u=o.n()).done;){var s=u.value;this.ws=this.ws.add(new xa(s.key,i)),this.Jt.addToCollectionParentIndex(e,s.key.path.popLast())}}catch(c){o.e(c)}finally{o.f()}return Lr.resolve(a)}},{key:"lookupMutationBatch",value:function(e,t){return Lr.resolve(this._s(t))}},{key:"getNextMutationBatchAfterBatchId",value:function(e,t){var n=t+1,r=this.gs(n),i=r<0?0:r;return Lr.resolve(this.An.length>i?this.An[i]:null)}},{key:"getHighestUnacknowledgedBatchId",value:function(){return Lr.resolve(0===this.An.length?-1:this.ds-1)}},{key:"getAllMutationBatches",value:function(e){return Lr.resolve(this.An.slice())}},{key:"getAllMutationBatchesAffectingDocumentKey",value:function(e,t){var n=this,r=new xa(t,0),i=new xa(t,Number.POSITIVE_INFINITY),a=[];return this.ws.forEachInRange([r,i],(function(e){var t=n._s(e.fs);a.push(t)})),Lr.resolve(a)}},{key:"getAllMutationBatchesAffectingDocumentKeys",value:function(e,t){var n=this,r=new ln(J);return t.forEach((function(e){var t=new xa(e,0),i=new xa(e,Number.POSITIVE_INFINITY);n.ws.forEachInRange([t,i],(function(e){r=r.add(e.fs)}))})),Lr.resolve(this.ys(r))}},{key:"getAllMutationBatchesAffectingQuery",value:function(e,t){var n=t.path,r=n.length+1,i=n;xe.isDocumentKey(i)||(i=i.child(""));var a=new xa(new xe(i),0),u=new ln(J);return this.ws.forEachWhile((function(e){var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(u=u.add(e.fs)),!0)}),a),Lr.resolve(this.ys(u))}},{key:"ys",value:function(e){var t=this,n=[];return e.forEach((function(e){var r=t._s(e);null!==r&&n.push(r)})),n}},{key:"removeMutationBatch",value:function(e,t){var n=this;L(0===this.ps(t.batchId,"removed")),this.An.shift();var r=this.ws;return Lr.forEach(t.mutations,(function(i){var a=new xa(i.key,t.batchId);return r=r.delete(a),n.referenceDelegate.markPotentiallyOrphaned(e,i.key)})).next((function(){n.ws=r}))}},{key:"ee",value:function(e){}},{key:"containsKey",value:function(e,t){var n=new xa(t,0),r=this.ws.firstAfterOrEqual(n);return Lr.resolve(t.isEqual(r&&r.key))}},{key:"performConsistencyCheck",value:function(e){return this.An.length,Lr.resolve()}},{key:"ps",value:function(e,t){return this.gs(e)}},{key:"gs",value:function(e){return 0===this.An.length?0:e-this.An[0].batchId}},{key:"_s",value:function(e){var t=this.gs(e);return t<0||t>=this.An.length?null:this.An[t]}}]),e}(),Ta=function(){function e(t,n){(0,f.Z)(this,e),this.Jt=t,this.Ts=n,this.docs=new on(xe.comparator),this.size=0}return(0,h.Z)(e,[{key:"addEntry",value:function(e,t,n){var r=t.key,i=this.docs.get(r),a=i?i.size:0,u=this.Ts(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:u,readTime:n}),this.size+=u-a,this.Jt.addToCollectionParentIndex(e,r.path.popLast())}},{key:"removeEntry",value:function(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}},{key:"getEntry",value:function(e,t){var n=this.docs.get(t);return Lr.resolve(n?n.document.mutableCopy():Ve.newInvalidDocument(t))}},{key:"getEntries",value:function(e,t){var n=this,r=dn();return t.forEach((function(e){var t=n.docs.get(e);r=r.insert(e,t?t.document.mutableCopy():Ve.newInvalidDocument(e))})),Lr.resolve(r)}},{key:"getDocumentsMatchingQuery",value:function(e,t,n){for(var r=dn(),i=new xe(t.path.child("")),a=this.docs.getIteratorFrom(i);a.hasNext();){var u=a.getNext(),o=u.key,s=u.value,c=s.document,l=s.readTime;if(!t.path.isPrefixOf(o.path))break;l.compareTo(n)<=0||wt(t,c)&&(r=r.insert(c.key,c.mutableCopy()))}return Lr.resolve(r)}},{key:"Es",value:function(e,t){return Lr.forEach(this.docs,(function(e){return t(e)}))}},{key:"newChangeBuffer",value:function(e){return new Ea(this)}},{key:"getSize",value:function(e){return Lr.resolve(this.size)}}]),e}(),Ea=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).De=e,r}return(0,h.Z)(n,[{key:"applyChanges",value:function(e){var t=this,n=[];return this.changes.forEach((function(r,i){i.document.isValidDocument()?n.push(t.De.addEntry(e,i.document,t.getReadTime(r))):t.De.removeEntry(r)})),Lr.waitFor(n)}},{key:"getFromCache",value:function(e,t){return this.De.getEntry(e,t)}},{key:"getAllFromCache",value:function(e,t){return this.De.getEntries(e,t)}}]),n}(Fi),Sa=function(){function e(t){(0,f.Z)(this,e),this.persistence=t,this.Is=new Mi((function(e){return Be(e)}),Ke),this.lastRemoteSnapshotVersion=te.min(),this.highestTargetId=0,this.As=0,this.Rs=new ba,this.targetCount=0,this.bs=xi.ie()}return(0,h.Z)(e,[{key:"forEachTarget",value:function(e,t){return this.Is.forEach((function(e,n){return t(n)})),Lr.resolve()}},{key:"getLastRemoteSnapshotVersion",value:function(e){return Lr.resolve(this.lastRemoteSnapshotVersion)}},{key:"getHighestSequenceNumber",value:function(e){return Lr.resolve(this.As)}},{key:"allocateTargetId",value:function(e){return this.highestTargetId=this.bs.next(),Lr.resolve(this.highestTargetId)}},{key:"setTargetsMetadata",value:function(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.As&&(this.As=t),Lr.resolve()}},{key:"ae",value:function(e){this.Is.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.bs=new xi(t),this.highestTargetId=t),e.sequenceNumber>this.As&&(this.As=e.sequenceNumber)}},{key:"addTargetData",value:function(e,t){return this.ae(t),this.targetCount+=1,Lr.resolve()}},{key:"updateTargetData",value:function(e,t){return this.ae(t),Lr.resolve()}},{key:"removeTargetData",value:function(e,t){return this.Is.delete(t.target),this.Rs.us(t.targetId),this.targetCount-=1,Lr.resolve()}},{key:"removeTargets",value:function(e,t,n){var r=this,i=0,a=[];return this.Is.forEach((function(u,o){o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r.Is.delete(u),a.push(r.removeMatchingKeysForTargetId(e,o.targetId)),i++)})),Lr.waitFor(a).next((function(){return i}))}},{key:"getTargetCount",value:function(e){return Lr.resolve(this.targetCount)}},{key:"getTargetData",value:function(e,t){var n=this.Is.get(t)||null;return Lr.resolve(n)}},{key:"addMatchingKeys",value:function(e,t,n){return this.Rs.rs(t,n),Lr.resolve()}},{key:"removeMatchingKeys",value:function(e,t,n){this.Rs.cs(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((function(t){i.push(r.markPotentiallyOrphaned(e,t))})),Lr.waitFor(i)}},{key:"removeMatchingKeysForTargetId",value:function(e,t){return this.Rs.us(t),Lr.resolve()}},{key:"getMatchingKeysForTargetId",value:function(e,t){var n=this.Rs.ls(t);return Lr.resolve(n)}},{key:"containsKey",value:function(e,t){return Lr.resolve(this.Rs.containsKey(t))}}]),e}(),Aa=function(){function e(t,n){var r=this;(0,f.Z)(this,e),this.Ps={},this.Be=new W(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=t(this),this.He=new Sa(this),this.Jt=new ci,this.Je=function(e,t){return new Ta(e,(function(e){return r.referenceDelegate.vs(e)}))}(this.Jt),this.k=new Hr(n),this.Ye=new wa(this.k)}return(0,h.Z)(e,[{key:"start",value:function(){return Promise.resolve()}},{key:"shutdown",value:function(){return this.Ue=!1,Promise.resolve()}},{key:"started",get:function(){return this.Ue}},{key:"setDatabaseDeletedListener",value:function(){}},{key:"setNetworkEnabled",value:function(){}},{key:"getIndexManager",value:function(){return this.Jt}},{key:"getMutationQueue",value:function(e){var t=this.Ps[e.toKey()];return t||(t=new Ia(this.Jt,this.referenceDelegate),this.Ps[e.toKey()]=t),t}},{key:"getTargetCache",value:function(){return this.He}},{key:"getRemoteDocumentCache",value:function(){return this.Je}},{key:"getBundleCache",value:function(){return this.Ye}},{key:"runTransaction",value:function(e,t,n){var r=this;N("MemoryPersistence","Starting transaction:",e);var i=new _a(this.Be.next());return this.referenceDelegate.Vs(),n(i).next((function(e){return r.referenceDelegate.Ss(i).next((function(){return e}))})).toPromise().then((function(e){return i.raiseOnCommittedEvent(),e}))}},{key:"Ds",value:function(e,t){return Lr.or(Object.values(this.Ps).map((function(n){return function(){return n.containsKey(e,t)}})))}}]),e}(),_a=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).currentSequenceNumber=e,r}return(0,h.Z)(n)}(Rr),Na=function(){function e(t){(0,f.Z)(this,e),this.persistence=t,this.Cs=new ba,this.Ns=null}return(0,h.Z)(e,[{key:"xs",get:function(){if(this.Ns)return this.Ns;throw R()}},{key:"addReference",value:function(e,t,n){return this.Cs.addReference(n,t),this.xs.delete(n.toString()),Lr.resolve()}},{key:"removeReference",value:function(e,t,n){return this.Cs.removeReference(n,t),this.xs.add(n.toString()),Lr.resolve()}},{key:"markPotentiallyOrphaned",value:function(e,t){return this.xs.add(t.toString()),Lr.resolve()}},{key:"removeTarget",value:function(e,t){var n=this;this.Cs.us(t.targetId).forEach((function(e){return n.xs.add(e.toString())}));var r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next((function(e){e.forEach((function(e){return n.xs.add(e.toString())}))})).next((function(){return r.removeTargetData(e,t)}))}},{key:"Vs",value:function(){this.Ns=new Set}},{key:"Ss",value:function(e){var t=this,n=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Lr.forEach(this.xs,(function(r){var i=xe.fromPath(r);return t.$s(e,i).next((function(e){e||n.removeEntry(i)}))})).next((function(){return t.Ns=null,n.apply(e)}))}},{key:"updateLimboDocument",value:function(e,t){var n=this;return this.$s(e,t).next((function(e){e?n.xs.delete(t.toString()):n.xs.add(t.toString())}))}},{key:"vs",value:function(e){return 0}},{key:"$s",value:function(e,t){var n=this;return Lr.or([function(){return Lr.resolve(n.Cs.containsKey(t))},function(){return n.persistence.getTargetCache().containsKey(e,t)},function(){return n.persistence.Ds(e,t)}])}}],[{key:"ks",value:function(t){return new e(t)}}]),e}();function Da(e,t){return"firestore_clients_".concat(e,"_").concat(t)}function Za(e,t,n){var r="firestore_mutations_".concat(e,"_").concat(n);return t.isAuthenticated()&&(r+="_".concat(t.uid)),r}function Ca(e,t){return"firestore_targets_".concat(e,"_").concat(t)}var Ra=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.user=t,this.batchId=n,this.state=r,this.error=i}return(0,h.Z)(e,[{key:"Ms",value:function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}],[{key:"Os",value:function(t,n,r){var i,a=JSON.parse(r),u="object"==typeof a&&-1!==["pending","acknowledged","rejected"].indexOf(a.state)&&(void 0===a.error||"object"==typeof a.error);return u&&a.error&&((u="string"==typeof a.error.message&&"string"==typeof a.error.code)&&(i=new P(a.error.code,a.error.message))),u?new e(t,n,a.state,i):(D("SharedClientState","Failed to parse mutation state for ID '".concat(n,"': ").concat(r)),null)}}]),e}(),La=function(){function e(t,n,r){(0,f.Z)(this,e),this.targetId=t,this.state=n,this.error=r}return(0,h.Z)(e,[{key:"Ms",value:function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}],[{key:"Os",value:function(t,n){var r,i=JSON.parse(n),a="object"==typeof i&&-1!==["not-current","current","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return a&&i.error&&((a="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(r=new P(i.error.code,i.error.message))),a?new e(t,i.state,r):(D("SharedClientState","Failed to parse target state for ID '".concat(t,"': ").concat(n)),null)}}]),e}(),Ma=function(){function e(t,n){(0,f.Z)(this,e),this.clientId=t,this.activeTargetIds=n}return(0,h.Z)(e,null,[{key:"Os",value:function(t,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,a=bn(),u=0;i&&u<r.activeTargetIds.length;++u)i=be(r.activeTargetIds[u]),a=a.add(r.activeTargetIds[u]);return i?new e(t,a):(D("SharedClientState","Failed to parse client data for instance '".concat(t,"': ").concat(n)),null)}}]),e}(),Fa=function(){function e(t,n){(0,f.Z)(this,e),this.clientId=t,this.onlineState=n}return(0,h.Z)(e,null,[{key:"Os",value:function(t){var n=JSON.parse(t);return"object"==typeof n&&-1!==["Unknown","Online","Offline"].indexOf(n.onlineState)&&"string"==typeof n.clientId?new e(n.clientId,n.onlineState):(D("SharedClientState","Failed to parse online state: ".concat(t)),null)}}]),e}(),Oa=function(){function e(){(0,f.Z)(this,e),this.activeTargetIds=bn()}return(0,h.Z)(e,[{key:"Fs",value:function(e){this.activeTargetIds=this.activeTargetIds.add(e)}},{key:"Ls",value:function(e){this.activeTargetIds=this.activeTargetIds.delete(e)}},{key:"Ms",value:function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}]),e}(),Pa=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.window=t,this.Me=n,this.persistenceKey=r,this.Bs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new on(J),this.started=!1,this.js=[];var u=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=a,this.Qs=Da(this.persistenceKey,this.Bs),this.Ws=function(e){return"firestore_sequence_number_".concat(e)}(this.persistenceKey),this.Ks=this.Ks.insert(this.Bs,new Oa),this.Gs=new RegExp("^firestore_clients_".concat(u,"_([^_]*)$")),this.zs=new RegExp("^firestore_mutations_".concat(u,"_(\\d+)(?:_(.*))?$")),this.Hs=new RegExp("^firestore_targets_".concat(u,"_(\\d+)$")),this.Js=function(e){return"firestore_online_state_".concat(e)}(this.persistenceKey),this.Ys=function(e){return"firestore_bundle_loaded_".concat(e)}(this.persistenceKey),this.window.addEventListener("storage",this.Us)}var t,n;return(0,h.Z)(e,[{key:"start",value:(n=(0,u.Z)(v().mark((function e(){var t,n,r,i,a,u,o,s,c,l,f,h=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.syncEngine.Tn();case 2:t=e.sent,n=w(t),e.prev=4,n.s();case 6:if((r=n.n()).done){e.next=14;break}if((i=r.value)!==this.Bs){e.next=10;break}return e.abrupt("continue",12);case 10:(a=this.getItem(Da(this.persistenceKey,i)))&&(u=Ma.Os(i,a))&&(this.Ks=this.Ks.insert(u.clientId,u));case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),n.e(e.t0);case 19:return e.prev=19,n.f(),e.finish(19);case 22:this.Xs(),(o=this.storage.getItem(this.Js))&&(s=this.Zs(o))&&this.ti(s),c=w(this.js);try{for(c.s();!(l=c.n()).done;)f=l.value,this.qs(f)}catch(d){c.e(d)}finally{c.f()}this.js=[],this.window.addEventListener("pagehide",(function(){return h.shutdown()})),this.started=!0;case 28:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))),function(){return n.apply(this,arguments)})},{key:"writeSequenceNumber",value:function(e){this.setItem(this.Ws,JSON.stringify(e))}},{key:"getAllActiveQueryTargets",value:function(){return this.ei(this.Ks)}},{key:"isActiveQueryTarget",value:function(e){var t=!1;return this.Ks.forEach((function(n,r){r.activeTargetIds.has(e)&&(t=!0)})),t}},{key:"addPendingMutation",value:function(e){this.ni(e,"pending")}},{key:"updateMutationState",value:function(e,t,n){this.ni(e,t,n),this.si(e)}},{key:"addLocalQueryTarget",value:function(e){var t="not-current";if(this.isActiveQueryTarget(e)){var n=this.storage.getItem(Ca(this.persistenceKey,e));if(n){var r=La.Os(e,n);r&&(t=r.state)}}return this.ii.Fs(e),this.Xs(),t}},{key:"removeLocalQueryTarget",value:function(e){this.ii.Ls(e),this.Xs()}},{key:"isLocalQueryTarget",value:function(e){return this.ii.activeTargetIds.has(e)}},{key:"clearQueryState",value:function(e){this.removeItem(Ca(this.persistenceKey,e))}},{key:"updateQueryState",value:function(e,t,n){this.ri(e,t,n)}},{key:"handleUserChange",value:function(e,t,n){var r=this;t.forEach((function(e){r.si(e)})),this.currentUser=e,n.forEach((function(e){r.addPendingMutation(e)}))}},{key:"setOnlineState",value:function(e){this.oi(e)}},{key:"notifyBundleLoaded",value:function(){this.ci()}},{key:"shutdown",value:function(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}},{key:"getItem",value:function(e){var t=this.storage.getItem(e);return N("SharedClientState","READ",e,t),t}},{key:"setItem",value:function(e,t){N("SharedClientState","SET",e,t),this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){N("SharedClientState","REMOVE",e),this.storage.removeItem(e)}},{key:"qs",value:function(e){var t=this,n=e;if(n.storageArea===this.storage){if(N("SharedClientState","EVENT",n.key,n.newValue),n.key===this.Qs)return void D("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Me.enqueueRetryable((0,u.Z)(v().mark((function e(){var r,i,a,u,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.started){e.next=41;break}if(null===n.key){e.next=39;break}if(!t.Gs.test(n.key)){e.next=11;break}if(null!=n.newValue){e.next=6;break}return r=t.ai(n.key),e.abrupt("return",t.ui(r,null));case 6:if(!(i=t.hi(n.key,n.newValue))){e.next=9;break}return e.abrupt("return",t.ui(i.clientId,i));case 9:e.next=39;break;case 11:if(!t.zs.test(n.key)){e.next=18;break}if(null===n.newValue){e.next=16;break}if(!(a=t.li(n.key,n.newValue))){e.next=16;break}return e.abrupt("return",t.fi(a));case 16:e.next=39;break;case 18:if(!t.Hs.test(n.key)){e.next=25;break}if(null===n.newValue){e.next=23;break}if(!(u=t.di(n.key,n.newValue))){e.next=23;break}return e.abrupt("return",t.wi(u));case 23:e.next=39;break;case 25:if(n.key!==t.Js){e.next=32;break}if(null===n.newValue){e.next=30;break}if(!(o=t.Zs(n.newValue))){e.next=30;break}return e.abrupt("return",t.ti(o));case 30:e.next=39;break;case 32:if(n.key!==t.Ws){e.next=37;break}s=function(e){var t=W.I;if(null!=e)try{var n=JSON.parse(e);L("number"==typeof n),t=n}catch(e){D("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(n.newValue),s!==W.I&&t.sequenceNumberHandler(s),e.next=39;break;case 37:if(n.key!==t.Ys){e.next=39;break}return e.abrupt("return",t.syncEngine._i());case 39:e.next=42;break;case 41:t.js.push(n);case 42:case"end":return e.stop()}}),e)}))))}}},{key:"ii",get:function(){return this.Ks.get(this.Bs)}},{key:"Xs",value:function(){this.setItem(this.Qs,this.ii.Ms())}},{key:"ni",value:function(e,t,n){var r=new Ra(this.currentUser,e,t,n),i=Za(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Ms())}},{key:"si",value:function(e){var t=Za(this.persistenceKey,this.currentUser,e);this.removeItem(t)}},{key:"oi",value:function(e){var t={clientId:this.Bs,onlineState:e};this.storage.setItem(this.Js,JSON.stringify(t))}},{key:"ri",value:function(e,t,n){var r=Ca(this.persistenceKey,e),i=new La(e,t,n);this.setItem(r,i.Ms())}},{key:"ci",value:function(){this.setItem(this.Ys,"value-not-used")}},{key:"ai",value:function(e){var t=this.Gs.exec(e);return t?t[1]:null}},{key:"hi",value:function(e,t){var n=this.ai(e);return Ma.Os(n,t)}},{key:"li",value:function(e,t){var n=this.zs.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Ra.Os(new T(i),r,t)}},{key:"di",value:function(e,t){var n=this.Hs.exec(e),r=Number(n[1]);return La.Os(r,t)}},{key:"Zs",value:function(e){return Fa.Os(e)}},{key:"fi",value:(t=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.user.uid!==this.currentUser.uid){e.next=2;break}return e.abrupt("return",this.syncEngine.mi(t.batchId,t.state,t.error));case 2:N("SharedClientState","Ignoring mutation for non-active user ".concat(t.user.uid));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"wi",value:function(e){return this.syncEngine.gi(e.targetId,e.state,e.error)}},{key:"ui",value:function(e,t){var n=this,r=t?this.Ks.insert(e,t):this.Ks.remove(e),i=this.ei(this.Ks),a=this.ei(r),u=[],o=[];return a.forEach((function(e){i.has(e)||u.push(e)})),i.forEach((function(e){a.has(e)||o.push(e)})),this.syncEngine.yi(u,o).then((function(){n.Ks=r}))}},{key:"ti",value:function(e){this.Ks.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}},{key:"ei",value:function(e){var t=bn();return e.forEach((function(e,n){t=t.unionWith(n.activeTargetIds)})),t}}],[{key:"Pt",value:function(e){return!(!e||!e.localStorage)}}]),e}(),Va=function(){function e(){(0,f.Z)(this,e),this.pi=new Oa,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}return(0,h.Z)(e,[{key:"addPendingMutation",value:function(e){}},{key:"updateMutationState",value:function(e,t,n){}},{key:"addLocalQueryTarget",value:function(e){return this.pi.Fs(e),this.Ti[e]||"not-current"}},{key:"updateQueryState",value:function(e,t,n){this.Ti[e]=t}},{key:"removeLocalQueryTarget",value:function(e){this.pi.Ls(e)}},{key:"isLocalQueryTarget",value:function(e){return this.pi.activeTargetIds.has(e)}},{key:"clearQueryState",value:function(e){delete this.Ti[e]}},{key:"getAllActiveQueryTargets",value:function(){return this.pi.activeTargetIds}},{key:"isActiveQueryTarget",value:function(e){return this.pi.activeTargetIds.has(e)}},{key:"start",value:function(){return this.pi=new Oa,Promise.resolve()}},{key:"handleUserChange",value:function(e,t,n){}},{key:"setOnlineState",value:function(e){}},{key:"shutdown",value:function(){}},{key:"writeSequenceNumber",value:function(e){}},{key:"notifyBundleLoaded",value:function(){}}]),e}(),qa=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,[{key:"Ei",value:function(e){}},{key:"shutdown",value:function(){}}]),e}(),Ua=function(){function e(){var t=this;(0,f.Z)(this,e),this.Ii=function(){return t.Ai()},this.Ri=function(){return t.bi()},this.Pi=[],this.vi()}return(0,h.Z)(e,[{key:"Ei",value:function(e){this.Pi.push(e)}},{key:"shutdown",value:function(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}},{key:"vi",value:function(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}},{key:"Ai",value:function(){N("ConnectivityMonitor","Network connectivity changed: AVAILABLE");var e,t=w(this.Pi);try{for(t.s();!(e=t.n()).done;){(0,e.value)(0)}}catch(n){t.e(n)}finally{t.f()}}},{key:"bi",value:function(){N("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");var e,t=w(this.Pi);try{for(t.s();!(e=t.n()).done;){(0,e.value)(1)}}catch(n){t.e(n)}finally{t.f()}}}],[{key:"Pt",value:function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}]),e}(),Ba={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"},Ka=function(){function e(t){(0,f.Z)(this,e),this.Vi=t.Vi,this.Si=t.Si}return(0,h.Z)(e,[{key:"Di",value:function(e){this.Ci=e}},{key:"Ni",value:function(e){this.ki=e}},{key:"onMessage",value:function(e){this.xi=e}},{key:"close",value:function(){this.Si()}},{key:"send",value:function(e){this.Vi(e)}},{key:"$i",value:function(){this.Ci()}},{key:"Oi",value:function(e){this.ki(e)}},{key:"Mi",value:function(e){this.xi(e)}}]),e}(),ja=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this,e)).forceLongPolling=e.forceLongPolling,r.autoDetectLongPolling=e.autoDetectLongPolling,r.useFetchStreams=e.useFetchStreams,r}return(0,h.Z)(n,[{key:"Ki",value:function(e,t,n,r){return new Promise((function(i,a){var u=new k.JJ;u.listenOnce(k.tw.COMPLETE,(function(){try{switch(u.getLastErrorCode()){case k.jK.NO_ERROR:var t=u.getResponseJson();N("Connection","XHR received:",JSON.stringify(t)),i(t);break;case k.jK.TIMEOUT:N("Connection",'RPC "'+e+'" timed out'),a(new P(O.DEADLINE_EXCEEDED,"Request time out"));break;case k.jK.HTTP_ERROR:var n=u.getStatus();if(N("Connection",'RPC "'+e+'" failed with status:',n,"response text:",u.getResponseText()),n>0){var r=u.getResponseJson().error;if(r&&r.status&&r.message){var o=function(e){var t=e.toLowerCase().replace(/_/g,"-");return Object.values(O).indexOf(t)>=0?t:O.UNKNOWN}(r.status);a(new P(o,r.message))}else a(new P(O.UNKNOWN,"Server responded with status "+u.getStatus()))}else a(new P(O.UNAVAILABLE,"Connection failed."));break;default:R()}}finally{N("Connection",'RPC "'+e+'" completed.')}}));var o=JSON.stringify(r);u.send(t,"POST",o,n,15)}))}},{key:"Qi",value:function(e,t,n){var r=[this.Fi,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,k.UE)(),a=(0,k.FJ)(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/".concat(this.databaseId.projectId,"/databases/").concat(this.databaseId.database)},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(u.xmlHttpFactory=new k.zI({})),this.qi(u.initMessageHeaders,t,n),(0,g.uI)()||(0,g.b$)()||(0,g.d)()||(0,g.w1)()||(0,g.Mn)()||(0,g.ru)()||(u.httpHeadersOverwriteParam="$httpHeaders");var o=r.join("");N("Connection","Creating WebChannel: "+o,u);var s=i.createWebChannel(o,u),c=!1,l=!1,f=new Ka({Vi:function(e){l?N("Connection","Not sending because WebChannel is closed:",e):(c||(N("Connection","Opening WebChannel transport."),s.open(),c=!0),N("Connection","WebChannel sending:",e),s.send(e))},Si:function(){return s.close()}}),h=function(e,t,n){e.listen(t,(function(e){try{n(e)}catch(e){setTimeout((function(){throw e}),0)}}))};return h(s,k.ii.EventType.OPEN,(function(){l||N("Connection","WebChannel transport opened.")})),h(s,k.ii.EventType.CLOSE,(function(){l||(l=!0,N("Connection","WebChannel transport closed"),f.Oi())})),h(s,k.ii.EventType.ERROR,(function(e){l||(l=!0,Z("Connection","WebChannel transport errored:",e),f.Oi(new P(O.UNAVAILABLE,"The operation could not be completed")))})),h(s,k.ii.EventType.MESSAGE,(function(e){var t;if(!l){var n=e.data[0];L(!!n);var r=n,i=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(i){N("Connection","WebChannel received error:",i);var a=i.status,u=function(e){var t=$t[e];if(void 0!==t)return un(t)}(a),o=i.message;void 0===u&&(u=O.INTERNAL,o="Unknown error status: "+a+" with message "+i.message),l=!0,f.Oi(new P(u,o)),s.close()}else N("Connection","WebChannel received:",n),f.Mi(n)}})),h(a,k.ju.STAT_EVENT,(function(e){e.stat===k.kN.PROXY?N("Connection","Detected buffering proxy"):e.stat===k.kN.NOPROXY&&N("Connection","Detected no buffering proxy")})),setTimeout((function(){f.$i()}),0),f}}]),n}(function(){function e(t){(0,f.Z)(this,e),this.databaseInfo=t,this.databaseId=t.databaseId;var n=t.ssl?"https":"http";this.Fi=n+"://"+t.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}return(0,h.Z)(e,[{key:"Bi",value:function(e,t,n,r,i){var a=this.Ui(e,t);N("RestConnection","Sending: ",a,n);var u={};return this.qi(u,r,i),this.Ki(e,a,u,n).then((function(e){return N("RestConnection","Received: ",e),e}),(function(t){throw Z("RestConnection","".concat(e," failed with error: "),t,"url: ",a,"request:",n),t}))}},{key:"ji",value:function(e,t,n,r,i){return this.Bi(e,t,n,r,i)}},{key:"qi",value:function(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+E,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((function(t,n){return e[n]=t})),n&&n.headers.forEach((function(t,n){return e[n]=t}))}},{key:"Ui",value:function(e,t){var n=Ba[e];return"".concat(this.Fi,"/v1/").concat(t,":").concat(n)}}]),e}());function Ga(){return"undefined"!=typeof window?window:null}function za(){return"undefined"!=typeof document?document:null}function Qa(e){return new Rn(e,!0)}var Wa=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6e4;(0,f.Z)(this,e),this.Me=t,this.timerId=n,this.Wi=r,this.Gi=i,this.zi=a,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}return(0,h.Z)(e,[{key:"reset",value:function(){this.Hi=0}},{key:"Xi",value:function(){this.Hi=this.zi}},{key:"Zi",value:function(e){var t=this;this.cancel();var n=Math.floor(this.Hi+this.tr()),r=Math.max(0,Date.now()-this.Yi),i=Math.max(0,n-r);i>0&&N("ExponentialBackoff","Backing off for ".concat(i," ms (base delay: ").concat(this.Hi," ms, delay with jitter: ").concat(n," ms, last attempt: ").concat(r," ms ago)")),this.Ji=this.Me.enqueueAfterDelay(this.timerId,i,(function(){return t.Yi=Date.now(),e()})),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}},{key:"er",value:function(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}},{key:"cancel",value:function(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}},{key:"tr",value:function(){return(Math.random()-.5)*this.Hi}}]),e}(),Ha=function(){function e(t,n,r,i,a,u,o,s){(0,f.Z)(this,e),this.Me=t,this.nr=r,this.sr=i,this.ir=a,this.authCredentialsProvider=u,this.appCheckCredentialsProvider=o,this.listener=s,this.state=0,this.rr=0,this.cr=null,this.ar=null,this.stream=null,this.ur=new Wa(t,n)}var t,n,r;return(0,h.Z)(e,[{key:"hr",value:function(){return 1===this.state||5===this.state||this.lr()}},{key:"lr",value:function(){return 2===this.state||3===this.state}},{key:"start",value:function(){4!==this.state?this.auth():this.dr()}},{key:"stop",value:(r=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.hr(),!e.t0){e.next=4;break}return e.next=4,this.close(0);case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"wr",value:function(){this.state=0,this.ur.reset()}},{key:"_r",value:function(){var e=this;this.lr()&&null===this.cr&&(this.cr=this.Me.enqueueAfterDelay(this.nr,6e4,(function(){return e.mr()})))}},{key:"gr",value:function(e){this.yr(),this.stream.send(e)}},{key:"mr",value:(n=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.lr()){e.next=2;break}return e.abrupt("return",this.close(0));case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"yr",value:function(){this.cr&&(this.cr.cancel(),this.cr=null)}},{key:"pr",value:function(){this.ar&&(this.ar.cancel(),this.ar=null)}},{key:"close",value:(t=(0,u.Z)(v().mark((function e(t,n){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==t?this.ur.reset():n&&n.code===O.RESOURCE_EXHAUSTED?(D(n.toString()),D("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):n&&n.code===O.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=t,e.next=9,this.listener.Ni(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"Tr",value:function(){}},{key:"auth",value:function(){var e=this;this.state=1;var t=this.Er(this.rr),n=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((function(t){var r=(0,a.Z)(t,2),i=r[0],u=r[1];e.rr===n&&e.Ir(i,u)}),(function(n){t((function(){var t=new P(O.UNKNOWN,"Fetching auth token failed: "+n.message);return e.Ar(t)}))}))}},{key:"Ir",value:function(e,t){var n=this,r=this.Er(this.rr);this.stream=this.Rr(e,t),this.stream.Di((function(){r((function(){return n.state=2,n.ar=n.Me.enqueueAfterDelay(n.sr,1e4,(function(){return n.lr()&&(n.state=3),Promise.resolve()})),n.listener.Di()}))})),this.stream.Ni((function(e){r((function(){return n.Ar(e)}))})),this.stream.onMessage((function(e){r((function(){return n.onMessage(e)}))}))}},{key:"dr",value:function(){var e=this;this.state=5,this.ur.Zi((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.state=0,e.start();case 1:case"end":return t.stop()}}),t)}))))}},{key:"Ar",value:function(e){return N("PersistentStream","close with error: ".concat(e)),this.stream=null,this.close(4,e)}},{key:"Er",value:function(e){var t=this;return function(n){t.Me.enqueueAndForget((function(){return t.rr===e?n():(N("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}}}]),e}(),Ya=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i,a,u,o){var s;return(0,f.Z)(this,n),(s=t.call(this,e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",r,i,a,o)).k=u,s}return(0,h.Z)(n,[{key:"Rr",value:function(e,t){return this.ir.Qi("Listen",e,t)}},{key:"onMessage",value:function(e){this.ur.reset();var t=function(e,t){var n;if("targetChange"in t){t.targetChange;var r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:R()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],a=function(e,t){return e.C?(L(void 0===t||"string"==typeof t),fe.fromBase64String(t||"")):(L(void 0===t||t instanceof Uint8Array),fe.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),u=t.targetChange.cause,o=u&&function(e){var t=void 0===e.code?O.UNKNOWN:un(e.code);return new P(t,e.message||"")}(u);n=new Sn(r,i,a,o||null)}else if("documentChange"in t){t.documentChange;var s=t.documentChange;s.document,s.document.name,s.document.updateTime;var c=Un(e,s.document.name),l=On(s.document.updateTime),f=new Oe({mapValue:{fields:s.document.fields}}),h=Ve.newFoundDocument(c,l,f),d=s.targetIds||[],v=s.removedTargetIds||[];n=new Tn(d,v,h.key,h)}else if("documentDelete"in t){t.documentDelete;var y=t.documentDelete;y.document;var p=Un(e,y.document),m=y.readTime?On(y.readTime):te.min(),g=Ve.newNoDocument(p,m),k=y.removedTargetIds||[];n=new Tn([],k,g.key,g)}else if("documentRemove"in t){t.documentRemove;var w=t.documentRemove;w.document;var b=Un(e,w.document),x=w.removedTargetIds||[];n=new Tn([],x,b,null)}else{if(!("filter"in t))return R();t.filter;var I=t.filter;I.targetId;var T=I.count||0,E=new rn(T),S=I.targetId;n=new En(S,E)}return n}(this.k,e),n=function(e){if(!("targetChange"in e))return te.min();var t=e.targetChange;return t.targetIds&&t.targetIds.length?te.min():t.readTime?On(t.readTime):te.min()}(e);return this.listener.br(t,n)}},{key:"Pr",value:function(e){var t={};t.database=jn(this.k),t.addTarget=function(e,t){var n,r=t.target;return(n=je(r)?{documents:Jn(e,r)}:{query:Xn(e,r)}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=Mn(e,t.resumeToken):t.snapshotVersion.compareTo(te.min())>0&&(n.readTime=Ln(e,t.snapshotVersion.toTimestamp())),n}(this.k,e);var n=function(e,t){var n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return R()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.k,e);n&&(t.labels=n),this.gr(t)}},{key:"vr",value:function(e){var t={};t.database=jn(this.k),t.removeTarget=e,this.gr(t)}}]),n}(Ha),Ja=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i,a,u,o){var s;return(0,f.Z)(this,n),(s=t.call(this,e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",r,i,a,o)).k=u,s.Vr=!1,s}return(0,h.Z)(n,[{key:"Sr",get:function(){return this.Vr}},{key:"start",value:function(){this.Vr=!1,this.lastStreamToken=void 0,(0,i.Z)((0,c.Z)(n.prototype),"start",this).call(this)}},{key:"Tr",value:function(){this.Vr&&this.Dr([])}},{key:"Rr",value:function(e,t){return this.ir.Qi("Write",e,t)}},{key:"onMessage",value:function(e){if(L(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Vr){this.ur.reset();var t=function(e,t){return e&&e.length>0?(L(void 0!==t),e.map((function(e){return function(e,t){var n=e.updateTime?On(e.updateTime):On(t);return n.isEqual(te.min())&&(n=On(t)),new Vt(n,e.transformResults||[])}(e,t)}))):[]}(e.writeResults,e.commitTime),n=On(e.commitTime);return this.listener.Cr(n,t)}return L(!e.writeResults||0===e.writeResults.length),this.Vr=!0,this.listener.Nr()}},{key:"kr",value:function(){var e={};e.database=jn(this.k),this.gr(e)}},{key:"Dr",value:function(e){var t=this,n={streamToken:this.lastStreamToken,writes:e.map((function(e){return Hn(t.k,e)}))};this.gr(n)}}]),n}(Ha),Xa=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i,a){var u;return(0,f.Z)(this,n),(u=t.call(this)).authCredentials=e,u.appCheckCredentials=r,u.ir=i,u.k=a,u.$r=!1,u}return(0,h.Z)(n,[{key:"Or",value:function(){if(this.$r)throw new P(O.FAILED_PRECONDITION,"The client has already been terminated.")}},{key:"Bi",value:function(e,t,n){var r=this;return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((function(i){var u=(0,a.Z)(i,2),o=u[0],s=u[1];return r.ir.Bi(e,t,n,o,s)})).catch((function(e){throw"FirebaseError"===e.name?(e.code===O.UNAUTHENTICATED&&(r.authCredentials.invalidateToken(),r.appCheckCredentials.invalidateToken()),e):new P(O.UNKNOWN,e.toString())}))}},{key:"ji",value:function(e,t,n){var r=this;return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((function(i){var u=(0,a.Z)(i,2),o=u[0],s=u[1];return r.ir.ji(e,t,n,o,s)})).catch((function(e){throw"FirebaseError"===e.name?(e.code===O.UNAUTHENTICATED&&(r.authCredentials.invalidateToken(),r.appCheckCredentials.invalidateToken()),e):new P(O.UNKNOWN,e.toString())}))}},{key:"terminate",value:function(){this.$r=!0}}]),n}(function(){return(0,h.Z)((function e(){(0,f.Z)(this,e)}))}()),$a=function(){function e(t,n){(0,f.Z)(this,e),this.asyncQueue=t,this.onlineStateHandler=n,this.state="Unknown",this.Mr=0,this.Fr=null,this.Lr=!0}return(0,h.Z)(e,[{key:"Br",value:function(){var e=this;0===this.Mr&&(this.Ur("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(function(){return e.Fr=null,e.qr("Backend didn't respond within 10 seconds."),e.Ur("Offline"),Promise.resolve()})))}},{key:"Kr",value:function(e){"Online"===this.state?this.Ur("Unknown"):(this.Mr++,this.Mr>=1&&(this.jr(),this.qr("Connection failed 1 times. Most recent error: ".concat(e.toString())),this.Ur("Offline")))}},{key:"set",value:function(e){this.jr(),this.Mr=0,"Online"===e&&(this.Lr=!1),this.Ur(e)}},{key:"Ur",value:function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}},{key:"qr",value:function(e){var t="Could not reach Cloud Firestore backend. ".concat(e,"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.");this.Lr?(D(t),this.Lr=!1):N("OnlineStateTracker",t)}},{key:"jr",value:function(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}]),e}(),eu=(0,h.Z)((function e(t,n,r,i,a){var o=this;(0,f.Z)(this,e),this.localStore=t,this.datastore=n,this.asyncQueue=r,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=a,this.Hr.Ei((function(e){r.enqueueAndForget((0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=fu(o),!e.t0){e.next=5;break}return N("RemoteStore","Restarting streams for network reachability change."),e.next=5,function(){var e=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=F(t)).Gr.add(4),e.next=4,ru(n);case 4:return n.Jr.set("Unknown"),n.Gr.delete(4),e.next=8,tu(n);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(o);case 5:case"end":return e.stop()}}),e)}))))})),this.Jr=new $a(r,i)}));function tu(e){return nu.apply(this,arguments)}function nu(){return(nu=(0,u.Z)(v().mark((function e(t){var n,r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!fu(t)){e.next=18;break}n=w(t.zr),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=10;break}return i=r.value,e.next=8,i(!0);case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:case"end":return e.stop()}}),e,null,[[2,12,15,18]])})))).apply(this,arguments)}function ru(e){return iu.apply(this,arguments)}function iu(){return(iu=(0,u.Z)(v().mark((function e(t){var n,r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=w(t.zr),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return i=r.value,e.next=7,i(!1);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[1,11,14,17]])})))).apply(this,arguments)}function au(e,t){var n=F(e);n.Wr.has(t.targetId)||(n.Wr.set(t.targetId,t),lu(n)?cu(n):Pu(n).lr()&&ou(n,t))}function uu(e,t){var n=F(e),r=Pu(n);n.Wr.delete(t),r.lr()&&su(n,t),0===n.Wr.size&&(r.lr()?r._r():fu(n)&&n.Jr.set("Unknown"))}function ou(e,t){e.Yr.X(t.targetId),Pu(e).Pr(t)}function su(e,t){e.Yr.X(t),Pu(e).vr(t)}function cu(e){e.Yr=new _n({getRemoteKeysForTarget:function(t){return e.remoteSyncer.getRemoteKeysForTarget(t)},Et:function(t){return e.Wr.get(t)||null}}),Pu(e).start(),e.Jr.Br()}function lu(e){return fu(e)&&!Pu(e).hr()&&e.Wr.size>0}function fu(e){return 0===F(e).Gr.size}function hu(e){e.Yr=void 0}function du(e){return vu.apply(this,arguments)}function vu(){return(vu=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.Wr.forEach((function(e,n){ou(t,e)}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yu(e,t){return pu.apply(this,arguments)}function pu(){return(pu=(0,u.Z)(v().mark((function e(t,n){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:hu(t),lu(t)?(t.Jr.Kr(n),cu(t)):t.Jr.set("Unknown");case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function mu(e,t,n){return gu.apply(this,arguments)}function gu(){return gu=(0,u.Z)(v().mark((function e(t,n,r){var i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Jr.set("Online"),!(n instanceof Sn&&2===n.state&&n.cause)){e.next=13;break}return e.prev=1,e.next=4,function(){var e=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.cause,i=w(n.targetIds),e.prev=2,i.s();case 4:if((a=i.n()).done){e.next=14;break}if(u=a.value,e.t0=t.Wr.has(u),!e.t0){e.next=12;break}return e.next=10,t.remoteSyncer.rejectListen(u,r);case 10:t.Wr.delete(u),t.Yr.removeTarget(u);case 12:e.next=4;break;case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(2),i.e(e.t1);case 19:return e.prev=19,i.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[2,16,19,22]])})));return function(t,n){return e.apply(this,arguments)}}()(t,n);case 4:e.next=11;break;case 6:return e.prev=6,e.t0=e.catch(1),N("RemoteStore","Failed to remove targets %s: %s ",n.targetIds.join(","),e.t0),e.next=11,ku(t,e.t0);case 11:case 22:e.next=29;break;case 13:if(n instanceof Tn?t.Yr.ot(n):n instanceof En?t.Yr.dt(n):t.Yr.ut(n),r.isEqual(te.min())){e.next=29;break}return e.prev=14,e.next=17,ia(t.localStore);case 17:if(i=e.sent,e.t1=r.compareTo(i)>=0,!e.t1){e.next=22;break}return e.next=22,function(e,t){var n=e.Yr.gt(t);return n.targetChanges.forEach((function(n,r){if(n.resumeToken.approximateByteSize()>0){var i=e.Wr.get(r);i&&e.Wr.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((function(t){var n=e.Wr.get(t);if(n){e.Wr.set(t,n.withResumeToken(fe.EMPTY_BYTE_STRING,n.snapshotVersion)),su(e,t);var r=new Wr(n.target,t,1,n.sequenceNumber);ou(e,r)}})),e.remoteSyncer.applyRemoteEvent(n)}(t,r);case 24:return e.prev=24,e.t2=e.catch(14),N("RemoteStore","Failed to raise snapshot:",e.t2),e.next=29,ku(t,e.t2);case 29:case"end":return e.stop()}}),e,null,[[1,6],[14,24]])}))),gu.apply(this,arguments)}function ku(e,t,n){return wu.apply(this,arguments)}function wu(){return(wu=(0,u.Z)(v().mark((function e(t,n,r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Vr(n)){e.next=2;break}throw n;case 2:return t.Gr.add(1),e.next=5,ru(t);case 5:t.Jr.set("Offline"),r||(r=function(){return ia(t.localStore)}),t.asyncQueue.enqueueRetryable((0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return N("RemoteStore","Retrying IndexedDB access"),e.next=3,r();case 3:return t.Gr.delete(1),e.next=6,tu(t);case 6:case"end":return e.stop()}}),e)}))));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bu(e,t){return t().catch((function(n){return ku(e,n,t)}))}function xu(e){return Iu.apply(this,arguments)}function Iu(){return(Iu=(0,u.Z)(v().mark((function e(t){var n,r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=F(t),r=Vu(n),i=n.Qr.length>0?n.Qr[n.Qr.length-1].batchId:-1;case 2:if(!Tu(n)){e.next=19;break}return e.prev=3,e.next=6,oa(n.localStore,i);case 6:if(null!==(a=e.sent)){e.next=10;break}return 0===n.Qr.length&&r._r(),e.abrupt("break",19);case 10:i=a.batchId,Eu(n,a),e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(3),e.next=17,ku(n,e.t0);case 17:e.next=2;break;case 19:Su(n)&&Au(n);case 20:case"end":return e.stop()}}),e,null,[[3,13]])})))).apply(this,arguments)}function Tu(e){return fu(e)&&e.Qr.length<10}function Eu(e,t){e.Qr.push(t);var n=Vu(e);n.lr()&&n.Sr&&n.Dr(t.mutations)}function Su(e){return fu(e)&&!Vu(e).hr()&&e.Qr.length>0}function Au(e){Vu(e).start()}function _u(e){return Nu.apply(this,arguments)}function Nu(){return(Nu=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Vu(t).kr();case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Du(e){return Zu.apply(this,arguments)}function Zu(){return(Zu=(0,u.Z)(v().mark((function e(t){var n,r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Vu(t),r=w(t.Qr);try{for(r.s();!(i=r.n()).done;)a=i.value,n.Dr(a.mutations)}catch(u){r.e(u)}finally{r.f()}case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Cu(e,t,n){return Ru.apply(this,arguments)}function Ru(){return(Ru=(0,u.Z)(v().mark((function e(t,n,r){var i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.Qr.shift(),a=Qr.from(i,n,r),e.next=3,bu(t,(function(){return t.remoteSyncer.applySuccessfulWrite(a)}));case 3:return e.next=5,xu(t);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Lu(e,t){return Mu.apply(this,arguments)}function Mu(){return Mu=(0,u.Z)(v().mark((function e(t,n){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=n&&Vu(t).Sr,!e.t0){e.next=4;break}return e.next=4,function(){var e=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!an(i=n.code)||i===O.ABORTED){e.next=7;break}return r=t.Qr.shift(),Vu(t).wr(),e.next=5,bu(t,(function(){return t.remoteSyncer.rejectFailedWrite(r.batchId,n)}));case 5:return e.next=7,xu(t);case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(t,n);case 4:Su(t)&&Au(t);case 5:case"end":return e.stop()}}),e)}))),Mu.apply(this,arguments)}function Fu(e,t){return Ou.apply(this,arguments)}function Ou(){return(Ou=(0,u.Z)(v().mark((function e(t,n){var r;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=F(t),!n){e.next=7;break}return r.Gr.delete(2),e.next=5,tu(r);case 5:e.next=13;break;case 7:if(e.t0=n,e.t0){e.next=13;break}return r.Gr.add(2),e.next=12,ru(r);case 12:r.Jr.set("Unknown");case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Pu(e){return e.Xr||(e.Xr=function(e,t,n){var r=F(e);return r.Or(),new Ya(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(e.datastore,e.asyncQueue,{Di:du.bind(null,e),Ni:yu.bind(null,e),br:mu.bind(null,e)}),e.zr.push(function(){var t=(0,u.Z)(v().mark((function t(n){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=4;break}e.Xr.wr(),lu(e)?cu(e):e.Jr.set("Unknown"),t.next=7;break;case 4:return t.next=6,e.Xr.stop();case 6:hu(e);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),e.Xr}function Vu(e){return e.Zr||(e.Zr=function(e,t,n){var r=F(e);return r.Or(),new Ja(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(e.datastore,e.asyncQueue,{Di:_u.bind(null,e),Ni:Lu.bind(null,e),Nr:Du.bind(null,e),Cr:Cu.bind(null,e)}),e.zr.push(function(){var t=(0,u.Z)(v().mark((function t(n){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=6;break}return e.Zr.wr(),t.next=4,xu(e);case 4:t.next=9;break;case 6:return t.next=8,e.Zr.stop();case 8:e.Qr.length>0&&(N("RemoteStore","Stopping write stream with ".concat(e.Qr.length," pending writes")),e.Qr=[]);case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),e.Zr}var qu=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this.asyncQueue=t,this.timerId=n,this.targetTimeMs=r,this.op=i,this.removalCallback=a,this.deferred=new V,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((function(e){}))}return(0,h.Z)(e,[{key:"start",value:function(e){var t=this;this.timerHandle=setTimeout((function(){return t.handleDelayElapsed()}),e)}},{key:"skipDelay",value:function(){return this.handleDelayElapsed()}},{key:"cancel",value:function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new P(O.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}},{key:"handleDelayElapsed",value:function(){var e=this;this.asyncQueue.enqueueAndForget((function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then((function(t){return e.deferred.resolve(t)}))):Promise.resolve()}))}},{key:"clearTimeout",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}))}],[{key:"createAndSchedule",value:function(t,n,r,i,a){var u=new e(t,n,Date.now()+r,i,a);return u.start(r),u}}]),e}();function Uu(e,t){if(D("AsyncQueue","".concat(t,": ").concat(e)),Vr(e))return new P(O.UNAVAILABLE,"".concat(t,": ").concat(e));throw e}var Bu=function(){function e(t){(0,f.Z)(this,e),this.comparator=t?function(e,n){return t(e,n)||xe.comparator(e.key,n.key)}:function(e,t){return xe.comparator(e.key,t.key)},this.keyedMap=yn(),this.sortedSet=new on(this.comparator)}return(0,h.Z)(e,[{key:"has",value:function(e){return null!=this.keyedMap.get(e)}},{key:"get",value:function(e){return this.keyedMap.get(e)}},{key:"first",value:function(){return this.sortedSet.minKey()}},{key:"last",value:function(){return this.sortedSet.maxKey()}},{key:"isEmpty",value:function(){return this.sortedSet.isEmpty()}},{key:"indexOf",value:function(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}},{key:"size",get:function(){return this.sortedSet.size}},{key:"forEach",value:function(e){this.sortedSet.inorderTraversal((function(t,n){return e(t),!1}))}},{key:"add",value:function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}},{key:"delete",value:function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}},{key:"isEqual",value:function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,a=r.getNext().key;if(!i.isEqual(a))return!1}return!0}},{key:"toString",value:function(){var e=[];return this.forEach((function(t){e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}},{key:"copy",value:function(t,n){var r=new e;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=n,r}}],[{key:"emptySet",value:function(t){return new e(t.comparator)}}]),e}(),Ku=function(){function e(){(0,f.Z)(this,e),this.eo=new on(xe.comparator)}return(0,h.Z)(e,[{key:"track",value:function(e){var t=e.doc.key,n=this.eo.get(t);n?0!==e.type&&3===n.type?this.eo=this.eo.insert(t,e):3===e.type&&1!==n.type?this.eo=this.eo.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.eo=this.eo.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.eo=this.eo.remove(t):1===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):R():this.eo=this.eo.insert(t,e)}},{key:"no",value:function(){var e=[];return this.eo.inorderTraversal((function(t,n){e.push(n)})),e}}]),e}(),ju=function(){function e(t,n,r,i,a,u,o,s){(0,f.Z)(this,e),this.query=t,this.docs=n,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=a,this.fromCache=u,this.syncStateChanged=o,this.excludesMetadataChanges=s}return(0,h.Z)(e,[{key:"hasPendingWrites",get:function(){return!this.mutatedKeys.isEmpty()}},{key:"isEqual",value:function(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&mt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}],[{key:"fromInitialDocuments",value:function(t,n,r,i){var a=[];return n.forEach((function(e){a.push({type:0,doc:e})})),new e(t,n,Bu.emptySet(n),a,r,i,!0,!1)}}]),e}(),Gu=(0,h.Z)((function e(){(0,f.Z)(this,e),this.so=void 0,this.listeners=[]})),zu=(0,h.Z)((function e(){(0,f.Z)(this,e),this.queries=new Mi((function(e){return gt(e)}),mt),this.onlineState="Unknown",this.io=new Set}));function Qu(e,t){return Wu.apply(this,arguments)}function Wu(){return(Wu=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=F(t),i=n.query,a=!1,(u=r.queries.get(i))||(a=!0,u=new Gu),!a){e.next=13;break}return e.prev=3,e.next=6,r.onListen(i);case 6:u.so=e.sent,e.next=13;break;case 9:return e.prev=9,e.t0=e.catch(3),o=Uu(e.t0,"Initialization of query '".concat(kt(n.query),"' failed")),e.abrupt("return",void n.onError(o));case 13:r.queries.set(i,u),u.listeners.push(n),n.ro(r.onlineState),u.so&&n.oo(u.so)&&$u(r);case 14:case"end":return e.stop()}}),e,null,[[3,9]])})))).apply(this,arguments)}function Hu(e,t){return Yu.apply(this,arguments)}function Yu(){return(Yu=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=F(t),i=n.query,a=!1,(u=r.queries.get(i))&&(o=u.listeners.indexOf(n))>=0&&(u.listeners.splice(o,1),a=0===u.listeners.length),!a){e.next=6;break}return e.abrupt("return",(r.queries.delete(i),r.onUnlisten(i)));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ju(e,t){var n,r=F(e),i=!1,a=w(t);try{for(a.s();!(n=a.n()).done;){var u=n.value,o=u.query,s=r.queries.get(o);if(s){var c,l=w(s.listeners);try{for(l.s();!(c=l.n()).done;){c.value.oo(u)&&(i=!0)}}catch(f){l.e(f)}finally{l.f()}s.so=u}}}catch(f){a.e(f)}finally{a.f()}i&&$u(r)}function Xu(e,t,n){var r=F(e),i=r.queries.get(t);if(i){var a,u=w(i.listeners);try{for(u.s();!(a=u.n()).done;){a.value.onError(n)}}catch(o){u.e(o)}finally{u.f()}}r.queries.delete(t)}function $u(e){e.io.forEach((function(e){e.next()}))}var eo=function(){function e(t,n,r){(0,f.Z)(this,e),this.query=t,this.co=n,this.ao=!1,this.uo=null,this.onlineState="Unknown",this.options=r||{}}return(0,h.Z)(e,[{key:"oo",value:function(e){if(!this.options.includeMetadataChanges){var t,n=[],r=w(e.docChanges);try{for(r.s();!(t=r.n()).done;){var i=t.value;3!==i.type&&n.push(i)}}catch(u){r.e(u)}finally{r.f()}e=new ju(e.query,e.docs,e.oldDocs,n,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}var a=!1;return this.ao?this.ho(e)&&(this.co.next(e),a=!0):this.lo(e,this.onlineState)&&(this.fo(e),a=!0),this.uo=e,a}},{key:"onError",value:function(e){this.co.error(e)}},{key:"ro",value:function(e){this.onlineState=e;var t=!1;return this.uo&&!this.ao&&this.lo(this.uo,e)&&(this.fo(this.uo),t=!0),t}},{key:"lo",value:function(e,t){if(!e.fromCache)return!0;var n="Offline"!==t;return!(this.options.wo&&n||e.docs.isEmpty()&&"Offline"!==t)}},{key:"ho",value:function(e){if(e.docChanges.length>0)return!0;var t=this.uo&&this.uo.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}},{key:"fo",value:function(e){e=ju.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.ao=!0,this.co.next(e)}}]),e}(),to=function(){function e(t,n){(0,f.Z)(this,e),this.payload=t,this.byteLength=n}return(0,h.Z)(e,[{key:"_o",value:function(){return"metadata"in this.payload}}]),e}(),no=function(){function e(t){(0,f.Z)(this,e),this.k=t}return(0,h.Z)(e,[{key:"Hn",value:function(e){return Un(this.k,e)}},{key:"Jn",value:function(e){return e.metadata.exists?Qn(this.k,e.document,!1):Ve.newNoDocument(this.Hn(e.metadata.name),this.Yn(e.metadata.readTime))}},{key:"Yn",value:function(e){return On(e)}}]),e}(),ro=function(){function e(t,n,r){(0,f.Z)(this,e),this.mo=t,this.localStore=n,this.k=r,this.queries=[],this.documents=[],this.progress=io(t)}var t;return(0,h.Z)(e,[{key:"yo",value:function(e){this.progress.bytesLoaded+=e.byteLength;var t=this.progress.documentsLoaded;return e.payload.namedQuery?this.queries.push(e.payload.namedQuery):e.payload.documentMetadata?(this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t):e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}},{key:"po",value:function(e){var t,n=new Map,r=new no(this.k),i=w(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(a.metadata.queries){var u,o=r.Hn(a.metadata.name),s=w(a.metadata.queries);try{for(s.s();!(u=s.n()).done;){var c=u.value,l=(n.get(c)||kn()).add(o);n.set(c,l)}}catch(f){s.e(f)}finally{s.f()}}}}catch(f){i.e(f)}finally{i.f()}return n}},{key:"complete",value:(t=(0,u.Z)(v().mark((function e(){var t,n,r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,pa(this.localStore,new no(this.k),this.documents,this.mo.id);case 2:t=e.sent,n=this.po(this.documents),r=w(this.queries),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=13;break}return a=i.value,e.next=11,ga(this.localStore,a,n.get(a.name));case 11:e.next=7;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(5),r.e(e.t0);case 18:return e.prev=18,r.f(),e.finish(18);case 21:return e.abrupt("return",(this.progress.taskState="Success",new Hi(Object.assign({},this.progress),t)));case 22:case"end":return e.stop()}}),e,this,[[5,15,18,21]])}))),function(){return t.apply(this,arguments)})}]),e}();function io(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}var ao=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.key=t})),uo=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.key=t})),oo=function(){function e(t,n){(0,f.Z)(this,e),this.query=t,this.To=n,this.Eo=null,this.current=!1,this.Io=kn(),this.mutatedKeys=kn(),this.Ao=bt(t),this.Ro=new Bu(this.Ao)}return(0,h.Z)(e,[{key:"bo",get:function(){return this.To}},{key:"Po",value:function(e,t){var n=this,r=t?t.vo:new Ku,i=t?t.Ro:this.Ro,a=t?t.mutatedKeys:this.mutatedKeys,u=i,o=!1,s=ct(this.query)&&i.size===this.query.limit?i.last():null,c=lt(this.query)&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((function(e,t){var l=i.get(e),f=wt(n.query,t)?t:null,h=!!l&&n.mutatedKeys.has(l.key),d=!!f&&(f.hasLocalMutations||n.mutatedKeys.has(f.key)&&f.hasCommittedMutations),v=!1;l&&f?l.data.isEqual(f.data)?h!==d&&(r.track({type:3,doc:f}),v=!0):n.Vo(l,f)||(r.track({type:2,doc:f}),v=!0,(s&&n.Ao(f,s)>0||c&&n.Ao(f,c)<0)&&(o=!0)):!l&&f?(r.track({type:0,doc:f}),v=!0):l&&!f&&(r.track({type:1,doc:l}),v=!0,(s||c)&&(o=!0)),v&&(f?(u=u.add(f),a=d?a.add(e):a.delete(e)):(u=u.delete(e),a=a.delete(e)))})),ct(this.query)||lt(this.query))for(;u.size>this.query.limit;){var l=ct(this.query)?u.last():u.first();u=u.delete(l.key),a=a.delete(l.key),r.track({type:1,doc:l})}return{Ro:u,vo:r,Bn:o,mutatedKeys:a}}},{key:"Vo",value:function(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}},{key:"applyChanges",value:function(e,t,n){var r=this,i=this.Ro;this.Ro=e.Ro,this.mutatedKeys=e.mutatedKeys;var a=e.vo.no();a.sort((function(e,t){return function(e,t){var n=function(e){switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return R()}};return n(e)-n(t)}(e.type,t.type)||r.Ao(e.doc,t.doc)})),this.So(n);var u=t?this.Do():[],o=0===this.Io.size&&this.current?1:0,s=o!==this.Eo;return this.Eo=o,0!==a.length||s?{snapshot:new ju(this.query,e.Ro,i,a,e.mutatedKeys,0===o,s,!1),Co:u}:{Co:u}}},{key:"ro",value:function(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new Ku,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}},{key:"No",value:function(e){return!this.To.has(e)&&!!this.Ro.has(e)&&!this.Ro.get(e).hasLocalMutations}},{key:"So",value:function(e){var t=this;e&&(e.addedDocuments.forEach((function(e){return t.To=t.To.add(e)})),e.modifiedDocuments.forEach((function(e){})),e.removedDocuments.forEach((function(e){return t.To=t.To.delete(e)})),this.current=e.current)}},{key:"Do",value:function(){var e=this;if(!this.current)return[];var t=this.Io;this.Io=kn(),this.Ro.forEach((function(t){e.No(t.key)&&(e.Io=e.Io.add(t.key))}));var n=[];return t.forEach((function(t){e.Io.has(t)||n.push(new uo(t))})),this.Io.forEach((function(e){t.has(e)||n.push(new ao(e))})),n}},{key:"ko",value:function(e){this.To=e.zn,this.Io=kn();var t=this.Po(e.documents);return this.applyChanges(t,!0)}},{key:"xo",value:function(){return ju.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}]),e}(),so=(0,h.Z)((function e(t,n,r){(0,f.Z)(this,e),this.query=t,this.targetId=n,this.view=r})),co=(0,h.Z)((function e(t){(0,f.Z)(this,e),this.key=t,this.$o=!1})),lo=function(){function e(t,n,r,i,a,u){(0,f.Z)(this,e),this.localStore=t,this.remoteStore=n,this.eventManager=r,this.sharedClientState=i,this.currentUser=a,this.maxConcurrentLimboResolutions=u,this.Oo={},this.Mo=new Mi((function(e){return gt(e)}),mt),this.Fo=new Map,this.Lo=new Set,this.Bo=new on(xe.comparator),this.Uo=new Map,this.qo=new ba,this.Ko={},this.jo=new Map,this.Qo=xi.re(),this.onlineState="Unknown",this.Wo=void 0}return(0,h.Z)(e,[{key:"isPrimaryClient",get:function(){return!0===this.Wo}}]),e}();function fo(e,t){return ho.apply(this,arguments)}function ho(){return(ho=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=as(t),!(u=r.Mo.get(n))){e.next=6;break}i=u.targetId,r.sharedClientState.addLocalQueryTarget(i),a=u.view.xo(),e.next=15;break;case 6:return e.next=8,sa(r.localStore,yt(n));case 8:return o=e.sent,s=r.sharedClientState.addLocalQueryTarget(o.targetId),i=o.targetId,e.next=13,vo(r,n,i,"current"===s);case 13:a=e.sent,r.isPrimaryClient&&au(r.remoteStore,o);case 15:return e.abrupt("return",a);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function vo(e,t,n,r){return yo.apply(this,arguments)}function yo(){return yo=(0,u.Z)(v().mark((function e(t,n,r,i){var a,o,s,c,l,f;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.Go=function(e,n,r){return(i=(0,u.Z)(v().mark((function e(t,n,r,i){var a,u,o;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.view.Po(r),e.t0=a.Bn,!e.t0){e.next=6;break}return e.next=5,fa(t.localStore,n.query,!1).then((function(e){var t=e.documents;return n.view.Po(t,a)}));case 5:a=e.sent;case 6:return u=i&&i.targetChanges.get(n.targetId),o=n.view.applyChanges(a,t.isPrimaryClient,u),e.abrupt("return",(Mo(t,n.targetId,o.Co),o.snapshot));case 8:case"end":return e.stop()}}),e)}))),function(e,t,n,r){return i.apply(this,arguments)})(t,e,n,r);var i},e.next=3,fa(t.localStore,n,!0);case 3:return a=e.sent,o=new oo(n,a.zn),s=o.Po(a.documents),c=In.createSynthesizedTargetChangeForCurrentChange(r,i&&"Offline"!==t.onlineState),l=o.applyChanges(s,t.isPrimaryClient,c),Mo(t,r,l.Co),f=new so(n,r,o),e.abrupt("return",(t.Mo.set(n,f),t.Fo.has(r)?t.Fo.get(r).push(n):t.Fo.set(r,[n]),l.snapshot));case 11:case"end":return e.stop()}}),e)}))),yo.apply(this,arguments)}function po(e,t){return mo.apply(this,arguments)}function mo(){return(mo=(0,u.Z)(v().mark((function e(t,n){var r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=F(t),i=r.Mo.get(n),!((a=r.Fo.get(i.targetId)).length>1)){e.next=3;break}return e.abrupt("return",(r.Fo.set(i.targetId,a.filter((function(e){return!mt(e,n)}))),void r.Mo.delete(n)));case 3:if(!r.isPrimaryClient){e.next=11;break}if(r.sharedClientState.removeLocalQueryTarget(i.targetId),e.t0=r.sharedClientState.isActiveQueryTarget(i.targetId),e.t0){e.next=9;break}return e.next=9,ca(r.localStore,i.targetId,!1).then((function(){r.sharedClientState.clearQueryState(i.targetId),uu(r.remoteStore,i.targetId),Ro(r,i.targetId)})).catch(Ai);case 9:e.next=14;break;case 11:return Ro(r,i.targetId),e.next=14,ca(r.localStore,i.targetId,!0);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function go(e,t,n){return ko.apply(this,arguments)}function ko(){return(ko=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=us(t),e.prev=1,e.next=4,function(e,t){var n,r=F(e),i=ee.now(),a=t.reduce((function(e,t){return e.add(t.key)}),kn());return r.persistence.runTransaction("Locally write mutations","readwrite",(function(e){return r.Wn.vn(e,a).next((function(a){n=a;var u,o=[],s=w(t);try{for(s.s();!(u=s.n()).done;){var c=u.value,l=Gt(c,n.get(c.key));null!=l&&o.push(new Ht(c.key,l,Pe(l.value.mapValue),qt.exists(!0)))}}catch(f){s.e(f)}finally{s.f()}return r.An.addMutationBatch(e,i,o,t)}))})).then((function(e){return e.applyToLocalDocumentSet(n),{batchId:e.batchId,changes:n}}))}(i.localStore,n);case 4:return a=e.sent,i.sharedClientState.addPendingMutation(a.batchId),function(e,t,n){var r=e.Ko[e.currentUser.toKey()];r||(r=new on(J)),r=r.insert(t,n),e.Ko[e.currentUser.toKey()]=r}(i,a.batchId,r),e.next=9,Po(i,a.changes);case 9:return e.next=11,xu(i.remoteStore);case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),u=Uu(e.t0,"Failed to persist write"),r.reject(u);case 17:case"end":return e.stop()}}),e,null,[[1,13]])})))).apply(this,arguments)}function wo(e,t){return bo.apply(this,arguments)}function bo(){return(bo=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),e.prev=1,e.next=4,aa(r.localStore,n);case 4:return i=e.sent,n.targetChanges.forEach((function(e,t){var n=r.Uo.get(t);n&&(L(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?n.$o=!0:e.modifiedDocuments.size>0?L(n.$o):e.removedDocuments.size>0&&(L(n.$o),n.$o=!1))})),e.next=8,Po(r,i,n);case 8:e.next=14;break;case 10:return e.prev=10,e.t0=e.catch(1),e.next=14,Ai(e.t0);case 14:case"end":return e.stop()}}),e,null,[[1,10]])})))).apply(this,arguments)}function xo(e,t,n){var r=F(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){var i=[];r.Mo.forEach((function(e,n){var r=n.view.ro(t);r.snapshot&&i.push(r.snapshot)})),function(e,t){var n=F(e);n.onlineState=t;var r=!1;n.queries.forEach((function(e,n){var i,a=w(n.listeners);try{for(a.s();!(i=a.n()).done;){i.value.ro(t)&&(r=!0)}}catch(u){a.e(u)}finally{a.f()}})),r&&$u(n)}(r.eventManager,t),i.length&&r.Oo.br(i),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}function Io(e,t,n){return To.apply(this,arguments)}function To(){return(To=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u,o,s,c;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((i=F(t)).sharedClientState.updateQueryState(n,"rejected",r),a=i.Uo.get(n),!(u=a&&a.key)){e.next=14;break}return o=(o=new on(xe.comparator)).insert(u,Ve.newNoDocument(u,te.min())),s=kn().add(u),c=new xn(te.min(),new Map,new ln(J),o,s),e.next=9,wo(i,c);case 9:i.Bo=i.Bo.remove(u),i.Uo.delete(n),Oo(i),e.next=16;break;case 14:return e.next=16,ca(i.localStore,n,!1).then((function(){return Ro(i,n,r)})).catch(Ai);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Eo(e,t){return So.apply(this,arguments)}function So(){return(So=(0,u.Z)(v().mark((function e(t,n){var r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),i=n.batch.batchId,e.prev=1,e.next=4,ra(r.localStore,n);case 4:return a=e.sent,Co(r,i,null),Zo(r,i),r.sharedClientState.updateMutationState(i,"acknowledged"),e.next=10,Po(r,a);case 10:e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(1),e.next=16,Ai(e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})))).apply(this,arguments)}function Ao(e,t,n){return _o.apply(this,arguments)}function _o(){return(_o=(0,u.Z)(v().mark((function e(t,n,r){var i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=F(t),e.prev=1,e.next=4,function(e,t){var n=F(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(function(e){var r;return n.An.lookupMutationBatch(e,t).next((function(t){return L(null!==t),r=t.keys(),n.An.removeMutationBatch(e,t)})).next((function(){return n.An.performConsistencyCheck(e)})).next((function(){return n.Wn.vn(e,r)}))}))}(i.localStore,n);case 4:return a=e.sent,Co(i,n,r),Zo(i,n),i.sharedClientState.updateMutationState(n,"rejected",r),e.next=10,Po(i,a);case 10:e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(1),e.next=16,Ai(e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})))).apply(this,arguments)}function No(e,t){return Do.apply(this,arguments)}function Do(){return(Do=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return fu((r=F(t)).remoteStore)||N("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),e.prev=2,e.next=5,function(e){var t=F(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(function(e){return t.An.getHighestUnacknowledgedBatchId(e)}))}(r.localStore);case 5:if(-1!==(i=e.sent)){e.next=8;break}return e.abrupt("return",void n.resolve());case 8:(a=r.jo.get(i)||[]).push(n),r.jo.set(i,a),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(2),u=Uu(e.t0,"Initialization of waitForPendingWrites() operation failed"),n.reject(u);case 16:case"end":return e.stop()}}),e,null,[[2,12]])})))).apply(this,arguments)}function Zo(e,t){(e.jo.get(t)||[]).forEach((function(e){e.resolve()})),e.jo.delete(t)}function Co(e,t,n){var r=F(e),i=r.Ko[r.currentUser.toKey()];if(i){var a=i.get(t);a&&(n?a.reject(n):a.resolve(),i=i.remove(t)),r.Ko[r.currentUser.toKey()]=i}}function Ro(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e.sharedClientState.removeLocalQueryTarget(t);var r,i=w(e.Fo.get(t));try{for(i.s();!(r=i.n()).done;){var a=r.value;e.Mo.delete(a),n&&e.Oo.zo(a,n)}}catch(u){i.e(u)}finally{i.f()}e.Fo.delete(t),e.isPrimaryClient&&e.qo.us(t).forEach((function(t){e.qo.containsKey(t)||Lo(e,t)}))}function Lo(e,t){e.Lo.delete(t.path.canonicalString());var n=e.Bo.get(t);null!==n&&(uu(e.remoteStore,n),e.Bo=e.Bo.remove(t),e.Uo.delete(n),Oo(e))}function Mo(e,t,n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a instanceof ao?(e.qo.addReference(a.key,t),Fo(e,a)):a instanceof uo?(N("SyncEngine","Document no longer in limbo: "+a.key),e.qo.removeReference(a.key,t),e.qo.containsKey(a.key)||Lo(e,a.key)):R()}}catch(u){i.e(u)}finally{i.f()}}function Fo(e,t){var n=t.key,r=n.path.canonicalString();e.Bo.get(n)||e.Lo.has(r)||(N("SyncEngine","New document in limbo: "+n),e.Lo.add(r),Oo(e))}function Oo(e){for(;e.Lo.size>0&&e.Bo.size<e.maxConcurrentLimboResolutions;){var t=e.Lo.values().next().value;e.Lo.delete(t);var n=new xe(ue.fromString(t)),r=e.Qo.next();e.Uo.set(r,new co(n)),e.Bo=e.Bo.insert(n,r),au(e.remoteStore,new Wr(yt(st(n.path)),r,2,W.I))}}function Po(e,t,n){return Vo.apply(this,arguments)}function Vo(){return Vo=(0,u.Z)(v().mark((function e(t,n,r){var i,a,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=F(t),a=[],o=[],s=[],e.t0=i.Mo.isEmpty(),e.t0){e.next=9;break}return i.Mo.forEach((function(e,t){s.push(i.Go(t,n,r).then((function(e){if(e){i.isPrimaryClient&&i.sharedClientState.updateQueryState(t.targetId,e.fromCache?"not-current":"current"),a.push(e);var n=Ji.$n(t.targetId,e);o.push(n)}})))})),e.next=6,Promise.all(s);case 6:return i.Oo.br(a),e.next=9,function(){var e=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o,s,c,l;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),e.prev=1,e.next=4,r.persistence.runTransaction("notifyLocalViewChanges","readwrite",(function(e){return Lr.forEach(n,(function(t){return Lr.forEach(t.kn,(function(n){return r.persistence.referenceDelegate.addReference(e,t.targetId,n)})).next((function(){return Lr.forEach(t.xn,(function(n){return r.persistence.referenceDelegate.removeReference(e,t.targetId,n)}))}))}))}));case 4:e.next=11;break;case 6:if(e.prev=6,e.t0=e.catch(1),Vr(e.t0)){e.next=10;break}throw e.t0;case 10:N("LocalStore","Failed to update sequence numbers: "+e.t0);case 11:i=w(n);try{for(i.s();!(a=i.n()).done;)u=a.value,o=u.targetId,u.fromCache||(s=r.qn.get(o),c=s.snapshotVersion,l=s.withLastLimboFreeSnapshotVersion(c),r.qn=r.qn.insert(o,l))}catch(f){i.e(f)}finally{i.f()}case 13:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(t,n){return e.apply(this,arguments)}}()(i.localStore,o);case 9:case"end":return e.stop()}}),e)}))),Vo.apply(this,arguments)}function qo(e,t){return Uo.apply(this,arguments)}function Uo(){return(Uo=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=F(t)).currentUser.isEqual(n)){e.next=11;break}return N("SyncEngine","User change. New user:",n.toKey()),e.next=5,ta(r.localStore,n);case 5:return i=e.sent,r.currentUser=n,function(e,t){e.jo.forEach((function(e){e.forEach((function(e){e.reject(new P(O.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.jo.clear()}(r),r.sharedClientState.handleUserChange(n,i.removedBatchIds,i.addedBatchIds),e.next=11,Po(r,i.Gn);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Bo(e,t){var n=F(e),r=n.Uo.get(t);if(r&&r.$o)return kn().add(r.key);var i=kn(),a=n.Fo.get(t);if(!a)return i;var u,o=w(a);try{for(o.s();!(u=o.n()).done;){var s=u.value,c=n.Mo.get(s);i=i.unionWith(c.view.bo)}}catch(l){o.e(l)}finally{o.f()}return i}function Ko(e,t){return jo.apply(this,arguments)}function jo(){return(jo=(0,u.Z)(v().mark((function e(t,n){var r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),e.next=3,fa(r.localStore,n.query,!0);case 3:return i=e.sent,a=n.view.ko(i),e.abrupt("return",(r.isPrimaryClient&&Mo(r,n.targetId,a.Co),a));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Go(e){return zo.apply(this,arguments)}function zo(){return(zo=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=F(t),e.abrupt("return",da(n.localStore).then((function(e){return Po(n,e)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qo(e,t,n,r){return Wo.apply(this,arguments)}function Wo(){return(Wo=(0,u.Z)(v().mark((function e(t,n,r,i){var a,u;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=F(t),e.next=3,function(e,t){var n=F(e),r=F(n.An);return n.persistence.runTransaction("Lookup mutation documents","readonly",(function(e){return r.Zt(e,t).next((function(t){return t?n.Wn.vn(e,t):Lr.resolve(null)}))}))}(a.localStore,n);case 3:if(null===(u=e.sent)){e.next=15;break}if("pending"!==r){e.next=10;break}return e.next=8,xu(a.remoteStore);case 8:e.next=11;break;case 10:"acknowledged"===r||"rejected"===r?(Co(a,n,i||null),Zo(a,n),function(e,t){F(F(e).An).ee(t)}(a.localStore,n)):R();case 11:return e.next=13,Po(a,u);case 13:e.next=16;break;case 15:N("SyncEngine","Cannot apply mutation batch with id: "+n);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ho(e,t){return Yo.apply(this,arguments)}function Yo(){return(Yo=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o,s,c,l;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(as(r=F(t)),us(r),!0!==n||!0===r.Wo){e.next=13;break}return i=r.sharedClientState.getAllActiveQueryTargets(),e.next=5,Jo(r,i.toArray());case 5:return a=e.sent,r.Wo=!0,e.next=9,Fu(r.remoteStore,!0);case 9:u=w(a);try{for(u.s();!(o=u.n()).done;)s=o.value,au(r.remoteStore,s)}catch(f){u.e(f)}finally{u.f()}e.next=25;break;case 13:if(!1!==n||!1===r.Wo){e.next=25;break}return c=[],l=Promise.resolve(),r.Fo.forEach((function(e,t){r.sharedClientState.isLocalQueryTarget(t)?c.push(t):l=l.then((function(){return Ro(r,t),ca(r.localStore,t,!0)})),uu(r.remoteStore,t)})),e.next=19,l;case 19:return e.next=21,Jo(r,c);case 21:return function(e){var t=F(e);t.Uo.forEach((function(e,n){uu(t.remoteStore,n)})),t.qo.hs(),t.Uo=new Map,t.Bo=new on(xe.comparator)}(r),r.Wo=!1,e.next=25,Fu(r.remoteStore,!1);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Jo(e,t,n){return Xo.apply(this,arguments)}function Xo(){return(Xo=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u,o,s,c,l,f,h,d,y,p,m,g;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=F(t),a=[],u=[],o=w(n),e.prev=2,o.s();case 4:if((s=o.n()).done){e.next=45;break}if(c=s.value,l=void 0,!(f=i.Fo.get(c))||0===f.length){e.next=34;break}return e.next=11,sa(i.localStore,yt(f[0]));case 11:l=e.sent,h=w(f),e.prev=13,h.s();case 15:if((d=h.n()).done){e.next=24;break}return y=d.value,p=i.Mo.get(y),e.next=20,Ko(i,p);case 20:(m=e.sent).snapshot&&u.push(m.snapshot);case 22:e.next=15;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(13),h.e(e.t0);case 29:return e.prev=29,h.f(),e.finish(29);case 32:e.next=42;break;case 34:return e.next=36,ha(i.localStore,c);case 36:return g=e.sent,e.next=39,sa(i.localStore,g);case 39:return l=e.sent,e.next=42,vo(i,$o(g),c,!1);case 42:a.push(l);case 43:e.next=4;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(2),o.e(e.t1);case 50:return e.prev=50,o.f(),e.finish(50);case 53:return e.abrupt("return",(i.Oo.br(u),a));case 54:case"end":return e.stop()}}),e,null,[[2,47,50,53],[13,26,29,32]])})))).apply(this,arguments)}function $o(e){return ot(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function es(e){var t=F(e);return F(F(t.localStore).persistence).Tn()}function ts(e,t,n,r){return ns.apply(this,arguments)}function ns(){return(ns=(0,u.Z)(v().mark((function e(t,n,r,i){var a,u,o;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=F(t)).Wo){e.next=5;break}N("SyncEngine","Ignoring unexpected query state notification."),e.next=21;break;case 5:if(!a.Fo.has(n)){e.next=21;break}e.t0=r,e.next="current"===e.t0||"not-current"===e.t0?9:"rejected"===e.t0?16:20;break;case 9:return e.next=11,da(a.localStore);case 11:return u=e.sent,o=xn.createSynthesizedRemoteEventForCurrentChange(n,"current"===r),e.next=15,Po(a,u,o);case 15:return e.abrupt("break",21);case 16:return e.next=18,ca(a.localStore,n,!0);case 18:return Ro(a,n,i),e.abrupt("break",21);case 20:R();case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function rs(e,t,n){return is.apply(this,arguments)}function is(){return(is=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u,o,s,c,l,f,h;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=as(t)).Wo){e.next=45;break}a=w(n),e.prev=3,a.s();case 5:if((u=a.n()).done){e.next=21;break}if(o=u.value,!i.Fo.has(o)){e.next=10;break}return N("SyncEngine","Adding an already active target "+o),e.abrupt("continue",19);case 10:return e.next=12,ha(i.localStore,o);case 12:return s=e.sent,e.next=15,sa(i.localStore,s);case 15:return c=e.sent,e.next=18,vo(i,$o(s),c.targetId,!1);case 18:au(i.remoteStore,c);case 19:e.next=5;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(3),a.e(e.t0);case 26:return e.prev=26,a.f(),e.finish(26);case 29:l=w(r),e.prev=30,h=v().mark((function e(){var t;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=f.value,e.t0=i.Fo.has(t),!e.t0){e.next=5;break}return e.next=5,ca(i.localStore,t,!1).then((function(){uu(i.remoteStore,t),Ro(i,t)})).catch(Ai);case 5:case"end":return e.stop()}}),e)})),l.s();case 33:if((f=l.n()).done){e.next=37;break}return e.delegateYield(h(),"t1",35);case 35:e.next=33;break;case 37:e.next=42;break;case 39:e.prev=39,e.t2=e.catch(30),l.e(e.t2);case 42:return e.prev=42,l.f(),e.finish(42);case 45:case"end":return e.stop()}}),e,null,[[3,23,26,29],[30,39,42,45]])})))).apply(this,arguments)}function as(e){var t=F(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=wo.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Bo.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Io.bind(null,t),t.Oo.br=Ju.bind(null,t.eventManager),t.Oo.zo=Xu.bind(null,t.eventManager),t}function us(e){var t=F(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Eo.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Ao.bind(null,t),t}function os(e,t,n){var r,i=F(e);(r=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.getMetadata();case 3:return i=e.sent,e.next=6,function(e,t){var n=F(e),r=On(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(function(e){return n.Ye.getBundleMetadata(e,t.id)})).then((function(e){return!!e&&e.createTime.compareTo(r)>=0}))}(t.localStore,i);case 6:if(!e.sent){e.next=10;break}return e.next=9,n.close();case 9:return e.abrupt("return",void r._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(i)));case 10:return r._updateProgress(io(i)),a=new ro(i,t.localStore,n.k),e.next=14,n.Ho();case 14:u=e.sent;case 15:if(!u){e.next=25;break}return e.next=18,a.yo(u);case 18:return(o=e.sent)&&r._updateProgress(o),e.next=22,n.Ho();case 22:u=e.sent;case 23:e.next=15;break;case 25:return e.next=27,a.complete();case 27:return s=e.sent,e.next=30,Po(t,s.In,void 0);case 30:return e.next=32,function(e,t){var n=F(e);return n.persistence.runTransaction("Save bundle","readwrite",(function(e){return n.Ye.saveBundleMetadata(e,t)}))}(t.localStore,i);case 32:r._completeWith(s.progress),e.next=38;break;case 35:e.prev=35,e.t0=e.catch(0),Z("SyncEngine","Loading bundle failed with ".concat(e.t0)),r._failWith(e.t0);case 38:case"end":return e.stop()}}),e,null,[[0,35]])}))),function(e,t,n){return r.apply(this,arguments)})(i,t,n).then((function(){i.sharedClientState.notifyBundleLoaded()}))}var ss=function(){function e(){(0,f.Z)(this,e),this.synchronizeTabs=!1}var t,n;return(0,h.Z)(e,[{key:"initialize",value:(n=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.k=Qa(t.databaseInfo.databaseId),this.sharedClientState=this.Jo(t),this.persistence=this.Yo(t),e.next=5,this.persistence.start();case 5:this.gcScheduler=this.Xo(t),this.localStore=this.Zo(t);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"Xo",value:function(e){return null}},{key:"Zo",value:function(e){return ea(this.persistence,new Xi,e.initialUser,this.k)}},{key:"Yo",value:function(e){return new Aa(Na.ks,this.k)}},{key:"Jo",value:function(e){return new Va}},{key:"terminate",value:(t=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.gcScheduler&&this.gcScheduler.stop(),e.next=3,this.sharedClientState.shutdown();case 3:return e.next=5,this.persistence.shutdown();case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),cs=function(e){(0,o.Z)(r,e);var t,n=x(r);function r(e,t,i){var a;return(0,f.Z)(this,r),(a=n.call(this)).tc=e,a.cacheSizeBytes=t,a.forceOwnership=i,a.synchronizeTabs=!1,a}return(0,h.Z)(r,[{key:"initialize",value:(t=(0,u.Z)(v().mark((function e(t){var n=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.Z)((0,c.Z)(r.prototype),"initialize",this).call(this,t);case 2:return e.next=4,va(this.localStore);case 4:return e.next=6,this.tc.initialize(this,t);case 6:return e.next=8,us(this.tc.syncEngine);case 8:return e.next=10,xu(this.tc.remoteStore);case 10:return e.next=12,this.persistence.sn((function(){return n.gcScheduler&&!n.gcScheduler.started&&n.gcScheduler.start(n.localStore),Promise.resolve()}));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"Zo",value:function(e){return ea(this.persistence,new Xi,e.initialUser,this.k)}},{key:"Xo",value:function(e){var t=this.persistence.referenceDelegate.garbageCollector;return new Zi(t,e.asyncQueue)}},{key:"Yo",value:function(e){var t=Wi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?vi.withCacheSize(this.cacheSizeBytes):vi.DEFAULT;return new Gi(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Ga(),za(),this.k,this.sharedClientState,!!this.forceOwnership)}},{key:"Jo",value:function(e){return new Va}}]),r}(ss),ls=function(e){(0,o.Z)(r,e);var t,n=x(r);function r(e,t){var i;return(0,f.Z)(this,r),(i=n.call(this,e,t,!1)).tc=e,i.cacheSizeBytes=t,i.synchronizeTabs=!0,i}return(0,h.Z)(r,[{key:"initialize",value:(t=(0,u.Z)(v().mark((function e(t){var n,a=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.Z)((0,c.Z)(r.prototype),"initialize",this).call(this,t);case 2:if(n=this.tc.syncEngine,e.t0=this.sharedClientState instanceof Pa,!e.t0){e.next=8;break}return this.sharedClientState.syncEngine={mi:Qo.bind(null,n),gi:ts.bind(null,n),yi:rs.bind(null,n),Tn:es.bind(null,n),_i:Go.bind(null,n)},e.next=8,this.sharedClientState.start();case 8:return e.next=10,this.persistence.sn(function(){var e=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ho(a.tc.syncEngine,t);case 2:a.gcScheduler&&(t&&!a.gcScheduler.started?a.gcScheduler.start(a.localStore):t||a.gcScheduler.stop());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"Jo",value:function(e){var t=Ga();if(!Pa.Pt(t))throw new P(O.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Wi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Pa(t,e.asyncQueue,n,e.clientId,e.initialUser)}}]),r}(cs),fs=function(){function e(){(0,f.Z)(this,e)}var t;return(0,h.Z)(e,[{key:"initialize",value:(t=(0,u.Z)(v().mark((function e(t,n){var r=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.localStore,e.t0){e.next=12;break}return this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(n),this.remoteStore=this.createRemoteStore(n),this.eventManager=this.createEventManager(n),this.syncEngine=this.createSyncEngine(n,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(e){return xo(r.syncEngine,e,1)},this.remoteStore.remoteSyncer.handleCredentialChange=qo.bind(null,this.syncEngine),e.next=12,Fu(this.remoteStore,this.syncEngine.isPrimaryClient);case 12:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"createEventManager",value:function(e){return new zu}},{key:"createDatastore",value:function(e){var t,n=Qa(e.databaseInfo.databaseId),r=(t=e.databaseInfo,new ja(t));return function(e,t,n,r){return new Xa(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,r,n)}},{key:"createRemoteStore",value:function(e){var t,n,r,i,a,u=this;return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=function(e){return xo(u.syncEngine,e,0)},a=Ua.Pt()?new Ua:new qa,new eu(t,n,r,i,a)}},{key:"createSyncEngine",value:function(e,t){return function(e,t,n,r,i,a,u){var o=new lo(e,t,n,r,i,a);return u&&(o.Wo=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}},{key:"terminate",value:function(){return(e=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=F(t),N("RemoteStore","RemoteStore shutting down."),n.Gr.add(5),e.next=5,ru(n);case 5:n.Hr.shutdown(),n.Jr.set("Unknown");case 7:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})(this.remoteStore);var e}}]),e}();function hs(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10240,n=0;return{read:function(){return(0,u.Z)(v().mark((function r(){var i;return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(n<e.byteLength)){r.next=3;break}return i={value:e.slice(n,n+t),done:!1},r.abrupt("return",(n+=t,i));case 3:return r.abrupt("return",{done:!0});case 4:case"end":return r.stop()}}),r)})))()},cancel:function(){return(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},releaseLock:function(){},closed:Promise.reject("unimplemented")}}var ds=function(){function e(t){(0,f.Z)(this,e),this.observer=t,this.muted=!1}return(0,h.Z)(e,[{key:"next",value:function(e){this.observer.next&&this.ec(this.observer.next,e)}},{key:"error",value:function(e){this.observer.error?this.ec(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}},{key:"nc",value:function(){this.muted=!0}},{key:"ec",value:function(e,t){var n=this;this.muted||setTimeout((function(){n.muted||e(t)}),0)}}]),e}(),vs=function(){function e(t,n){var r=this;(0,f.Z)(this,e),this.sc=t,this.k=n,this.metadata=new V,this.buffer=new Uint8Array,this.ic=new TextDecoder("utf-8"),this.rc().then((function(e){e&&e._o()?r.metadata.resolve(e.payload.metadata):r.metadata.reject(new Error("The first element of the bundle is not a metadata, it is\n             ".concat(JSON.stringify(null==e?void 0:e.payload))))}),(function(e){return r.metadata.reject(e)}))}var t,n,r,i,a,o;return(0,h.Z)(e,[{key:"close",value:function(){return this.sc.cancel()}},{key:"getMetadata",value:(o=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.metadata.promise);case 1:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"Ho",value:(a=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getMetadata();case 2:return e.abrupt("return",this.rc());case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"rc",value:(i=(0,u.Z)(v().mark((function e(){var t,n,r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.oc();case 2:if(null!==(t=e.sent)){e.next=5;break}return e.abrupt("return",null);case 5:return n=this.ic.decode(t),r=Number(n),isNaN(r)&&this.cc("length string (".concat(n,") is not valid number")),e.next=9,this.ac(r);case 9:return i=e.sent,e.abrupt("return",new to(JSON.parse(i),t.length+r));case 11:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"uc",value:function(){return this.buffer.findIndex((function(e){return e==="{".charCodeAt(0)}))}},{key:"oc",value:(r=(0,u.Z)(v().mark((function e(){var t,n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.uc()<0)){e.next=7;break}return e.next=3,this.hc();case 3:if(!e.sent){e.next=5;break}return e.abrupt("break",7);case 5:e.next=0;break;case 7:if(0!==this.buffer.length){e.next=9;break}return e.abrupt("return",null);case 9:return(t=this.uc())<0&&this.cc("Reached the end of bundle when a length string is expected."),n=this.buffer.slice(0,t),e.abrupt("return",(this.buffer=this.buffer.slice(t),n));case 13:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"ac",value:(n=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.buffer.length<t)){e.next=8;break}return e.next=3,this.hc();case 3:if(e.t0=e.sent,!e.t0){e.next=6;break}this.cc("Reached the end of bundle when more is expected.");case 6:e.next=0;break;case 8:return n=this.ic.decode(this.buffer.slice(0,t)),e.abrupt("return",(this.buffer=this.buffer.slice(t),n));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"cc",value:function(e){throw this.sc.cancel(),new Error("Invalid bundle format: ".concat(e))}},{key:"hc",value:(t=(0,u.Z)(v().mark((function e(){var t,n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sc.read();case 2:return(t=e.sent).done||((n=new Uint8Array(this.buffer.length+t.value.length)).set(this.buffer),n.set(t.value,this.buffer.length),this.buffer=n),e.abrupt("return",t.done);case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),ys=function(){function e(t){(0,f.Z)(this,e),this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}var t,n;return(0,h.Z)(e,[{key:"lookup",value:(n=(0,u.Z)(v().mark((function e(t){var n,r=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.ensureCommitNotCalled(),!(this.mutations.length>0)){e.next=2;break}throw new P(O.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");case 2:return e.next=4,function(){var e=(0,u.Z)(v().mark((function e(t,n){var r,i,a,u,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),i=jn(r.k)+"/documents",a={documents:n.map((function(e){return qn(r.k,e)}))},e.next=5,r.ji("BatchGetDocuments",i,a);case 5:return u=e.sent,o=new Map,u.forEach((function(e){var t=Wn(r.k,e);o.set(t.key.toString(),t)})),s=[],e.abrupt("return",(n.forEach((function(e){var t=o.get(e.toString());L(!!t),s.push(t)})),s));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(this.datastore,t);case 4:return n=e.sent,e.abrupt("return",(n.forEach((function(e){return r.recordVersion(e)})),n));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"set",value:function(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}},{key:"update",value:function(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}},{key:"delete",value:function(e){this.write(new tn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}},{key:"commit",value:(t=(0,u.Z)(v().mark((function e(){var t,n=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.ensureCommitNotCalled(),!this.lastWriteError){e.next=2;break}throw this.lastWriteError;case 2:return t=this.readVersions,this.mutations.forEach((function(e){t.delete(e.key.toString())})),t.forEach((function(e,t){var r=xe.fromPath(t);n.mutations.push(new nn(r,n.precondition(r)))})),e.next=7,function(){var e=(0,u.Z)(v().mark((function e(t,n){var r,i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t),i=jn(r.k)+"/documents",a={writes:n.map((function(e){return Hn(r.k,e)}))},e.next=3,r.Bi("Commit",i,a);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(this.datastore,this.mutations);case 7:this.committed=!0;case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"recordVersion",value:function(e){var t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw R();t=te.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new P(O.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}},{key:"precondition",value:function(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?qt.updateTime(t):qt.none()}},{key:"preconditionForUpdate",value:function(e){var t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(te.min()))throw new P(O.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return qt.updateTime(t)}return qt.exists(!0)}},{key:"write",value:function(e){this.ensureCommitNotCalled(),this.mutations.push(e)}},{key:"ensureCommitNotCalled",value:function(){}}]),e}(),ps=function(){function e(t,n,r,i){(0,f.Z)(this,e),this.asyncQueue=t,this.datastore=n,this.updateFunction=r,this.deferred=i,this.lc=5,this.ur=new Wa(this.asyncQueue,"transaction_retry")}return(0,h.Z)(e,[{key:"run",value:function(){this.lc-=1,this.fc()}},{key:"fc",value:function(){var e=this;this.ur.Zi((0,u.Z)(v().mark((function t(){var n,r;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=new ys(e.datastore),(r=e.dc(n))&&r.then((function(t){e.asyncQueue.enqueueAndForget((function(){return n.commit().then((function(){e.deferred.resolve(t)})).catch((function(t){e.wc(t)}))}))})).catch((function(t){e.wc(t)}));case 2:case"end":return t.stop()}}),t)}))))}},{key:"dc",value:function(e){try{var t=this.updateFunction(e);return!ke(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}},{key:"wc",value:function(e){var t=this;this.lc>0&&this._c(e)?(this.lc-=1,this.asyncQueue.enqueueAndForget((function(){return t.fc(),Promise.resolve()}))):this.deferred.reject(e)}},{key:"_c",value:function(e){if("FirebaseError"===e.name){var t=e.code;return"aborted"===t||"failed-precondition"===t||!an(t)}return!1}}]),e}(),ms=function(){function e(t,n,r,i){var a=this;(0,f.Z)(this,e),this.authCredentials=t,this.appCheckCredentials=n,this.asyncQueue=r,this.databaseInfo=i,this.user=T.UNAUTHENTICATED,this.clientId=Y.A(),this.authCredentialListener=function(){return Promise.resolve()},this.authCredentials.start(r,function(){var e=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return N("FirestoreClient","Received user=",t.uid),e.next=3,a.authCredentialListener(t);case 3:a.user=t;case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.appCheckCredentials.start(r,(function(){return Promise.resolve()}))}var t;return(0,h.Z)(e,[{key:"getConfiguration",value:(t=(0,u.Z)(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100});case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"setCredentialChangeListener",value:function(e){this.authCredentialListener=e}},{key:"verifyNotTerminated",value:function(){if(this.asyncQueue.isShuttingDown)throw new P(O.FAILED_PRECONDITION,"The client has already been terminated.")}},{key:"terminate",value:function(){var e=this;this.asyncQueue.enterRestrictedMode();var t=new V;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((0,u.Z)(v().mark((function n(){var r;return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,n.t0=e.onlineComponents,!n.t0){n.next=5;break}return n.next=5,e.onlineComponents.terminate();case 5:if(n.t1=e.offlineComponents,!n.t1){n.next=9;break}return n.next=9,e.offlineComponents.terminate();case 9:e.authCredentials.shutdown(),e.appCheckCredentials.shutdown(),t.resolve(),n.next=18;break;case 14:n.prev=14,n.t2=n.catch(0),r=Uu(n.t2,"Failed to shutdown persistence"),t.reject(r);case 18:case"end":return n.stop()}}),n,null,[[0,14]])})))),t.promise}}]),e}();function gs(e,t){return ks.apply(this,arguments)}function ks(){return ks=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.asyncQueue.verifyOperationInProgress(),N("FirestoreClient","Initializing OfflineComponentProvider"),e.next=3,t.getConfiguration();case 3:return r=e.sent,e.next=6,n.initialize(r);case 6:i=r.initialUser,t.setCredentialChangeListener(function(){var e=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=i.isEqual(t),e.t0){e.next=5;break}return e.next=4,ta(n.localStore,t);case 4:i=t;case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.persistence.setDatabaseDeletedListener((function(){return t.terminate()})),t.offlineComponents=n;case 8:case"end":return e.stop()}}),e)}))),ks.apply(this,arguments)}function ws(e,t){return bs.apply(this,arguments)}function bs(){return bs=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.asyncQueue.verifyOperationInProgress(),e.next=3,xs(t);case 3:return r=e.sent,N("FirestoreClient","Initializing OnlineComponentProvider"),e.next=7,t.getConfiguration();case 7:return i=e.sent,e.next=10,n.initialize(r,i);case 10:t.setCredentialChangeListener((function(e){return(t=(0,u.Z)(v().mark((function e(t,n){var r,i;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=F(t)).asyncQueue.verifyOperationInProgress(),N("RemoteStore","RemoteStore received new credentials"),i=fu(r),r.Gr.add(3),e.next=6,ru(r);case 6:return i&&r.Jr.set("Unknown"),e.next=9,r.remoteSyncer.handleCredentialChange(n);case 9:return r.Gr.delete(3),e.next=12,tu(r);case 12:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})(n.remoteStore,e);var t})),t.onlineComponents=n;case 12:case"end":return e.stop()}}),e)}))),bs.apply(this,arguments)}function xs(e){return Is.apply(this,arguments)}function Is(){return(Is=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.offlineComponents,e.t0){e.next=5;break}return N("FirestoreClient","Using default OfflineComponentProvider"),e.next=5,gs(t,new ss);case 5:return e.abrupt("return",t.offlineComponents);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ts(e){return Es.apply(this,arguments)}function Es(){return(Es=(0,u.Z)(v().mark((function e(t){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.onlineComponents,e.t0){e.next=5;break}return N("FirestoreClient","Using default OnlineComponentProvider"),e.next=5,ws(t,new fs);case 5:return e.abrupt("return",t.onlineComponents);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ss(e){return xs(e).then((function(e){return e.persistence}))}function As(e){return xs(e).then((function(e){return e.localStore}))}function _s(e){return Ts(e).then((function(e){return e.remoteStore}))}function Ns(e){return Ts(e).then((function(e){return e.syncEngine}))}function Ds(e){return Zs.apply(this,arguments)}function Zs(){return(Zs=(0,u.Z)(v().mark((function e(t){var n,r;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ts(t);case 2:return n=e.sent,r=n.eventManager,e.abrupt("return",(r.onListen=fo.bind(null,n.syncEngine),r.onUnlisten=po.bind(null,n.syncEngine),r));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Cs(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function i(){return v().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=function(e,t,n,r,i){var a=new ds({next:function(a){t.enqueueAndForget((function(){return Hu(e,u)}));var o=a.docs.has(n);!o&&a.fromCache?i.reject(new P(O.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&a.fromCache&&r&&"server"===r.source?i.reject(new P(O.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(a)},error:function(e){return i.reject(e)}}),u=new eo(st(n.path),a,{includeMetadataChanges:!0,wo:!0});return Qu(e,u)},i.next=3,Ds(e);case 3:return i.t1=i.sent,i.t2=e.asyncQueue,i.t3=t,i.t4=n,i.t5=r,i.abrupt("return",(0,i.t0)(i.t1,i.t2,i.t3,i.t4,i.t5));case 9:case"end":return i.stop()}}),i)})))),r.promise}function Rs(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function i(){return v().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=function(e,t,n,r,i){var a=new ds({next:function(n){t.enqueueAndForget((function(){return Hu(e,u)})),n.fromCache&&"server"===r.source?i.reject(new P(O.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:function(e){return i.reject(e)}}),u=new eo(n,a,{includeMetadataChanges:!0,wo:!0});return Qu(e,u)},i.next=3,Ds(e);case 3:return i.t1=i.sent,i.t2=e.asyncQueue,i.t3=t,i.t4=n,i.t5=r,i.abrupt("return",(0,i.t0)(i.t1,i.t2,i.t3,i.t4,i.t5));case 9:case"end":return i.stop()}}),i)})))),r.promise}var Ls=(0,h.Z)((function e(t,n,r,i,a,u,o,s){(0,f.Z)(this,e),this.databaseId=t,this.appId=n,this.persistenceKey=r,this.host=i,this.ssl=a,this.forceLongPolling=u,this.autoDetectLongPolling=o,this.useFetchStreams=s})),Ms=function(){function e(t,n){(0,f.Z)(this,e),this.projectId=t,this.database=n||"(default)"}return(0,h.Z)(e,[{key:"isDefaultDatabase",get:function(){return"(default)"===this.database}},{key:"isEqual",value:function(t){return t instanceof e&&t.projectId===this.projectId&&t.database===this.database}}]),e}(),Fs=new Map;function Os(e,t,n){if(!n)throw new P(O.INVALID_ARGUMENT,"Function ".concat(e,"() cannot be called with an empty ").concat(t,"."))}function Ps(e,t,n,r){if(!0===t&&!0===r)throw new P(O.INVALID_ARGUMENT,"".concat(e," and ").concat(n," cannot be used together."))}function Vs(e){if(!xe.isDocumentKey(e))throw new P(O.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but ".concat(e," has ").concat(e.length,"."))}function qs(e){if(xe.isDocumentKey(e))throw new P(O.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but ".concat(e," has ").concat(e.length,"."))}function Us(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e="".concat(e.substring(0,20),"...")),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";var t=function(e){return e.constructor?e.constructor.name:null}(e);return t?"a custom ".concat(t," object"):"an object"}return"function"==typeof e?"a function":R()}function Bs(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new P(O.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Us(e);throw new P(O.INVALID_ARGUMENT,"Expected type '".concat(t.name,"', but it was: ").concat(n))}return e}function Ks(e,t){if(t<=0)throw new P(O.INVALID_ARGUMENT,"Function ".concat(e,"() requires a positive number, but it was: ").concat(t,"."))}var js=function(){function e(t){var n;if((0,f.Z)(this,e),void 0===t.host){if(void 0!==t.ssl)throw new P(O.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(n=t.ssl)||void 0===n||n;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new P(O.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Ps("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}return(0,h.Z)(e,[{key:"isEqual",value:function(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}]),e}(),Gs=function(){function e(t,n,r){(0,f.Z)(this,e),this._authCredentials=n,this._appCheckCredentials=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new js({}),this._settingsFrozen=!1,t instanceof Ms?this._databaseId=t:(this._app=t,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new P(O.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ms(e.options.projectId)}(t))}return(0,h.Z)(e,[{key:"app",get:function(){if(!this._app)throw new P(O.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}},{key:"_initialized",get:function(){return this._settingsFrozen}},{key:"_terminated",get:function(){return void 0!==this._terminateTask}},{key:"_setSettings",value:function(e){if(this._settingsFrozen)throw new P(O.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new js(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new U;switch(e.type){case"gapi":var t=e.client;return L(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new G(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new P(O.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}},{key:"_getSettings",value:function(){return this._settings}},{key:"_freezeSettings",value:function(){return this._settingsFrozen=!0,this._settings}},{key:"_delete",value:function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}},{key:"toJSON",value:function(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}},{key:"_terminate",value:function(){return e=this,(t=Fs.get(e))&&(N("ComponentProvider","Removing Datastore"),Fs.delete(e),t.terminate()),Promise.resolve();var e,t}}]),e}();function zs(e,t,n){var r,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=(e=Bs(e,Gs))._getSettings();if("firestore.googleapis.com"!==a.host&&a.host!==t&&Z("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},a),{host:"".concat(t,":").concat(n),ssl:!1})),i.mockUserToken){var u,o;if("string"==typeof i.mockUserToken)u=i.mockUserToken,o=T.MOCK_USER;else{u=(0,g.Sg)(i.mockUserToken,null===(r=e._app)||void 0===r?void 0:r.options.projectId);var s=i.mockUserToken.sub||i.mockUserToken.user_id;if(!s)throw new P(O.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");o=new T(s)}e._authCredentials=new B(new q(u,o))}}var Qs=function(){function e(t,n,r){(0,f.Z)(this,e),this.converter=n,this._key=r,this.type="document",this.firestore=t}return(0,h.Z)(e,[{key:"_path",get:function(){return this._key.path}},{key:"id",get:function(){return this._key.path.lastSegment()}},{key:"path",get:function(){return this._key.path.canonicalString()}},{key:"parent",get:function(){return new Hs(this.firestore,this.converter,this._key.path.popLast())}},{key:"withConverter",value:function(t){return new e(this.firestore,t,this._key)}}]),e}(),Ws=function(){function e(t,n,r){(0,f.Z)(this,e),this.converter=n,this._query=r,this.type="query",this.firestore=t}return(0,h.Z)(e,[{key:"withConverter",value:function(t){return new e(this.firestore,t,this._query)}}]),e}(),Hs=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this,e,r,st(i)))._path=i,a.type="collection",a}return(0,h.Z)(n,[{key:"id",get:function(){return this._query.path.lastSegment()}},{key:"path",get:function(){return this._query.path.canonicalString()}},{key:"parent",get:function(){var e=this._path.popLast();return e.isEmpty()?null:new Qs(this.firestore,null,new xe(e))}},{key:"withConverter",value:function(e){return new n(this.firestore,e,this._path)}}]),n}(Ws);function Ys(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(e=(0,g.m9)(e),Os("collection","path",t),e instanceof Gs){var a=ue.fromString.apply(ue,[t].concat(r));return qs(a),new Hs(e,null,a)}if(!(e instanceof Qs||e instanceof Hs))throw new P(O.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var u=e._path.child(ue.fromString.apply(ue,[t].concat(r)));return qs(u),new Hs(e.firestore,null,u)}function Js(e,t){if(e=Bs(e,Gs),Os("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new P(O.INVALID_ARGUMENT,"Invalid collection ID '".concat(t,"' passed to function collectionGroup(). Collection IDs must not contain '/'."));return new Ws(e,null,function(e){return new ut(ue.emptyPath(),e)}(t))}function Xs(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(e=(0,g.m9)(e),1===arguments.length&&(t=Y.A()),Os("doc","path",t),e instanceof Gs){var a=ue.fromString.apply(ue,[t].concat(r));return Vs(a),new Qs(e,null,new xe(a))}if(!(e instanceof Qs||e instanceof Hs))throw new P(O.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var u=e._path.child(ue.fromString.apply(ue,[t].concat(r)));return Vs(u),new Qs(e.firestore,e instanceof Hs?e.converter:null,new xe(u))}function $s(e,t){return e=(0,g.m9)(e),t=(0,g.m9)(t),(e instanceof Qs||e instanceof Hs)&&(t instanceof Qs||t instanceof Hs)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function ec(e,t){return e=(0,g.m9)(e),t=(0,g.m9)(t),e instanceof Ws&&t instanceof Ws&&e.firestore===t.firestore&&mt(e._query,t._query)&&e.converter===t.converter}var tc=function(){function e(){var t=this;(0,f.Z)(this,e),this.mc=Promise.resolve(),this.gc=[],this.yc=!1,this.Tc=[],this.Ec=null,this.Ic=!1,this.Ac=!1,this.Rc=[],this.ur=new Wa(this,"async_queue_retry"),this.bc=function(){var e=za();e&&N("AsyncQueue","Visibility state changed to "+e.visibilityState),t.ur.er()};var n=za();n&&"function"==typeof n.addEventListener&&n.addEventListener("visibilitychange",this.bc)}var t,n;return(0,h.Z)(e,[{key:"isShuttingDown",get:function(){return this.yc}},{key:"enqueueAndForget",value:function(e){this.enqueue(e)}},{key:"enqueueAndForgetEvenWhileRestricted",value:function(e){this.Pc(),this.vc(e)}},{key:"enterRestrictedMode",value:function(e){if(!this.yc){this.yc=!0,this.Ac=e||!1;var t=za();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.bc)}}},{key:"enqueue",value:function(e){var t=this;if(this.Pc(),this.yc)return new Promise((function(){}));var n=new V;return this.vc((function(){return t.yc&&t.Ac?Promise.resolve():(e().then(n.resolve,n.reject),n.promise)})).then((function(){return n.promise}))}},{key:"enqueueRetryable",value:function(e){var t=this;this.enqueueAndForget((function(){return t.gc.push(e),t.Vc()}))}},{key:"Vc",value:(n=(0,u.Z)(v().mark((function e(){var t=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.gc.length){e.next=14;break}return e.prev=1,e.next=4,this.gc[0]();case 4:this.gc.shift(),this.ur.reset(),e.next=13;break;case 8:if(e.prev=8,e.t0=e.catch(1),Vr(e.t0)){e.next=12;break}throw e.t0;case 12:N("AsyncQueue","Operation failed with retryable error: "+e.t0);case 13:this.gc.length>0&&this.ur.Zi((function(){return t.Vc()}));case 14:case"end":return e.stop()}}),e,this,[[1,8]])}))),function(){return n.apply(this,arguments)})},{key:"vc",value:function(e){var t=this,n=this.mc.then((function(){return t.Ic=!0,e().catch((function(e){t.Ec=e,t.Ic=!1;var n=function(e){var t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw D("INTERNAL UNHANDLED ERROR: ",n),e})).then((function(e){return t.Ic=!1,e}))}));return this.mc=n,n}},{key:"enqueueAfterDelay",value:function(e,t,n){var r=this;this.Pc(),this.Rc.indexOf(e)>-1&&(t=0);var i=qu.createAndSchedule(this,e,t,n,(function(e){return r.Sc(e)}));return this.Tc.push(i),i}},{key:"Pc",value:function(){this.Ec&&R()}},{key:"verifyOperationInProgress",value:function(){}},{key:"Dc",value:(t=(0,u.Z)(v().mark((function e(){var t;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.mc,e.next=3,t;case 3:if(t!==this.mc){e.next=0;break}case 4:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"Cc",value:function(e){var t,n=w(this.Tc);try{for(n.s();!(t=n.n()).done;){if(t.value.timerId===e)return!0}}catch(r){n.e(r)}finally{n.f()}return!1}},{key:"Nc",value:function(e){var t=this;return this.Dc().then((function(){t.Tc.sort((function(e,t){return e.targetTimeMs-t.targetTimeMs}));var n,r=w(t.Tc);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.skipDelay(),"all"!==e&&i.timerId===e)break}}catch(a){r.e(a)}finally{r.f()}return t.Dc()}))}},{key:"kc",value:function(e){this.Rc.push(e)}},{key:"Sc",value:function(e){var t=this.Tc.indexOf(e);this.Tc.splice(t,1)}}]),e}();function nc(e){return function(e,t){if("object"!=typeof e||null===e)return!1;var n,r=e,i=w(["next","error","complete"]);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a in r&&"function"==typeof r[a])return!0}}catch(u){i.e(u)}finally{i.f()}return!1}(e)}var rc=function(){function e(){(0,f.Z)(this,e),this._progressObserver={},this._taskCompletionResolver=new V,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}return(0,h.Z)(e,[{key:"onProgress",value:function(e,t,n){this._progressObserver={next:e,error:t,complete:n}}},{key:"catch",value:function(e){return this._taskCompletionResolver.promise.catch(e)}},{key:"then",value:function(e,t){return this._taskCompletionResolver.promise.then(e,t)}},{key:"_completeWith",value:function(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}},{key:"_failWith",value:function(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}},{key:"_updateProgress",value:function(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}]),e}(),ic=-1,ac=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this,e,r,i)).type="firestore",a._queue=new tc,a._persistenceKey="name"in e?e.name:"[DEFAULT]",a}return(0,h.Z)(n,[{key:"_terminate",value:function(){return this._firestoreClient||oc(this),this._firestoreClient.terminate()}}]),n}(Gs);function uc(e){return e._firestoreClient||oc(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function oc(e){var t,n=e._freezeSettings(),r=function(e,t,n,r){return new Ls(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new ms(e._authCredentials,e._appCheckCredentials,e._queue,r)}function sc(e,t){mc(e=Bs(e,ac));var n=uc(e),r=e._freezeSettings(),i=new fs;return lc(n,i,new cs(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function cc(e){mc(e=Bs(e,ac));var t=uc(e),n=e._freezeSettings(),r=new fs;return lc(t,r,new ls(r,n.cacheSizeBytes))}function lc(e,t,n){var r=new V;return e.asyncQueue.enqueue((0,u.Z)(v().mark((function i(){return v().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,gs(e,n);case 3:return i.next=5,ws(e,t);case 5:r.resolve(),i.next=13;break;case 8:if(i.prev=8,i.t0=i.catch(0),function(e){return"FirebaseError"===e.name?e.code===O.FAILED_PRECONDITION||e.code===O.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(i.t0)){i.next=12;break}throw i.t0;case 12:console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+i.t0),r.reject(i.t0);case 13:case"end":return i.stop()}}),i,null,[[0,8]])})))).then((function(){return r.promise}))}function fc(e){if(e._initialized&&!e._terminated)throw new P(O.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var t=new V;return e._queue.enqueueAndForgetEvenWhileRestricted((0,u.Z)(v().mark((function n(){return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,function(){var e=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Fr.Pt()){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:return n=t+"main",e.next=5,Fr.delete(n);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(Wi(e._databaseId,e._persistenceKey));case 3:t.resolve(),n.next=9;break;case 6:n.prev=6,n.t0=n.catch(0),t.reject(n.t0);case 9:case"end":return n.stop()}}),n,null,[[0,6]])})))),t.promise}function hc(e){return function(e){var t=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function n(){return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=No,n.next=3,Ns(e);case 3:return n.t1=n.sent,n.t2=t,n.abrupt("return",(0,n.t0)(n.t1,n.t2));case 6:case"end":return n.stop()}}),n)})))),t.promise}(uc(e=Bs(e,ac)))}function dc(e){return function(e){return e.asyncQueue.enqueue((0,u.Z)(v().mark((function t(){var n,r;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ss(e);case 2:return n=t.sent,t.next=5,_s(e);case 5:return r=t.sent,t.abrupt("return",(n.setNetworkEnabled(!0),function(e){var t=F(e);return t.Gr.delete(0),tu(t)}(r)));case 7:case"end":return t.stop()}}),t)}))))}(uc(e=Bs(e,ac)))}function vc(e){return function(e){return e.asyncQueue.enqueue((0,u.Z)(v().mark((function t(){var n,r;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ss(e);case 2:return n=t.sent,t.next=5,_s(e);case 5:return r=t.sent,t.abrupt("return",(n.setNetworkEnabled(!1),function(){var e=(0,u.Z)(v().mark((function e(t){var n;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=F(t)).Gr.add(0),e.next=4,ru(n);case 4:n.Jr.set("Offline");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(r)));case 7:case"end":return t.stop()}}),t)}))))}(uc(e=Bs(e,ac)))}function yc(e,t){var n=uc(e=Bs(e,ac)),r=new rc;return function(e,t,n,r){var i=function(e,t){return function(e,t){return new vs(e,t)}(function(e,t){if(e instanceof Uint8Array)return hs(e,t);if(e instanceof ArrayBuffer)return hs(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof e?(new TextEncoder).encode(e):e),t)}(n,Qa(t));e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=os,t.next=3,Ns(e);case 3:t.t1=t.sent,t.t2=i,t.t3=r,(0,t.t0)(t.t1,t.t2,t.t3);case 7:case"end":return t.stop()}}),t)}))))}(n,e._databaseId,t,r),r}function pc(e,t){return function(e,t){return e.asyncQueue.enqueue((0,u.Z)(v().mark((function n(){return v().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=function(e,t){var n=F(e);return n.persistence.runTransaction("Get named query","readonly",(function(e){return n.Ye.getNamedQuery(e,t)}))},n.next=3,As(e);case 3:return n.t1=n.sent,n.t2=t,n.abrupt("return",(0,n.t0)(n.t1,n.t2));case 6:case"end":return n.stop()}}),n)}))))}(uc(e=Bs(e,ac)),t).then((function(t){return t?new Ws(e,null,t.query):null}))}function mc(e){if(e._initialized||e._terminated)throw new P(O.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var gc=function(){function e(){(0,f.Z)(this,e);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0;i<n.length;++i)if(0===n[i].length)throw new P(O.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new se(n)}return(0,h.Z)(e,[{key:"isEqual",value:function(e){return this._internalPath.isEqual(e._internalPath)}}]),e}();var kc=function(){function e(t){(0,f.Z)(this,e),this._byteString=t}return(0,h.Z)(e,[{key:"toBase64",value:function(){return this._byteString.toBase64()}},{key:"toUint8Array",value:function(){return this._byteString.toUint8Array()}},{key:"toString",value:function(){return"Bytes(base64: "+this.toBase64()+")"}},{key:"isEqual",value:function(e){return this._byteString.isEqual(e._byteString)}}],[{key:"fromBase64String",value:function(t){try{return new e(fe.fromBase64String(t))}catch(t){throw new P(O.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}},{key:"fromUint8Array",value:function(t){return new e(fe.fromUint8Array(t))}}]),e}(),wc=(0,h.Z)((function e(t){(0,f.Z)(this,e),this._methodName=t})),bc=function(){function e(t,n){if((0,f.Z)(this,e),!isFinite(t)||t<-90||t>90)throw new P(O.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(n)||n<-180||n>180)throw new P(O.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+n);this._lat=t,this._long=n}return(0,h.Z)(e,[{key:"latitude",get:function(){return this._lat}},{key:"longitude",get:function(){return this._long}},{key:"isEqual",value:function(e){return this._lat===e._lat&&this._long===e._long}},{key:"toJSON",value:function(){return{latitude:this._lat,longitude:this._long}}},{key:"_compareTo",value:function(e){return J(this._lat,e._lat)||J(this._long,e._long)}}]),e}(),xc=/^__.*__$/,Ic=function(){function e(t,n,r){(0,f.Z)(this,e),this.data=t,this.fieldMask=n,this.fieldTransforms=r}return(0,h.Z)(e,[{key:"toMutation",value:function(e,t){return null!==this.fieldMask?new Ht(e,this.data,this.fieldMask,t,this.fieldTransforms):new Wt(e,this.data,t,this.fieldTransforms)}}]),e}(),Tc=function(){function e(t,n,r){(0,f.Z)(this,e),this.data=t,this.fieldMask=n,this.fieldTransforms=r}return(0,h.Z)(e,[{key:"toMutation",value:function(e,t){return new Ht(e,this.data,this.fieldMask,t,this.fieldTransforms)}}]),e}();function Ec(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw R()}}var Sc=function(){function e(t,n,r,i,a,u){(0,f.Z)(this,e),this.settings=t,this.databaseId=n,this.k=r,this.ignoreUndefinedProperties=i,void 0===a&&this.xc(),this.fieldTransforms=a||[],this.fieldMask=u||[]}return(0,h.Z)(e,[{key:"path",get:function(){return this.settings.path}},{key:"$c",get:function(){return this.settings.$c}},{key:"Oc",value:function(t){return new e(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}},{key:"Mc",value:function(e){var t,n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Oc({path:n,Fc:!1});return r.Lc(e),r}},{key:"Bc",value:function(e){var t,n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Oc({path:n,Fc:!1});return r.xc(),r}},{key:"Uc",value:function(e){return this.Oc({path:void 0,Fc:!0})}},{key:"qc",value:function(e){return zc(e,this.settings.methodName,this.settings.Kc||!1,this.path,this.settings.jc)}},{key:"contains",value:function(e){return void 0!==this.fieldMask.find((function(t){return e.isPrefixOf(t)}))||void 0!==this.fieldTransforms.find((function(t){return e.isPrefixOf(t.field)}))}},{key:"xc",value:function(){if(this.path)for(var e=0;e<this.path.length;e++)this.Lc(this.path.get(e))}},{key:"Lc",value:function(e){if(0===e.length)throw this.qc("Document fields must not be empty");if(Ec(this.$c)&&xc.test(e))throw this.qc('Document fields cannot begin and end with "__"')}}]),e}(),Ac=function(){function e(t,n,r){(0,f.Z)(this,e),this.databaseId=t,this.ignoreUndefinedProperties=n,this.k=r||Qa(t)}return(0,h.Z)(e,[{key:"Qc",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new Sc({$c:e,methodName:t,jc:n,path:se.emptyPath(),Fc:!1,Kc:r},this.databaseId,this.k,this.ignoreUndefinedProperties)}}]),e}();function _c(e){var t=e._freezeSettings(),n=Qa(e._databaseId);return new Ac(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Nc(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},u=e.Qc(a.merge||a.mergeFields?2:0,t,n,i);Bc("Data must be an object, but it was:",u,r);var o,s,c=qc(r,u);if(a.merge)o=new ce(u.fieldMask),s=u.fieldTransforms;else if(a.mergeFields){var l,f=[],h=w(a.mergeFields);try{for(h.s();!(l=h.n()).done;){var d=l.value,v=Kc(t,d,n);if(!u.contains(v))throw new P(O.INVALID_ARGUMENT,"Field '".concat(v,"' is specified in your field mask but missing from your input data."));Qc(f,v)||f.push(v)}}catch(y){h.e(y)}finally{h.f()}o=new ce(f),s=u.fieldTransforms.filter((function(e){return o.covers(e.field)}))}else o=null,s=u.fieldTransforms;return new Ic(new Oe(c),o,s)}var Dc=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"_toFieldTransform",value:function(e){if(2!==e.$c)throw 1===e.$c?e.qc("".concat(this._methodName,"() can only appear at the top level of your update data")):e.qc("".concat(this._methodName,"() cannot be used with set() unless you pass {merge:true}"));return e.fieldMask.push(e.path),null}},{key:"isEqual",value:function(e){return e instanceof n}}]),n}(wc);function Zc(e,t,n){return new Sc({$c:3,jc:t.settings.jc,methodName:e._methodName,Fc:n},t.databaseId,t.k,t.ignoreUndefinedProperties)}var Cc=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"_toFieldTransform",value:function(e){return new Pt(e.path,new Dt)}},{key:"isEqual",value:function(e){return e instanceof n}}]),n}(wc),Rc=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e)).Wc=r,i}return(0,h.Z)(n,[{key:"_toFieldTransform",value:function(e){var t=Zc(this,e,!0),n=this.Wc.map((function(e){return Vc(e,t)})),r=new Zt(n);return new Pt(e.path,r)}},{key:"isEqual",value:function(e){return this===e}}]),n}(wc),Lc=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e)).Wc=r,i}return(0,h.Z)(n,[{key:"_toFieldTransform",value:function(e){var t=Zc(this,e,!0),n=this.Wc.map((function(e){return Vc(e,t)})),r=new Rt(n);return new Pt(e.path,r)}},{key:"isEqual",value:function(e){return this===e}}]),n}(wc),Mc=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e)).Gc=r,i}return(0,h.Z)(n,[{key:"_toFieldTransform",value:function(e){var t=new Mt(e.k,Et(e.k,this.Gc));return new Pt(e.path,t)}},{key:"isEqual",value:function(e){return this===e}}]),n}(wc);function Fc(e,t,n,r){var i=e.Qc(1,t,n);Bc("Data must be an object, but it was:",i,r);var a=[],u=Oe.empty();re(r,(function(e,r){var o=Gc(t,e,n);r=(0,g.m9)(r);var s=i.Bc(o);if(r instanceof Dc)a.push(o);else{var c=Vc(r,s);null!=c&&(a.push(o),u.set(o,c))}}));var o=new ce(a);return new Tc(u,o,i.fieldTransforms)}function Oc(e,t,n,r,i,a){var u=e.Qc(1,t,n),o=[Kc(t,r,n)],s=[i];if(a.length%2!=0)throw new P(O.INVALID_ARGUMENT,"Function ".concat(t,"() needs to be called with an even number of arguments that alternate between field names and values."));for(var c=0;c<a.length;c+=2)o.push(Kc(t,a[c])),s.push(a[c+1]);for(var l=[],f=Oe.empty(),h=o.length-1;h>=0;--h)if(!Qc(l,o[h])){var d=o[h],v=s[h];v=(0,g.m9)(v);var y=u.Bc(d);if(v instanceof Dc)l.push(d);else{var p=Vc(v,y);null!=p&&(l.push(d),f.set(d,p))}}var m=new ce(l);return new Tc(f,m,u.fieldTransforms)}function Pc(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return Vc(n,e.Qc(r?4:3,t))}function Vc(e,t){if(Uc(e=(0,g.m9)(e)))return Bc("Unsupported field value:",t,e),qc(e,t);if(e instanceof wc)return function(e,t){if(!Ec(t.$c))throw t.qc("".concat(e._methodName,"() can only be used with update() and set()"));if(!t.path)throw t.qc("".concat(e._methodName,"() is not currently supported inside arrays"));var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Fc&&4!==t.$c)throw t.qc("Nested arrays are not supported");return function(e,t){var n,r=[],i=0,a=w(e);try{for(a.s();!(n=a.n()).done;){var u=Vc(n.value,t.Uc(i));null==u&&(u={nullValue:"NULL_VALUE"}),r.push(u),i++}}catch(o){a.e(o)}finally{a.f()}return{arrayValue:{values:r}}}(e,t)}return function(e,t){if(null===(e=(0,g.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Et(t.k,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ee.fromDate(e);return{timestampValue:Ln(t.k,n)}}if(e instanceof ee){var r=new ee(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Ln(t.k,r)}}if(e instanceof bc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof kc)return{bytesValue:Mn(t.k,e._byteString)};if(e instanceof Qs){var i=t.databaseId,a=e.firestore._databaseId;if(!a.isEqual(i))throw t.qc("Document reference is for database ".concat(a.projectId,"/").concat(a.database," but should be for database ").concat(i.projectId,"/").concat(i.database));return{referenceValue:Pn(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.qc("Unsupported field value: ".concat(Us(e)))}(e,t)}function qc(e,t){var n={};return ie(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):re(e,(function(e,r){var i=Vc(r,t.Mc(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function Uc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ee||e instanceof bc||e instanceof kc||e instanceof Qs||e instanceof wc)}function Bc(e,t,n){if(!Uc(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){var r=Us(n);throw"an object"===r?t.qc(e+" a custom object"):t.qc(e+" "+r)}}function Kc(e,t,n){if((t=(0,g.m9)(t))instanceof gc)return t._internalPath;if("string"==typeof t)return Gc(e,t);throw zc("Field path arguments must be of type string or ",e,!1,void 0,n)}var jc=new RegExp("[~\\*/\\[\\]]");function Gc(e,t,n){if(t.search(jc)>=0)throw zc("Invalid field path (".concat(t,"). Paths must not contain '~', '*', '/', '[', or ']'"),e,!1,void 0,n);try{return(0,r.Z)(gc,(0,l.Z)(t.split(".")))._internalPath}catch(i){throw zc("Invalid field path (".concat(t,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"),e,!1,void 0,n)}}function zc(e,t,n,r,i){var a=r&&!r.isEmpty(),u=void 0!==i,o="Function ".concat(t,"() called with invalid data");n&&(o+=" (via `toFirestore()`)"),o+=". ";var s="";return(a||u)&&(s+=" (found",a&&(s+=" in field ".concat(r)),u&&(s+=" in document ".concat(i)),s+=")"),new P(O.INVALID_ARGUMENT,o+e+s)}function Qc(e,t){return e.some((function(e){return e.isEqual(t)}))}var Wc=function(){function e(t,n,r,i,a){(0,f.Z)(this,e),this._firestore=t,this._userDataWriter=n,this._key=r,this._document=i,this._converter=a}return(0,h.Z)(e,[{key:"id",get:function(){return this._key.path.lastSegment()}},{key:"ref",get:function(){return new Qs(this._firestore,this._converter,this._key)}},{key:"exists",value:function(){return null!==this._document}},{key:"data",value:function(){if(this._document){if(this._converter){var e=new Hc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}},{key:"get",value:function(e){if(this._document){var t=this._document.data.field(Yc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}]),e}(),Hc=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"data",value:function(){return(0,i.Z)((0,c.Z)(n.prototype),"data",this).call(this)}}]),n}(Wc);function Yc(e,t){return"string"==typeof t?Gc(e,t):t instanceof gc?t._internalPath:t._delegate._internalPath}var Jc=function(){function e(t,n){(0,f.Z)(this,e),this.hasPendingWrites=t,this.fromCache=n}return(0,h.Z)(e,[{key:"isEqual",value:function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}]),e}(),Xc=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i,a,u,o){var s;return(0,f.Z)(this,n),(s=t.call(this,e,r,i,a,o))._firestore=e,s._firestoreImpl=e,s.metadata=u,s}return(0,h.Z)(n,[{key:"exists",value:function(){return(0,i.Z)((0,c.Z)(n.prototype),"exists",this).call(this)}},{key:"data",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._document){if(this._converter){var t=new $c(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}},{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._document){var n=this._document.data.field(Yc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}]),n}(Wc),$c=function(e){(0,o.Z)(n,e);var t=x(n);function n(){return(0,f.Z)(this,n),t.apply(this,arguments)}return(0,h.Z)(n,[{key:"data",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,i.Z)((0,c.Z)(n.prototype),"data",this).call(this,e)}}]),n}(Xc),el=function(){function e(t,n,r,i){(0,f.Z)(this,e),this._firestore=t,this._userDataWriter=n,this._snapshot=i,this.metadata=new Jc(i.hasPendingWrites,i.fromCache),this.query=r}return(0,h.Z)(e,[{key:"docs",get:function(){var e=[];return this.forEach((function(t){return e.push(t)})),e}},{key:"size",get:function(){return this._snapshot.docs.size}},{key:"empty",get:function(){return 0===this.size}},{key:"forEach",value:function(e,t){var n=this;this._snapshot.docs.forEach((function(r){e.call(t,new $c(n._firestore,n._userDataWriter,r.key,r,new Jc(n._snapshot.mutatedKeys.has(r.key),n._snapshot.fromCache),n.query.converter))}))}},{key:"docChanges",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new P(O.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){var n=0;return e._snapshot.docChanges.map((function(t){return{type:"added",doc:new $c(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Jc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:n++}}))}var r=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((function(e){return t||3!==e.type})).map((function(t){var n=new $c(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Jc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,a=-1;return 0!==t.type&&(i=r.indexOf(t.doc.key),r=r.delete(t.doc.key)),1!==t.type&&(a=(r=r.add(t.doc)).indexOf(t.doc.key)),{type:tl(t.type),doc:n,oldIndex:i,newIndex:a}}))}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}]),e}();function tl(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return R()}}function nl(e,t){return e instanceof Xc&&t instanceof Xc?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof el&&t instanceof el&&e._firestore===t._firestore&&ec(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function rl(e){if(lt(e)&&0===e.explicitOrderBy.length)throw new P(O.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var il=(0,h.Z)((function e(){(0,f.Z)(this,e)}));function al(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var i=0,a=n;i<a.length;i++){var u=a[i];e=u._apply(e)}return e}var ul=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this)).zc=e,a.Hc=r,a.Jc=i,a.type="where",a}return(0,h.Z)(n,[{key:"_apply",value:function(e){var t=_c(e.firestore),n=function(e,t,n,r,i,a,u){var o;if(i.isKeyField()){if("array-contains"===a||"array-contains-any"===a)throw new P(O.INVALID_ARGUMENT,"Invalid Query. You can't perform '".concat(a,"' queries on documentId()."));if("in"===a||"not-in"===a){bl(u,a);var s,c=[],l=w(u);try{for(l.s();!(s=l.n()).done;){var f=s.value;c.push(wl(r,e,f))}}catch(d){l.e(d)}finally{l.f()}o={arrayValue:{values:c}}}else o=wl(r,e,u)}else"in"!==a&&"not-in"!==a&&"array-contains-any"!==a||bl(u,a),o=Pc(n,"where",u,"in"===a||"not-in"===a);var h=Ge.create(i,a,o);return function(e,t){if(t.V()){var n=ht(e);if(null!==n&&!n.isEqual(t.field))throw new P(O.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '".concat(n.toString(),"' and '").concat(t.field.toString(),"'"));var r=ft(e);null!==r&&xl(e,t.field,r)}var i=function(e,t){var n,r=w(e.filters);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(t.indexOf(i.op)>=0)return i.op}}catch(d){r.e(d)}finally{r.f()}return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==i)throw i===t.op?new P(O.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '".concat(t.op.toString(),"' filter.")):new P(O.INVALID_ARGUMENT,"Invalid query. You cannot use '".concat(t.op.toString(),"' filters with '").concat(i.toString(),"' filters."))}(e,h),h}(e._query,0,t,e.firestore._databaseId,this.zc,this.Hc,this.Jc);return new Ws(e.firestore,e.converter,function(e,t){var n=e.filters.concat([t]);return new ut(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}]),n}(il);function ol(e,t,n){var r=t,i=Yc("where",e);return new ul(i,r,n)}var sl=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this)).zc=e,i.Yc=r,i.type="orderBy",i}return(0,h.Z)(n,[{key:"_apply",value:function(e){var t=function(e,t,n){if(null!==e.startAt)throw new P(O.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new P(O.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r=new nt(t,n);return function(e,t){if(null===ft(e)){var n=ht(e);null!==n&&xl(e,n,t.field)}}(e,r),r}(e._query,this.zc,this.Yc);return new Ws(e.firestore,e.converter,function(e,t){var n=e.explicitOrderBy.concat([t]);return new ut(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}]),n}(il);function cl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc",n=t,r=Yc("orderBy",e);return new sl(r,n)}var ll=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this)).type=e,a.Xc=r,a.Zc=i,a}return(0,h.Z)(n,[{key:"_apply",value:function(e){return new Ws(e.firestore,e.converter,pt(e._query,this.Xc,this.Zc))}}]),n}(il);function fl(e){return Ks("limit",e),new ll("limit",e,"F")}function hl(e){return Ks("limitToLast",e),new ll("limitToLast",e,"L")}var dl=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this)).type=e,a.ta=r,a.ea=i,a}return(0,h.Z)(n,[{key:"_apply",value:function(e){var t=kl(e,this.type,this.ta,this.ea);return new Ws(e.firestore,e.converter,function(e,t){return new ut(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}]),n}(il);function vl(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new dl("startAt",t,!0)}function yl(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new dl("startAfter",t,!1)}var pl=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r,i){var a;return(0,f.Z)(this,n),(a=t.call(this)).type=e,a.ta=r,a.ea=i,a}return(0,h.Z)(n,[{key:"_apply",value:function(e){var t=kl(e,this.type,this.ta,this.ea);return new Ws(e.firestore,e.converter,function(e,t){return new ut(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}]),n}(il);function ml(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new pl("endBefore",t,!0)}function gl(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new pl("endAt",t,!1)}function kl(e,t,n,r){if(n[0]=(0,g.m9)(n[0]),n[0]instanceof Wc)return function(e,t,n,r,i){if(!r)throw new P(O.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for ".concat(n,"()."));var a,u=[],o=w(vt(e));try{for(o.s();!(a=o.n()).done;){var s=a.value;if(s.field.isKeyField())u.push(De(t,r.key));else{var c=r.data.field(s.field);if(pe(c))throw new P(O.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+s.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===c){var l=s.field.canonicalString();throw new P(O.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '".concat(l,"' (used as the orderBy) does not exist."))}u.push(c)}}}catch(f){o.e(f)}finally{o.f()}return new et(u,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=_c(e.firestore);return function(e,t,n,r,i,a){var u=e.explicitOrderBy;if(i.length>u.length)throw new P(O.INVALID_ARGUMENT,"Too many arguments provided to ".concat(r,"(). The number of arguments must be less than or equal to the number of orderBy() clauses"));for(var o=[],s=0;s<i.length;s++){var c=i[s];if(u[s].field.isKeyField()){if("string"!=typeof c)throw new P(O.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in ".concat(r,"(), but got a ").concat(typeof c));if(!dt(e)&&-1!==c.indexOf("/"))throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by documentId(), the value passed to ".concat(r,"() must be a plain document ID, but '").concat(c,"' contains a slash."));var l=e.path.child(ue.fromString(c));if(!xe.isDocumentKey(l))throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by documentId(), the value passed to ".concat(r,"() must result in a valid document path, but '").concat(l,"' is not because it contains an odd number of segments."));var f=new xe(l);o.push(De(t,f))}else{var h=Pc(n,r,c);o.push(h)}}return new et(o,a)}(e._query,e.firestore._databaseId,i,t,n,r)}function wl(e,t,n){if("string"==typeof(n=(0,g.m9)(n))){if(""===n)throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!dt(t)&&-1!==n.indexOf("/"))throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '".concat(n,"' contains a '/' character."));var r=t.path.child(ue.fromString(n));if(!xe.isDocumentKey(r))throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '".concat(r,"' is not because it has an odd number of segments (").concat(r.length,")."));return De(e,new xe(r))}if(n instanceof Qs)return De(e,n._key);throw new P(O.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ".concat(Us(n),"."))}function bl(e,t){if(!Array.isArray(e)||0===e.length)throw new P(O.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '".concat(t.toString(),"' filters."));if(e.length>10)throw new P(O.INVALID_ARGUMENT,"Invalid Query. '".concat(t.toString(),"' filters support a maximum of 10 elements in the value array."))}function xl(e,t,n){if(!n.isEqual(t))throw new P(O.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '".concat(t.toString(),"' and so you must also use '").concat(t.toString(),"' as your first argument to orderBy(), but your first orderBy() is on field '").concat(n.toString(),"' instead."))}var Il=function(){function e(){(0,f.Z)(this,e)}return(0,h.Z)(e,[{key:"convertValue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";switch(Ie(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ve(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ye(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw R()}}},{key:"convertObject",value:function(e,t){var n=this,r={};return re(e.fields,(function(e,i){r[e]=n.convertValue(i,t)})),r}},{key:"convertGeoPoint",value:function(e){return new bc(ve(e.latitude),ve(e.longitude))}},{key:"convertArray",value:function(e,t){var n=this;return(e.values||[]).map((function(e){return n.convertValue(e,t)}))}},{key:"convertServerTimestamp",value:function(e,t){switch(t){case"previous":var n=me(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(ge(e));default:return null}}},{key:"convertTimestamp",value:function(e){var t=de(e);return new ee(t.seconds,t.nanos)}},{key:"convertDocumentKey",value:function(e,t){var n=ue.fromString(e);L(lr(n));var r=new Ms(n.get(1),n.get(3)),i=new xe(n.popFirst(5));return r.isEqual(t)||D("Document ".concat(i," contains a document reference within a different database (").concat(r.projectId,"/").concat(r.database,") which is not supported. It will be treated as a reference in the current database (").concat(t.projectId,"/").concat(t.database,") instead.")),i}}]),e}();function Tl(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}var El=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).firestore=e,r}return(0,h.Z)(n,[{key:"convertBytes",value:function(e){return new kc(e)}},{key:"convertReference",value:function(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Qs(this.firestore,null,t)}}]),n}(Il),Sl=function(){function e(t,n){(0,f.Z)(this,e),this._firestore=t,this._commitHandler=n,this._mutations=[],this._committed=!1,this._dataReader=_c(t)}return(0,h.Z)(e,[{key:"set",value:function(e,t,n){this._verifyNotCommitted();var r=Al(e,this._firestore),i=Tl(r.converter,t,n),a=Nc(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(a.toMutation(r._key,qt.none())),this}},{key:"update",value:function(e,t,n){this._verifyNotCommitted();for(var r,i=Al(e,this._firestore),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return r="string"==typeof(t=(0,g.m9)(t))||t instanceof gc?Oc(this._dataReader,"WriteBatch.update",i._key,t,n,u):Fc(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(r.toMutation(i._key,qt.exists(!0))),this}},{key:"delete",value:function(e){this._verifyNotCommitted();var t=Al(e,this._firestore);return this._mutations=this._mutations.concat(new tn(t._key,qt.none())),this}},{key:"commit",value:function(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}},{key:"_verifyNotCommitted",value:function(){if(this._committed)throw new P(O.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}]),e}();function Al(e,t){if((e=(0,g.m9)(e)).firestore!==t)throw new P(O.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}function _l(e){e=Bs(e,Qs);var t=Bs(e.firestore,ac);return Cs(uc(t),e._key).then((function(n){return Bl(t,e,n)}))}var Nl=function(e){(0,o.Z)(n,e);var t=x(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this)).firestore=e,r}return(0,h.Z)(n,[{key:"convertBytes",value:function(e){return new kc(e)}},{key:"convertReference",value:function(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Qs(this.firestore,null,t)}}]),n}(Il);function Dl(e){e=Bs(e,Qs);var t=Bs(e.firestore,ac),n=uc(t),r=new Nl(t);return function(e,t){var n=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function r(){return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=function(){var e=(0,u.Z)(v().mark((function e(t,n,r){var i,a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,function(e,t){var n=F(e);return n.persistence.runTransaction("read document","readonly",(function(e){return n.Wn.Rn(e,t)}))}(t,n);case 3:(i=e.sent).isFoundDocument()?r.resolve(i):i.isNoDocument()?r.resolve(null):r.reject(new P(O.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a=Uu(e.t0,"Failed to get document '".concat(n," from cache")),r.reject(a);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n,r){return e.apply(this,arguments)}}(),r.next=3,As(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(n,e._key).then((function(n){return new Xc(t,r,e._key,n,new Jc(null!==n&&n.hasLocalMutations,!0),e.converter)}))}function Zl(e){e=Bs(e,Qs);var t=Bs(e.firestore,ac);return Cs(uc(t),e._key,{source:"server"}).then((function(n){return Bl(t,e,n)}))}function Cl(e){e=Bs(e,Ws);var t=Bs(e.firestore,ac),n=uc(t),r=new Nl(t);return rl(e._query),Rs(n,e._query).then((function(n){return new el(t,r,e,n)}))}function Rl(e){e=Bs(e,Ws);var t=Bs(e.firestore,ac),n=uc(t),r=new Nl(t);return function(e,t){var n=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function r(){return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=function(){var e=(0,u.Z)(v().mark((function e(t,n,r){var i,a,u,o,s;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fa(t,n,!0);case 3:i=e.sent,a=new oo(n,i.zn),u=a.Po(i.documents),o=a.applyChanges(u,!1),r.resolve(o.snapshot),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),s=Uu(e.t0,"Failed to execute query '".concat(n," against cache")),r.reject(s);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n,r){return e.apply(this,arguments)}}(),r.next=3,As(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(n,e._query).then((function(n){return new el(t,r,e,n)}))}function Ll(e){e=Bs(e,Ws);var t=Bs(e.firestore,ac),n=uc(t),r=new Nl(t);return Rs(n,e._query,{source:"server"}).then((function(n){return new el(t,r,e,n)}))}function Ml(e,t,n){e=Bs(e,Qs);var r=Bs(e.firestore,ac),i=Tl(e.converter,t,n);return Ul(r,[Nc(_c(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,qt.none())])}function Fl(e,t,n){e=Bs(e,Qs);for(var r=Bs(e.firestore,ac),i=_c(r),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return Ul(r,[("string"==typeof(t=(0,g.m9)(t))||t instanceof gc?Oc(i,"updateDoc",e._key,t,n,u):Fc(i,"updateDoc",e._key,t)).toMutation(e._key,qt.exists(!0))])}function Ol(e){return Ul(Bs(e.firestore,ac),[new tn(e._key,qt.none())])}function Pl(e,t){var n=Bs(e.firestore,ac),r=Xs(e),i=Tl(e.converter,t);return Ul(n,[Nc(_c(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,qt.exists(!1))]).then((function(){return r}))}function Vl(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i,a,o;e=(0,g.m9)(e);var s={includeMetadataChanges:!1},c=0;"object"!=typeof n[c]||nc(n[c])||(s=n[c],c++);var l,f,h,d={includeMetadataChanges:s.includeMetadataChanges};if(nc(n[c])){var y=n[c];n[c]=null===(i=y.next)||void 0===i?void 0:i.bind(y),n[c+1]=null===(a=y.error)||void 0===a?void 0:a.bind(y),n[c+2]=null===(o=y.complete)||void 0===o?void 0:o.bind(y)}if(e instanceof Qs)f=Bs(e.firestore,ac),h=st(e._key.path),l={next:function(t){n[c]&&n[c](Bl(f,e,t))},error:n[c+1],complete:n[c+2]};else{var p=Bs(e,Ws);f=Bs(p.firestore,ac),h=p._query;var m=new Nl(f);l={next:function(e){n[c]&&n[c](new el(f,m,p,e))},error:n[c+1],complete:n[c+2]},rl(e._query)}return function(e,t,n,r){var i=new ds(r),a=new eo(t,i,n);return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Qu,t.next=3,Ds(e);case 3:return t.t1=t.sent,t.t2=a,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)})))),function(){i.nc(),e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Hu,t.next=3,Ds(e);case 3:return t.t1=t.sent,t.t2=a,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)}))))}}(uc(f),h,d,l)}function ql(e,t){return function(e,t){var n=new ds(t);return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=function(e,t){F(e).io.add(t),t.next()},t.next=3,Ds(e);case 3:return t.t1=t.sent,t.t2=n,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)})))),function(){n.nc(),e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=function(e,t){F(e).io.delete(t)},t.next=3,Ds(e);case 3:return t.t1=t.sent,t.t2=n,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)}))))}}(uc(e=Bs(e,ac)),nc(t)?t:{next:t})}function Ul(e,t){return function(e,t){var n=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function r(){return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=go,r.next=3,Ns(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(uc(e),t)}function Bl(e,t,n){var r=n.docs.get(t._key),i=new Nl(e);return new Xc(e,i,t._key,r,new Jc(n.hasPendingWrites,n.fromCache),t.converter)}var Kl=function(e){(0,o.Z)(n,e);var t=x(n);function n(e,r){var i;return(0,f.Z)(this,n),(i=t.call(this,e,r))._firestore=e,i}return(0,h.Z)(n,[{key:"get",value:function(e){var t=this,r=Al(e,this._firestore),a=new Nl(this._firestore);return(0,i.Z)((0,c.Z)(n.prototype),"get",this).call(this,e).then((function(e){return new Xc(t._firestore,a,r._key,e._document,new Jc(!1,!1),r.converter)}))}}]),n}(function(){function e(t,n){(0,f.Z)(this,e),this._firestore=t,this._transaction=n,this._dataReader=_c(t)}return(0,h.Z)(e,[{key:"get",value:function(e){var t=this,n=Al(e,this._firestore),r=new El(this._firestore);return this._transaction.lookup([n._key]).then((function(e){if(!e||1!==e.length)return R();var i=e[0];if(i.isFoundDocument())return new Wc(t._firestore,r,i.key,i,n.converter);if(i.isNoDocument())return new Wc(t._firestore,r,n._key,null,n.converter);throw R()}))}},{key:"set",value:function(e,t,n){var r=Al(e,this._firestore),i=Tl(r.converter,t,n),a=Nc(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,a),this}},{key:"update",value:function(e,t,n){for(var r,i=Al(e,this._firestore),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return r="string"==typeof(t=(0,g.m9)(t))||t instanceof gc?Oc(this._dataReader,"Transaction.update",i._key,t,n,u):Fc(this._dataReader,"Transaction.update",i._key,t),this._transaction.update(i._key,r),this}},{key:"delete",value:function(e){var t=Al(e,this._firestore);return this._transaction.delete(t._key),this}}]),e}());function jl(e,t){return function(e,t){var n=new V;return e.asyncQueue.enqueueAndForget((0,u.Z)(v().mark((function r(){var i;return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,function(e){return Ts(e).then((function(e){return e.datastore}))}(e);case 2:i=r.sent,new ps(e.asyncQueue,i,t,n).run();case 4:case"end":return r.stop()}}),r)})))),n.promise}(uc(e=Bs(e,ac)),(function(n){return t(new Kl(e,n))}))}function Gl(){return new Dc("deleteField")}function zl(){return new Cc("serverTimestamp")}function Ql(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new Rc("arrayUnion",t)}function Wl(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new Lc("arrayRemove",t)}function Hl(e){return new Mc("increment",e)}!function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!function(e){E=e}(y.SDK_VERSION),(0,y._registerComponent)(new p.wA("firestore",(function(e,n){var r=n.options,i=e.getProvider("app").getImmediate(),a=new ac(i,new K(e.getProvider("auth-internal")),new Q(e.getProvider("app-check-internal")));return r=Object.assign({useFetchStreams:t},r),a._setSettings(r),a}),"PUBLIC")),(0,y.registerVersion)(I,"3.4.3",e),(0,y.registerVersion)(I,"3.4.3","esm2017")}()}}]);
//# sourceMappingURL=7112840a-55063939c7bdea8a73d6.js.map